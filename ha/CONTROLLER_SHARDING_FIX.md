# Controller Sharding Fix - –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

## üéØ **–ü—Ä–æ–±–ª–µ–º–∞**
ArgoCD Application Controllers –∏–º–µ–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å sharding:
- Controller-1 –Ω–µ –º–æ–≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å sharding
- –û—à–∏–±–∫–∏ —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º `server.secretkey`
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `ARGOCD_CONTROLLER_SHARD`

## üîß **–†–µ—à–µ–Ω–∏–µ**

### **1. –ò—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```yaml
env:
  - name: ARGOCD_CONTROLLER_REPLICAS
    value: "2"
  - name: ARGOCD_CONTROLLER_SHARD
    valueFrom:
      fieldRef:
        fieldPath: metadata.name  # ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–º—è –ø–æ–¥–∞
```

**–ü—Ä–æ–±–ª–µ–º–∞**: ArgoCD –æ–∂–∏–¥–∞–ª —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è shard ID, –∞ –ø–æ–ª—É—á–∞–ª –∏–º—è –ø–æ–¥–∞ (`argocd-application-controller-0`).

### **2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```yaml
env:
  - name: ARGOCD_CONTROLLER_REPLICAS
    value: "2"
# ‚úÖ –£–±—Ä–∞–ª–∏ ARGOCD_CONTROLLER_SHARD - ArgoCD –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç shards
```

### **3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ sharding:**
```yaml
configs:
  params:
    # –ê–ª–≥–æ—Ä–∏—Ç–º sharding –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
    controller.sharding.algorithm: consistent-hashing
```

## ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**

### **–õ–æ–≥–∏ Controller-0:**
```
time="2025-07-09T15:51:46Z" level=info msg="Cluster https://kubernetes.default.svc has been assigned to shard 0"
```

### **–õ–æ–≥–∏ Controller-1:**
```
time="2025-07-09T15:51:25Z" level=info msg="Cluster https://kubernetes.default.svc has been assigned to shard 0"
```

### **–°—Ç–∞—Ç—É—Å –ø–æ–¥–æ–≤:**
```
argocd-application-controller-0    1/1 Running  ‚úÖ
argocd-application-controller-1    1/1 Running  ‚úÖ
```

## üìä **–û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã sharding**

### **–ü–æ—á–µ–º—É –æ–±–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –Ω–∞ shard 0?**
–í —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É –Ω–∞—Å –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ **–æ–¥–∏–Ω –∫–ª–∞—Å—Ç–µ—Ä** (`https://kubernetes.default.svc`), –ø–æ—ç—Ç–æ–º—É:

1. **Consistent hashing** –∞–ª–≥–æ—Ä–∏—Ç–º –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –∫–ª–∞—Å—Ç–µ—Ä –Ω–∞ shard 0
2. **–û–±–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞** –∑–Ω–∞—é—Ç –æ–± —ç—Ç–æ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏
3. **–¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä** –∞–∫—Ç–∏–≤–Ω–æ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∞—Å—Ç–µ—Ä–æ–º (leader election)
4. **–í—Ç–æ—Ä–æ–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä** –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ standby —Ä–µ–∂–∏–º–µ –¥–ª—è failover

### **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç HA:**
- **Leader Election**: –û–¥–∏–Ω –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ª–∏–¥–µ—Ä–æ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ shard
- **Automatic Failover**: –ü—Ä–∏ –æ—Ç–∫–∞–∑–µ –ª–∏–¥–µ—Ä–∞, –≤—Ç–æ—Ä–æ–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–µ—Ä–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- **Load Distribution**: –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –æ–Ω–∏ –±—É–¥—É—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –º–µ–∂–¥—É shards

## üöÄ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**

### **‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. **–ù–µ—Ç –æ—à–∏–±–æ–∫ sharding** –≤ –ª–æ–≥–∞—Ö
2. **–û–±–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω—ã** –∏ –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ
3. **Leader election** —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. **Failover –≥–æ—Ç–æ–≤** –∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—é

### **üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:**
–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤:
```bash
# –ö–ª–∞—Å—Ç–µ—Ä 1 ‚Üí shard 0 (controller-0)
# –ö–ª–∞—Å—Ç–µ—Ä 2 ‚Üí shard 1 (controller-1)  
# –ö–ª–∞—Å—Ç–µ—Ä 3 ‚Üí shard 0 (controller-0)
# –ò —Ç–∞–∫ –¥–∞–ª–µ–µ...
```

## üß™ **–¢–µ—Å—Ç –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤**

### **–°–∏–º—É–ª—è—Ü–∏—è –æ—Ç–∫–∞–∑–∞:**
```bash
kubectl delete pod argocd-application-controller-0 -n argocd
```

### **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
1. Controller-1 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–µ—Ä–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
2. –ù–æ–≤—ã–π Controller-0 —Å–æ–∑–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ ~30 —Å–µ–∫—É–Ω–¥
3. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è –±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π

## üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞**

### **1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ sharding:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è shards
kubectl logs argocd-application-controller-0 -n argocd | grep shard

# –ü—Ä–æ–≤–µ—Ä–∫–∞ leader election
kubectl logs argocd-application-controller-0 -n argocd | grep leader
```

### **2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤:**
–ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –≤–Ω–µ—à–Ω–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –∫ ArgoCD:
- –ö–ª–∞—Å—Ç–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—Å—è –º–µ–∂–¥—É shards
- Load balancing –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ö–∞–∂–¥—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –±—É–¥–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞–º–∏

### **3. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤:**
```yaml
controller:
  replicas: 3  # –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–ª—è –±–æ–ª—å—à–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
  env:
    - name: ARGOCD_CONTROLLER_REPLICAS
      value: "3"
```

## üéâ **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**

**–ü—Ä–æ–±–ª–µ–º–∞ —Å Controller sharding –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞:**

‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è  
‚úÖ **–£–±—Ä–∞–Ω—ã –æ—à–∏–±–∫–∏** –∏–∑ –ª–æ–≥–æ–≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤  
‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç leader election** –º–µ–∂–¥—É –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º–∏  
‚úÖ **–ì–æ—Ç–æ–≤ automatic failover** –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞  
‚úÖ **–ù–∞—Å—Ç—Ä–æ–µ–Ω consistent hashing** –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤  

**ArgoCD —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–º HA —Ä–µ–∂–∏–º–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º sharding!**

## üìã **–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏**

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤
kubectl get pods -n argocd | grep controller

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ sharding
kubectl logs argocd-application-controller-0 -n argocd | grep shard
kubectl logs argocd-application-controller-1 -n argocd | grep shard

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
kubectl get applications -n argocd

# –¢–µ—Å—Ç failover
kubectl delete pod argocd-application-controller-0 -n argocd
