# 59. Immutable ConfigMaps –∏ Secrets

## üéØ **Immutable ConfigMaps –∏ Secrets**

**Immutable ConfigMaps –∏ Secrets** - —ç—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è Kubernetes, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ —Å–µ–∫—Ä–µ—Ç—ã. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–∫–∏–µ —Ä–µ—Å—É—Ä—Å—ã –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω—ã, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å –≤ production –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö.

## üèóÔ∏è **–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ immutable —Ä–µ—Å—É—Ä—Å–æ–≤:**

### **1. –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π**
### **2. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
### **3. –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**
### **4. –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**
### **5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤ production**

## üìä **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –≤–∞—à–µ–≥–æ HA –∫–ª–∞—Å—Ç–µ—Ä–∞:**

### **1. –°–æ–∑–¥–∞–Ω–∏–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å—Ä–µ–¥—ã:**
```bash
# –°–æ–∑–¥–∞—Ç—å namespace –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ immutable —Ä–µ—Å—É—Ä—Å–æ–≤
kubectl create namespace immutable-demo

# –°–æ–∑–¥–∞—Ç—å –æ–±—ã—á–Ω—ã–π (mutable) ConfigMap –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
kubectl create configmap mutable-config \
  --from-literal=app.name="HashFoundry Application" \
  --from-literal=app.version="1.0.0" \
  --from-literal=app.environment="development" \
  --from-literal=database.host="postgres-dev.hashfoundry.local" \
  --from-literal=feature.flags="feature1=true,feature2=false" \
  -n immutable-demo

# –î–æ–±–∞–≤–∏—Ç—å labels –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
kubectl label configmap mutable-config \
  config.type=mutable \
  app.kubernetes.io/name=hashfoundry-app \
  -n immutable-demo

# –°–æ–∑–¥–∞—Ç—å –æ–±—ã—á–Ω—ã–π (mutable) Secret –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
kubectl create secret generic mutable-secret \
  --from-literal=database.username="dev_user" \
  --from-literal=database.password="dev_password_123" \
  --from-literal=api.key="dev_api_key_456" \
  -n immutable-demo

kubectl label secret mutable-secret \
  config.type=mutable \
  app.kubernetes.io/name=hashfoundry-app \
  -n immutable-demo

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
kubectl get configmaps,secrets -n immutable-demo --show-labels
```

### **2. –°–æ–∑–¥–∞–Ω–∏–µ immutable ConfigMaps:**
```bash
# –°–æ–∑–¥–∞—Ç—å immutable ConfigMap
cat << EOF | kubectl apply -f -
apiVersion: v1
kind: ConfigMap
metadata:
  name: immutable-config-v1
  namespace: immutable-demo
  labels:
    config.type: immutable
    app.kubernetes.io/name: hashfoundry-app
    app.kubernetes.io/version: 1.0.0
    config.hashfoundry.io/version: v1
  annotations:
    config.hashfoundry.io/description: "Immutable configuration for production deployment"
    config.hashfoundry.io/created-by: "DevOps Team"
    config.hashfoundry.io/git-commit: "abc123def456"
    config.hashfoundry.io/release-date: "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
immutable: true
data:
  app.name: "HashFoundry Production"
  app.version: "1.0.0"
  app.environment: "production"
  database.host: "postgres-prod-cluster.hashfoundry.local"
  database.port: "5432"
  database.ssl: "true"
  database.pool.min: "5"
  database.pool.max: "20"
  cache.enabled: "true"
  cache.ttl: "3600"
  cache.host: "redis-cluster.hashfoundry.local"
  cache.port: "6379"
  monitoring.enabled: "true"
  monitoring.endpoint: "/metrics"
  monitoring.port: "9090"
  security.level: "high"
  security.encryption: "aes256"
  backup.enabled: "true"
  backup.schedule: "0 2 * * *"
  feature.flags: "feature1=true,feature2=true,feature3=false,feature4=true"
  log.level: "INFO"
  log.format: "json"
  config.checksum: "sha256:abc123def456ghi789jkl012"
EOF

# –°–æ–∑–¥–∞—Ç—å –µ—â–µ –æ–¥–Ω—É –≤–µ—Ä—Å–∏—é immutable ConfigMap
cat << EOF | kubectl apply -f -
apiVersion: v1
kind: ConfigMap
metadata:
  name: immutable-config-v2
  namespace: immutable-demo
  labels:
    config.type: immutable
    app.kubernetes.io/name: hashfoundry-app
    app.kubernetes.io/version: 2.0.0
    config.hashfoundry.io/version: v2
    config.hashfoundry.io/previous-version: v1
  annotations:
    config.hashfoundry.io/description: "Updated immutable configuration with enhanced features"
    config.hashfoundry.io/changelog: "Added new features, updated cache settings"
    config.hashfoundry.io/created-by: "DevOps Team"
    config.hashfoundry.io/git-commit: "def456ghi789"
    config.hashfoundry.io/release-date: "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
immutable: true
data:
  app.name: "HashFoundry Production"
  app.version: "2.0.0"  # –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
  app.environment: "production"
  database.host: "postgres-prod-cluster.hashfoundry.local"
  database.port: "5432"
  database.ssl: "true"
  database.pool.min: "10"  # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –º–∏–Ω–∏–º—É–º
  database.pool.max: "50"  # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –º–∞–∫—Å–∏–º—É–º
  cache.enabled: "true"
  cache.ttl: "7200"  # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π TTL
  cache.host: "redis-cluster.hashfoundry.local"
  cache.port: "6379"
  cache.cluster.enabled: "true"  # –ù–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
  monitoring.enabled: "true"
  monitoring.endpoint: "/metrics"
  monitoring.port: "9090"
  monitoring.detailed: "true"  # –ù–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
  security.level: "high"
  security.encryption: "aes256"
  security.mfa.enabled: "true"  # –ù–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
  backup.enabled: "true"
  backup.schedule: "0 1,13 * * *"  # –î–≤–∞ —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å
  backup.retention: "30d"  # –ù–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
  feature.flags: "feature1=true,feature2=true,feature3=true,feature4=true,feature5=true"  # –ù–æ–≤—ã–µ —Ñ–ª–∞–≥–∏
  log.level: "INFO"
  log.format: "json"
  log.structured: "true"  # –ù–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
  config.checksum: "sha256:def456ghi789jkl012mno345"
EOF

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å immutable ConfigMaps
kubectl get configmaps -n immutable-demo -l config.type=immutable
kubectl describe configmap immutable-config-v1 -n immutable-demo
```

### **3. –°–æ–∑–¥–∞–Ω–∏–µ immutable Secrets:**
```bash
# –°–æ–∑–¥–∞—Ç—å immutable Secret
cat << EOF | kubectl apply -f -
apiVersion: v1
kind: Secret
metadata:
  name: immutable-secret-v1
  namespace: immutable-demo
  labels:
    config.type: immutable
    app.kubernetes.io/name: hashfoundry-app
    app.kubernetes.io/version: 1.0.0
    config.hashfoundry.io/version: v1
  annotations:
    config.hashfoundry.io/description: "Immutable secrets for production environment"
    config.hashfoundry.io/created-by: "Security Team"
    config.hashfoundry.io/git-commit: "abc123def456"
    config.hashfoundry.io/security-level: "high"
type: Opaque
immutable: true
data:
  database.username: cHJvZF91c2Vy  # prod_user
  database.password: cHJvZF9wYXNzd29yZF9zZWN1cmVfMTIz  # prod_password_secure_123
  database.admin.username: YWRtaW5fdXNlcg==  # admin_user
  database.admin.password: YWRtaW5fcGFzc3dvcmRfc3VwZXJfc2VjdXJlXzQ1Ng==  # admin_password_super_secure_456
  api.key: cHJvZF9hcGlfa2V5X3NlY3VyZV83ODk=  # prod_api_key_secure_789
  api.secret: cHJvZF9hcGlfc2VjcmV0X3NlY3VyZV9hYmM=  # prod_api_secret_secure_abc
  jwt.secret: cHJvZF9qd3Rfc2VjcmV0X3NlY3VyZV9kZWY=  # prod_jwt_secret_secure_def
  jwt.private.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0t  # -----BEGIN PRIVATE KEY-----
  encryption.key: cHJvZF9lbmNyeXB0aW9uX2tleV9zZWN1cmVfZ2hp  # prod_encryption_key_secure_ghi
  oauth.client.id: cHJvZF9vYXV0aF9jbGllbnRfaWRfamts  # prod_oauth_client_id_jkl
  oauth.client.secret: cHJvZF9vYXV0aF9jbGllbnRfc2VjcmV0X21ubw==  # prod_oauth_client_secret_mno
  monitoring.token: cHJvZF9tb25pdG9yaW5nX3Rva2VuX3Bxcg==  # prod_monitoring_token_pqr
EOF

# –°–æ–∑–¥–∞—Ç—å immutable TLS Secret
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout /tmp/tls.key \
  -out /tmp/tls.crt \
  -subj "/C=AE/ST=Dubai/L=Dubai/O=HashFoundry/OU=IT/CN=hashfoundry.local"

cat << EOF | kubectl apply -f -
apiVersion: v1
kind: Secret
metadata:
  name: immutable-tls-secret-v1
  namespace: immutable-demo
  labels:
    config.type: immutable
    app.kubernetes.io/name: hashfoundry-app
    config.hashfoundry.io/version: v1
    config.hashfoundry.io/cert-type: tls
  annotations:
    config.hashfoundry.io/description: "Immutable TLS certificates for production"
    config.hashfoundry.io/created-by: "Security Team"
    config.hashfoundry.io/expires: "$(date -d '+365 days' -u +%Y-%m-%dT%H:%M:%SZ)"
type: kubernetes.io/tls
immutable: true
data:
  tls.crt: $(base64 -w 0 /tmp/tls.crt)
  tls.key: $(base64 -w 0 /tmp/tls.key)
EOF

# –û—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
rm -f /tmp/tls.key /tmp/tls.crt

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å immutable Secrets
kubectl get secrets -n immutable-demo -l config.type=immutable
kubectl describe secret immutable-secret-v1 -n immutable-demo
```

### **4. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∑–∞—â–∏—Ç—ã –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
```bash
# –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è immutability
cat << 'EOF' > test-immutability.sh
#!/bin/bash

NAMESPACE="immutable-demo"

echo "=== Testing Immutability Protection ==="
echo

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è mutable —Ä–µ—Å—É—Ä—Å–∞
test_mutable_changes() {
    echo "=== Testing Mutable ConfigMap Changes ==="
    
    # –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    current_value=$(kubectl get configmap mutable-config -n $NAMESPACE -o jsonpath='{.data.app\.version}')
    echo "Current app.version in mutable-config: $current_value"
    
    # –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∏–∑–º–µ–Ω–∏—Ç—å
    echo "Attempting to change app.version to 2.0.0..."
    if kubectl patch configmap mutable-config -n $NAMESPACE --type merge -p='{"data":{"app.version":"2.0.0"}}'; then
        echo "‚úì Mutable ConfigMap successfully updated"
        new_value=$(kubectl get configmap mutable-config -n $NAMESPACE -o jsonpath='{.data.app\.version}')
        echo "New app.version: $new_value"
    else
        echo "‚úó Failed to update mutable ConfigMap"
    fi
    echo
    
    # –í–µ—Ä–Ω—É—Ç—å –æ–±—Ä–∞—Ç–Ω–æ
    kubectl patch configmap mutable-config -n $NAMESPACE --type merge -p='{"data":{"app.version":"1.0.0"}}'
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è immutable —Ä–µ—Å—É—Ä—Å–∞
test_immutable_changes() {
    echo "=== Testing Immutable ConfigMap Changes ==="
    
    # –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    current_value=$(kubectl get configmap immutable-config-v1 -n $NAMESPACE -o jsonpath='{.data.app\.version}')
    echo "Current app.version in immutable-config-v1: $current_value"
    
    # –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∏–∑–º–µ–Ω–∏—Ç—å
    echo "Attempting to change app.version to 2.0.0..."
    if kubectl patch configmap immutable-config-v1 -n $NAMESPACE --type merge -p='{"data":{"app.version":"2.0.0"}}' 2>/dev/null; then
        echo "‚úó Immutable ConfigMap was unexpectedly updated!"
    else
        echo "‚úì Immutable ConfigMap correctly protected from changes"
    fi
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–ª—é—á–µ–π
test_immutable_key_addition() {
    echo "=== Testing Immutable ConfigMap Key Addition ==="
    
    # –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á
    echo "Attempting to add new key 'new.feature=enabled'..."
    if kubectl patch configmap immutable-config-v1 -n $NAMESPACE --type merge -p='{"data":{"new.feature":"enabled"}}' 2>/dev/null; then
        echo "‚úó Immutable ConfigMap was unexpectedly updated!"
    else
        echo "‚úì Immutable ConfigMap correctly protected from key additions"
    fi
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è immutable Secret
test_immutable_secret_changes() {
    echo "=== Testing Immutable Secret Changes ==="
    
    # –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∏–∑–º–µ–Ω–∏—Ç—å Secret
    echo "Attempting to change api.key..."
    if kubectl patch secret immutable-secret-v1 -n $NAMESPACE --type merge -p='{"data":{"api.key":"'$(echo -n "new_api_key" | base64)'"}}' 2>/dev/null; then
        echo "‚úó Immutable Secret was unexpectedly updated!"
    else
        echo "‚úì Immutable Secret correctly protected from changes"
    fi
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è labels –∏ annotations
test_immutable_metadata_changes() {
    echo "=== Testing Immutable Resource Metadata Changes ==="
    
    # –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∏–∑–º–µ–Ω–∏—Ç—å label
    echo "Attempting to add new label..."
    if kubectl label configmap immutable-config-v1 -n $NAMESPACE new.label=test 2>/dev/null; then
        echo "‚úì Labels can be modified on immutable ConfigMaps"
        # –£–¥–∞–ª–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π label
        kubectl label configmap immutable-config-v1 -n $NAMESPACE new.label- 2>/dev/null
    else
        echo "‚úó Failed to modify labels"
    fi
    
    # –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∏–∑–º–µ–Ω–∏—Ç—å annotation
    echo "Attempting to add new annotation..."
    if kubectl annotate configmap immutable-config-v1 -n $NAMESPACE new.annotation=test 2>/dev/null; then
        echo "‚úì Annotations can be modified on immutable ConfigMaps"
        # –£–¥–∞–ª–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—É—é annotation
        kubectl annotate configmap immutable-config-v1 -n $NAMESPACE new.annotation- 2>/dev/null
    else
        echo "‚úó Failed to modify annotations"
    fi
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–ø–æ—Å–æ–±–∞ "–∏–∑–º–µ–Ω–µ–Ω–∏—è" immutable —Ä–µ—Å—É—Ä—Å–æ–≤
test_immutable_versioning() {
    echo "=== Demonstrating Proper Immutable Resource Updates ==="
    
    echo "To 'update' an immutable resource, you must create a new version:"
    echo "1. Current immutable-config-v1 has app.version: $(kubectl get configmap immutable-config-v1 -n $NAMESPACE -o jsonpath='{.data.app\.version}')"
    echo "2. immutable-config-v2 has app.version: $(kubectl get configmap immutable-config-v2 -n $NAMESPACE -o jsonpath='{.data.app\.version}')"
    echo "3. Applications should reference the specific version they need"
    echo
}

# –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
test_mutable_changes
test_immutable_changes
test_immutable_key_addition
test_immutable_secret_changes
test_immutable_metadata_changes
test_immutable_versioning

echo "=== Immutability Test Summary ==="
echo "‚úì Immutable resources are protected from data changes"
echo "‚úì Metadata (labels/annotations) can still be modified"
echo "‚úì New versions must be created for updates"
echo "‚úì This ensures configuration stability and consistency"

EOF

chmod +x test-immutability.sh
./test-immutability.sh
```

### **5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ immutable —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö:**
```bash
# –°–æ–∑–¥–∞—Ç—å Deployment, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π immutable –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cat << EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: immutable-app-v1
  namespace: immutable-demo
  labels:
    app: hashfoundry-app
    version: v1
    config.type: immutable
spec:
  replicas: 3
  selector:
    matchLabels:
      app: hashfoundry-app
      version: v1
  template:
    metadata:
      labels:
        app: hashfoundry-app
        version: v1
      annotations:
        config.hashfoundry.io/config-version: v1
        config.hashfoundry.io/secret-version: v1
        config.hashfoundry.io/immutable: "true"
    spec:
      containers:
      - name: app
        image: nginx:1.21
        ports:
        - containerPort: 80
        env:
        # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ immutable ConfigMap v2
        - name: APP_NAME
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v2
              key: app.name
        - name: APP_VERSION
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v2
              key: app.version
        - name: APP_ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v2
              key: app.environment
        - name: DATABASE_HOST
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v2
              key: database.host
        - name: CACHE_ENABLED
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v2
              key: cache.enabled
        - name: CACHE_CLUSTER_ENABLED
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v2
              key: cache.cluster.enabled
        - name: MONITORING_ENABLED
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v2
              key: monitoring.enabled
        - name: MONITORING_DETAILED
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v2
              key: monitoring.detailed
        - name: SECURITY_LEVEL
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v2
              key: security.level
        - name: SECURITY_MFA_ENABLED
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v2
              key: security.mfa.enabled
        # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ immutable Secret (—Ç–∞ –∂–µ –≤–µ—Ä—Å–∏—è)
        - name: DATABASE_USERNAME
          valueFrom:
            secretKeyRef:
              name: immutable-secret-v1
              key: database.username
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: immutable-secret-v1
              key: database.password
        - name: API_KEY
          valueFrom:
            secretKeyRef:
              name: immutable-secret-v1
              key: api.key
        volumeMounts:
        # –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ immutable ConfigMap v2
        - name: config-volume
          mountPath: /etc/app-config
          readOnly: true
        # –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ immutable Secret v1
        - name: secret-volume
          mountPath: /etc/app-secrets
          readOnly: true
        command: ["sh", "-c"]
        args:
        - |
          cat > /usr/share/nginx/html/index.html << 'HTML_EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>HashFoundry V2 - Enhanced Immutable Configuration</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; background: #f8f9fa; }
                  .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  .header { background: #28a745; color: white; padding: 20px; border-radius: 5px; margin-bottom: 30px; }
                  .section { background: #e9ecef; padding: 20px; border-radius: 5px; margin: 20px 0; }
                  .v2-badge { background: #28a745; color: white; padding: 5px 10px; border-radius: 3px; font-size: 12px; font-weight: bold; }
                  .immutable-badge { background: #dc3545; color: white; padding: 5px 10px; border-radius: 3px; font-size: 12px; font-weight: bold; }
                  .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
                  .config-item { background: white; padding: 15px; border-radius: 5px; border-left: 4px solid #28a745; }
                  .enhanced-item { background: white; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üöÄ HashFoundry V2 - Enhanced Immutable Configuration</h1>
                      <p>Demonstrating version 2.0 with enhanced features</p>
                      <span class="v2-badge">VERSION 2.0</span>
                      <span class="immutable-badge">IMMUTABLE</span>
                  </div>
                  
                  <div class="section">
                      <h2>üìã Enhanced Application Information</h2>
                      <div class="config-grid">
                          <div class="config-item">
                              <strong>App Name:</strong> $APP_NAME
                          </div>
                          <div class="config-item">
                              <strong>Version:</strong> $APP_VERSION
                          </div>
                          <div class="config-item">
                              <strong>Environment:</strong> $APP_ENVIRONMENT
                          </div>
                          <div class="config-item">
                              <strong>Pod:</strong> $(hostname)
                          </div>
                          <div class="config-item">
                              <strong>Database Host:</strong> $DATABASE_HOST
                          </div>
                          <div class="config-item">
                              <strong>Cache Enabled:</strong> $CACHE_ENABLED
                          </div>
                          <div class="enhanced-item">
                              <strong>Cache Cluster:</strong> $CACHE_CLUSTER_ENABLED (NEW)
                          </div>
                          <div class="config-item">
                              <strong>Monitoring:</strong> $MONITORING_ENABLED
                          </div>
                          <div class="enhanced-item">
                              <strong>Detailed Monitoring:</strong> $MONITORING_DETAILED (NEW)
                          </div>
                          <div class="config-item">
                              <strong>Security Level:</strong> $SECURITY_LEVEL
                          </div>
                          <div class="enhanced-item">
                              <strong>MFA Enabled:</strong> $SECURITY_MFA_ENABLED (NEW)
                          </div>
                      </div>
                  </div>
                  
                  <div class="section">
                      <h2>üÜï New Features in V2</h2>
                      <div class="config-grid">
                          <div class="enhanced-item">
                              <strong>Cache TTL:</strong> $(cat /etc/app-config/cache.ttl 2>/dev/null || echo 'N/A') seconds
                          </div>
                          <div class="enhanced-item">
                              <strong>Backup Schedule:</strong> $(cat /etc/app-config/backup.schedule 2>/dev/null || echo 'N/A')
                          </div>
                          <div class="enhanced-item">
                              <strong>Backup Retention:</strong> $(cat /etc/app-config/backup.retention 2>/dev/null || echo 'N/A')
                          </div>
                          <div class="enhanced-item">
                              <strong>Structured Logging:</strong> $(cat /etc/app-config/log.structured 2>/dev/null || echo 'N/A')
                          </div>
                      </div>
                  </div>
                  
                  <div class="section">
                      <p><strong>Configuration Version:</strong> V2 (Immutable)</p>
                      <p><strong>Secret Version:</strong> V1 (Immutable)</p>
                      <p><strong>Last Updated:</strong> $(date)</p>
                  </div>
              </div>
          </body>
          </html>
          HTML_EOF
          
          nginx -g 'daemon off;'
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      # Immutable ConfigMap v2 volume
      - name: config-volume
        configMap:
          name: immutable-config-v2
      # Immutable Secret v1 volume (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—É –∂–µ –≤–µ—Ä—Å–∏—é)
      - name: secret-volume
        secret:
          secretName: immutable-secret-v1
          defaultMode: 0600
EOF

# –°–æ–∑–¥–∞—Ç—å Services –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
cat << EOF | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: immutable-app-v1-service
  namespace: immutable-demo
  labels:
    app: hashfoundry-app
    version: v1
spec:
  selector:
    app: hashfoundry-app
    version: v1
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: immutable-app-v2-service
  namespace: immutable-demo
  labels:
    app: hashfoundry-app
    version: v2
spec:
  selector:
    app: hashfoundry-app
    version: v2
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
EOF

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
kubectl get deployments,pods,services -n immutable-demo
```

### **6. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ immutable —Ä–µ—Å—É—Ä—Å–æ–≤:**
```bash
# –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
cat << 'EOF' > analyze-immutable-performance.sh
#!/bin/bash

NAMESPACE="immutable-demo"

echo "=== Immutable Resources Performance Analysis ==="
echo

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
analyze_resource_usage() {
    echo "=== Resource Usage Analysis ==="
    
    echo "ConfigMaps in namespace:"
    kubectl get configmaps -n $NAMESPACE -o custom-columns="NAME:.metadata.name,TYPE:.metadata.labels.config\.type,SIZE:.metadata.annotations.kubectl\.kubernetes\.io/last-applied-configuration" | head -10
    echo
    
    echo "Secrets in namespace:"
    kubectl get secrets -n $NAMESPACE -o custom-columns="NAME:.metadata.name,TYPE:.metadata.labels.config\.type,AGE:.metadata.creationTimestamp" | head -10
    echo
    
    echo "Pod resource usage:"
    kubectl top pods -n $NAMESPACE 2>/dev/null || echo "Metrics server not available"
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç—É–ø–∞
test_access_performance() {
    echo "=== Access Performance Test ==="
    
    # –ü–æ–ª—É—á–∏—Ç—å –∏–º—è Pod'–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    POD_NAME=$(kubectl get pods -n $NAMESPACE -l app=hashfoundry-app,version=v1 -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
    
    if [ -n "$POD_NAME" ]; then
        echo "Testing access performance on pod: $POD_NAME"
        
        # –¢–µ—Å—Ç —á—Ç–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        echo "Environment variable access time:"
        time kubectl exec $POD_NAME -n $NAMESPACE -- sh -c 'echo $APP_NAME $APP_VERSION $APP_ENVIRONMENT' >/dev/null
        
        # –¢–µ—Å—Ç —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –∏–∑ ConfigMap
        echo "ConfigMap file access time:"
        time kubectl exec $POD_NAME -n $NAMESPACE -- sh -c 'cat /etc/app-config/app.name /etc/app-config/app.version' >/dev/null
        
        # –¢–µ—Å—Ç —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –∏–∑ Secret
        echo "Secret file access time:"
        time kubectl exec $POD_NAME -n $NAMESPACE -- sh -c 'cat /etc/app-secrets/database.username' >/dev/null
        
    else
        echo "No pods found for testing"
    fi
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
analyze_caching_benefits() {
    echo "=== Caching Benefits Analysis ==="
    
    echo "Immutable resources provide several caching benefits:"
    echo "1. kubelet can cache ConfigMap/Secret data more aggressively"
    echo "2. No need to watch for changes, reducing API server load"
    echo "3. Container runtime can optimize volume mounts"
    echo "4. Reduced memory usage in kubelet"
    echo
    
    # –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏—è, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å immutable —Ä–µ—Å—É—Ä—Å–∞–º–∏
    echo "Recent events for immutable resources:"
    kubectl get events -n $NAMESPACE --field-selector reason=Created,reason=Pulled | grep -E "(immutable|ConfigMap|Secret)" | tail -5
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å mutable —Ä–µ—Å—É—Ä—Å–∞–º–∏
compare_with_mutable() {
    echo "=== Comparison with Mutable Resources ==="
    
    echo "Mutable ConfigMaps:"
    kubectl get configmaps -n $NAMESPACE -l config.type=mutable -o custom-columns="NAME:.metadata.name,IMMUTABLE:.immutable,AGE:.metadata.creationTimestamp"
    echo
    
    echo "Immutable ConfigMaps:"
    kubectl get configmaps -n $NAMESPACE -l config.type=immutable -o custom-columns="NAME:.metadata.name,IMMUTABLE:.immutable,AGE:.metadata.creationTimestamp"
    echo
    
    echo "Key differences:"
    echo "‚úì Immutable: Better performance, no change watching needed"
    echo "‚úì Immutable: Guaranteed consistency, no accidental modifications"
    echo "‚úì Immutable: Reduced API server load"
    echo "‚úó Immutable: Requires new resource creation for updates"
    echo "‚úó Immutable: More resources to manage over time"
    echo
}

# –í—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑
analyze_resource_usage
test_access_performance
analyze_caching_benefits
compare_with_mutable

echo "=== Performance Analysis Summary ==="
echo "‚úì Immutable resources provide better caching"
echo "‚úì Reduced API server load due to no change watching"
echo "‚úì More predictable performance characteristics"
echo "‚úì Better suited for production environments"

EOF

chmod +x analyze-immutable-performance.sh
./analyze-immutable-performance.sh
```

## üßπ **–û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤:**
```bash
# –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
cat << 'EOF' > cleanup-immutable-demo.sh
#!/bin/bash

NAMESPACE="immutable-demo"

echo "=== Cleaning up Immutable Resources Demo ==="
echo

# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ Deployments –∏ Services
echo "Deleting deployments and services..."
kubectl delete deployments,services --all -n $NAMESPACE

# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ Pod'—ã
echo "Deleting pods..."
kubectl delete pods --all -n $NAMESPACE

# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ ConfigMaps (–≤–∫–ª—é—á–∞—è immutable)
echo "Deleting ConfigMaps..."
kubectl delete configmaps --all -n $NAMESPACE

# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ Secrets (–≤–∫–ª—é—á–∞—è immutable)
echo "Deleting Secrets..."
kubectl delete secrets --all -n $NAMESPACE

# –£–¥–∞–ª–∏—Ç—å namespace
echo "Deleting namespace..."
kubectl delete namespace $NAMESPACE

# –£–¥–∞–ª–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
echo "Cleaning up local files..."
rm -f test-immutability.sh
rm -f analyze-immutable-performance.sh

echo "‚úì Cleanup completed"

EOF

chmod +x cleanup-immutable-demo.sh
./cleanup-immutable-demo.sh
```

## üìã **–°–≤–æ–¥–∫–∞ immutable —Ä–µ—Å—É—Ä—Å–æ–≤:**

### **–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ immutable ConfigMap
kubectl apply -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: my-immutable-config
immutable: true
data:
  key: value
EOF

# –°–æ–∑–¥–∞–Ω–∏–µ immutable Secret
kubectl apply -f - <<EOF
apiVersion: v1
kind: Secret
metadata:
  name: my-immutable-secret
type: Opaque
immutable: true
data:
  key: $(echo -n "value" | base64)
EOF

# –ü—Ä–æ–≤–µ—Ä–∫–∞ immutable —Å—Ç–∞—Ç—É—Å–∞
kubectl get configmap my-immutable-config -o jsonpath='{.immutable}'
kubectl get secret my-immutable-secret -o jsonpath='{.immutable}'
```

## üìä **–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ mutable vs immutable:**

| **–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞** | **Mutable** | **Immutable** |
|-------------------|-------------|---------------|
| **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** | ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ | ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è | ‚ö° –£–ª—É—á—à–µ–Ω–Ω–∞—è |
| **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ | üöÄ –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ |
| **API Server –Ω–∞–≥—Ä—É–∑–∫–∞** | –í—ã—Å–æ–∫–∞—è | üìâ –ù–∏–∑–∫–∞—è |
| **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ | üîÑ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ |
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** | –°—Ä–µ–¥–Ω—è—è | üîí –í—ã—Å–æ–∫–∞—è |
| **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** | –ü—Ä–æ—Å—Ç–æ–µ | üìã –¢—Ä–µ–±—É–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è |

## üéØ **Best Practices –¥–ª—è immutable —Ä–µ—Å—É—Ä—Å–æ–≤:**

### **1. –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å immutable:**
- **Production –æ–∫—Ä—É–∂–µ–Ω–∏—è** –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–¥–∫–æ –º–µ–Ω—è—é—Ç—Å—è**
- **–°–µ–∫—Ä–µ—Ç—ã —Å –≤—ã—Å–æ–∫–∏–º —É—Ä–æ–≤–Ω–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**
- **–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏ –∫–ª—é—á–∏**

### **2. –°—Ç—Ä–∞—Ç–µ–≥–∏—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:**
- **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤ –∏–º–µ–Ω–∞—Ö
- **–í–∫–ª—é—á–∞–π—Ç–µ –≤–µ—Ä—Å–∏—é –≤ labels** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
- **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** –≤ annotations
- **–ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –æ—á–∏—Å—Ç–∫–∏** —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π

### **3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º:**
- **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–π—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ** –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏–π
- **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ GitOps** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏—è–º–∏
- **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** —Ä–µ—Å—É—Ä—Å–æ–≤
- **–†–µ–∞–ª–∏–∑—É–π—Ç–µ cleanup –ø–æ–ª–∏—Ç–∏–∫–∏**

### **4. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- **–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Ç–µ –ø—Ä–∞–≤–∞** –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ immutable —Ä–µ—Å—É—Ä—Å–æ–≤
- **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ RBAC** –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞
- **–ê—É–¥–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** –≤–µ—Ä—Å–∏–π
- **–®–∏—Ñ—Ä—É–π—Ç–µ sensitive –¥–∞–Ω–Ω—ã–µ**

**Immutable ConfigMaps –∏ Secrets –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ production Kubernetes –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö!**
        config.hashfoundry.io/immutable: "true"
    spec:
      containers:
      - name: app
        image: nginx:1.21
        ports:
        - containerPort: 80
        env:
        # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ immutable ConfigMap
        - name: APP_NAME
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v1
              key: app.name
        - name: APP_VERSION
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v1
              key: app.version
        - name: APP_ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v1
              key: app.environment
        - name: DATABASE_HOST
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v1
              key: database.host
        - name: CACHE_ENABLED
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v1
              key: cache.enabled
        - name: MONITORING_ENABLED
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v1
              key: monitoring.enabled
        - name: SECURITY_LEVEL
          valueFrom:
            configMapKeyRef:
              name: immutable-config-v1
              key: security.level
        # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ immutable Secret
        - name: DATABASE_USERNAME
          valueFrom:
            secretKeyRef:
              name: immutable-secret-v1
              key: database.username
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: immutable-secret-v1
              key: database.password
        - name: API_KEY
          valueFrom:
            secretKeyRef:
              name: immutable-secret-v1
              key: api.key
        volumeMounts:
        # –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ immutable ConfigMap
        - name: config-volume
          mountPath: /etc/app-config
          readOnly: true
        # –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ immutable Secret
        - name: secret-volume
          mountPath: /etc/app-secrets
          readOnly: true
        # –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
        - name: tls-volume
          mountPath: /etc/tls
          readOnly: true
        command: ["sh", "-c"]
        args:
        - |
          # –°–æ–∑–¥–∞—Ç—å HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
          cat > /usr/share/nginx/html/index.html << 'HTML_EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>HashFoundry - Immutable Configuration Demo</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                  .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  .header { background: #2c3e50; color: white; padding: 20px; border-radius: 5px; margin-bottom: 30px; }
                  .section { background: #ecf0f1; padding: 20px; border-radius: 5px; margin: 20px 0; }
                  .immutable-badge { background: #e74c3c; color: white; padding: 5px 10px; border-radius: 3px; font-size: 12px; font-weight: bold; }
                  .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
                  .config-item { background: white; padding: 15px; border-radius: 5px; border-left: 4px solid #3498db; }
                  .secret-item { background: white; padding: 15px; border-radius: 5px; border-left: 4px solid #e74c3c; }
                  .file-list { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; font-family: monospace; }
                  pre { background: #34495e; color: #ecf0f1; padding: 10px; border-radius: 3px; overflow-x: auto; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üîí HashFoundry Immutable Configuration Demo</h1>
                      <p>Demonstrating immutable ConfigMaps and Secrets in Kubernetes</p>
                      <span class="immutable-badge">IMMUTABLE</span>
                  </div>
                  
                  <div class="section">
                      <h2>üìã Application Information</h2>
                      <div class="config-grid">
                          <div class="config-item">
                              <strong>App Name:</strong> $APP_NAME
                          </div>
                          <div class="config-item">
                              <strong>Version:</strong> $APP_VERSION
                          </div>
                          <div class="config-item">
                              <strong>Environment:</strong> $APP_ENVIRONMENT
                          </div>
                          <div class="config-item">
                              <strong>Pod:</strong> $(hostname)
                          </div>
                          <div class="config-item">
                              <strong>Database Host:</strong> $DATABASE_HOST
                          </div>
                          <div class="config-item">
                              <strong>Cache Enabled:</strong> $CACHE_ENABLED
                          </div>
                          <div class="config-item">
                              <strong>Monitoring:</strong> $MONITORING_ENABLED
                          </div>
                          <div class="config-item">
                              <strong>Security Level:</strong> $SECURITY_LEVEL
                          </div>
                      </div>
                  </div>
                  
                  <div class="section">
                      <h2>üîß Configuration Files (Immutable ConfigMap)</h2>
                      <div class="file-list">
                          <strong>Files in /etc/app-config:</strong>
                          <pre>$(ls -la /etc/app-config/ 2>/dev/null || echo 'No config files found')</pre>
                      </div>
                      <div class="config-grid">
                          $(for file in /etc/app-config/*; do
                              if [ -f "$file" ]; then
                                  filename=$(basename "$file")
                                  content=$(head -c 100 "$file" 2>/dev/null || echo "Cannot read file")
                                  echo "<div class=\"config-item\"><strong>$filename:</strong><br><code>$content</code></div>"
                              fi
                          done)
                      </div>
                  </div>
                  
                  <div class="section">
                      <h2>üîê Secret Information (Immutable Secret)</h2>
                      <div class="file-list">
                          <strong>Secret files in /etc/app-secrets:</strong>
                          <pre>$(ls -la /etc/app-secrets/ 2>/dev/null || echo 'No secret files found')</pre>
                      </div>
                      <div class="config-grid">
                          <div class="secret-item">
                              <strong>Database User:</strong> $DATABASE_USERNAME
                          </div>
                          <div class="secret-item">
                              <strong>Database Password:</strong> [HIDDEN - Length: $(echo -n "$DATABASE_PASSWORD" | wc -c) chars]
                          </div>
                          <div class="secret-item">
                              <strong>API Key:</strong> [HIDDEN - Length: $(echo -n "$API_KEY" | wc -c) chars]
                          </div>
                          <div class="secret-item">
                              <strong>Secret Files Count:</strong> $(ls /etc/app-secrets/ 2>/dev/null | wc -l)
                          </div>
                      </div>
                  </div>
                  
                  <div class="section">
                      <h2>üîí TLS Certificates (Immutable TLS Secret)</h2>
                      <div class="file-list">
                          <strong>TLS files in /etc/tls:</strong>
                          <pre>$(ls -la /etc/tls/ 2>/dev/null || echo 'No TLS files found')</pre>
                      </div>
                      <div class="config-grid">
                          <div class="config-item">
                              <strong>Certificate Info:</strong><br>
                              <pre>$(openssl x509 -in /etc/tls/tls.crt -text -noout 2>/dev/null | head -10 || echo 'Certificate not available')</pre>
                          </div>
                      </div>
                  </div>
                  
                  <div class="section">
                      <h2>‚ÑπÔ∏è Immutable Resources Benefits</h2>
                      <div class="config-grid">
                          <div class="config-item">
                              <strong>üõ°Ô∏è Protection:</strong> Cannot be accidentally modified
                          </div>
                          <div class="config-item">
                              <strong>‚ö° Performance:</strong> Better caching and optimization
                          </div>
                          <div class="config-item">
                              <strong>üîÑ Consistency:</strong> Guaranteed configuration stability
                          </div>
                          <div class="config-item">
                              <strong>üì¶ Versioning:</strong> Forces proper version management
                          </div>
                      </div>
                  </div>
                  
                  <div class="section">
                      <p><strong>Last Updated:</strong> $(date)</p>
                      <p><em>This configuration is immutable and cannot be changed. To update, create a new version.</em></p>
                  </div>
              </div>
          </body>
          </html>
          HTML_EOF
          
          # –ó–∞–ø—É—Å—Ç–∏—Ç—å nginx
          nginx -g 'daemon off;'
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      # Immutable ConfigMap volume
      - name: config-volume
        configMap:
          name: immutable-config-v1
      # Immutable Secret volume
      - name: secret-volume
        secret:
          secretName: immutable-secret-v1
          defaultMode: 0600
      # Immutable TLS Secret volume
      - name: tls-volume
        secret:
          secretName: immutable-tls-secret-v1
          defaultMode: 0644
          items:
          - key: tls.crt
            path: tls.crt
            mode: 0644
          - key: tls.key
            path: tls.key
            mode: 0600
EOF

# –°–æ–∑–¥–∞—Ç—å Deployment –¥–ª—è –≤–µ—Ä—Å–∏–∏ v2
cat << EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: immutable-app-v2
  namespace: immutable-demo
  labels:
    app: hashfoundry-app
    version: v2
    config.type: immutable
spec:
  replicas: 2
  selector:
    matchLabels:
      app: hashfoundry-app
      version: v2
  template:
    metadata:
      labels:
        app: hashfoundry-app
        version: v2
      annotations:
        config.hashfoundry.io/config-version: v2
        config.hashfoundry.io/secret-version: v1
