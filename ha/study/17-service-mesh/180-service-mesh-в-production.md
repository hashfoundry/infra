# 180. Service mesh –≤ production

## üéØ **–ß—Ç–æ —Ç–∞–∫–æ–µ service mesh –≤ production?**

**Service mesh –≤ production** - —ç—Ç–æ enterprise-grade —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º, comprehensive –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º, security hardening –∏ disaster recovery –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º–∏ —á–µ—Ä–µ–∑ –ø–æ—ç—Ç–∞–ø–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é, canary deployments, SLI/SLO –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ runbooks –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

## üèóÔ∏è **–û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è production:**

### **1. High Availability**
- Multi-zone control plane deployment
- Automatic failover mechanisms
- Circuit breakers –∏ retry policies
- Load balancing strategies

### **2. Performance & Scalability**
- P99 latency < 100ms overhead
- Support 10k+ RPS per service
- Horizontal auto-scaling
- Resource optimization

### **3. Security & Compliance**
- mTLS everywhere
- Zero-trust policies
- Audit logging
- Compliance standards (SOC 2, GDPR)

### **4. Observability**
- Golden signals monitoring
- SLI/SLO tracking
- End-to-end tracing
- Comprehensive alerting

## üìä **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –≤–∞—à–µ–≥–æ HA –∫–ª–∞—Å—Ç–µ—Ä–∞:**

### **1. Production-ready Istio deployment:**
```bash
#!/bin/bash
# deploy-production-istio.sh

echo "üöÄ Production Istio Deployment"

# –°–æ–∑–¥–∞–Ω–∏–µ production IstioOperator
kubectl apply -f - << EOF
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: production
  namespace: istio-system
spec:
  values:
    global:
      meshID: hashfoundry-production-mesh
      cluster: hashfoundry-production
      network: production-network
      proxy:
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 2000m
            memory: 1Gi
    pilot:
      env:
        PILOT_ENABLE_WORKLOAD_ENTRY_AUTOREGISTRATION: true
        PILOT_ENABLE_CROSS_CLUSTER_WORKLOAD_ENTRY: true
        PILOT_TRACE_SAMPLING: 1.0
        PILOT_ENABLE_STATUS: true
    telemetryV2:
      enabled: true
      prometheus:
        configOverride:
          metric_relabeling_configs:
          - source_labels: [__name__]
            regex: 'istio_.*'
            target_label: __tmp_istio_metric
          - source_labels: [__tmp_istio_metric]
            regex: '.*'
            target_label: __name__
            replacement: '${1}'
  components:
    pilot:
      k8s:
        resources:
          requests:
            cpu: 500m
            memory: 2Gi
          limits:
            cpu: 2000m
            memory: 4Gi
        hpaSpec:
          minReplicas: 3
          maxReplicas: 10
          metrics:
          - type: Resource
            resource:
              name: cpu
              target:
                type: Utilization
                averageUtilization: 70
          - type: Resource
            resource:
              name: memory
              target:
                type: Utilization
                averageUtilization: 80
        podDisruptionBudget:
          minAvailable: 2
        env:
          - name: PILOT_ENABLE_STATUS
            value: "true"
          - name: PILOT_ENABLE_WORKLOAD_ENTRY_AUTOREGISTRATION
            value: "true"
        nodeSelector:
          node-role: control-plane
        tolerations:
        - key: node-role
          operator: Equal
          value: control-plane
          effect: NoSchedule
    ingressGateways:
    - name: istio-ingressgateway
      enabled: true
      k8s:
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 2000m
            memory: 1Gi
        hpaSpec:
          minReplicas: 3
          maxReplicas: 10
          metrics:
          - type: Resource
            resource:
              name: cpu
              target:
                type: Utilization
                averageUtilization: 70
        podDisruptionBudget:
          minAvailable: 2
        service:
          type: LoadBalancer
          loadBalancerSourceRanges:
          - "10.0.0.0/8"
          - "172.16.0.0/12"
          - "192.168.0.0/16"
        nodeSelector:
          node-role: worker
    egressGateways:
    - name: istio-egressgateway
      enabled: true
      k8s:
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        hpaSpec:
          minReplicas: 2
          maxReplicas: 5
        podDisruptionBudget:
          minAvailable: 1
        nodeSelector:
          node-role: worker
EOF

# –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
kubectl wait --for=condition=available deployment/istiod -n istio-system --timeout=600s

echo "‚úÖ Production Istio —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç"
```

### **2. –ü–æ—ç—Ç–∞–ø–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ service mesh:**
```bash
#!/bin/bash
# production-migration.sh

echo "üöÄ Production –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ Service Mesh"

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
MIGRATION_PHASE=${1:-"phase1"}
NAMESPACE=${2:-"production"}

# Phase 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
phase1_infrastructure() {
    echo "üìã Phase 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã"
    
    # –°–æ–∑–¥–∞–Ω–∏–µ production namespace —Å labels
    kubectl create namespace $NAMESPACE --dry-run=client -o yaml | \
    kubectl apply -f -
    
    kubectl label namespace $NAMESPACE \
        environment=production \
        istio-injection=enabled \
        --overwrite
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ network policies
    kubectl apply -f - << EOF
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: istio-mesh-policy
  namespace: $NAMESPACE
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: istio-system
    - namespaceSelector:
        matchLabels:
          environment: production
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: istio-system
    - namespaceSelector:
        matchLabels:
          environment: production
  - to: []
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 443
EOF
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ default security policies
    kubectl apply -f - << EOF
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: $NAMESPACE
spec:
  mtls:
    mode: STRICT
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: default
  namespace: $NAMESPACE
spec:
  host: "*.local"
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
EOF
    
    echo "‚úÖ Phase 1 –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
}

# Phase 2: Pilot services (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ)
phase2_pilot_services() {
    echo "üß™ Phase 2: Pilot services"
    
    local pilot_services=("logging-service" "metrics-collector" "health-checker")
    
    for service in "${pilot_services[@]}"; do
        echo "–ú–∏–≥—Ä–∞—Ü–∏—è pilot —Å–µ—Ä–≤–∏—Å–∞: $service"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è deployment
        if ! kubectl get deployment $service -n $NAMESPACE >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Deployment $service –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
            continue
        fi
        
        # –°–æ–∑–¥–∞–Ω–∏–µ backup –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        kubectl get deployment $service -n $NAMESPACE -o yaml > /tmp/${service}-backup-$(date +%s).yaml
        
        # –í–∫–ª—é—á–µ–Ω–∏–µ sidecar injection
        kubectl patch deployment $service -n $NAMESPACE -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}'
        
        # –û–∂–∏–¥–∞–Ω–∏–µ rollout
        kubectl rollout status deployment/$service -n $NAMESPACE --timeout=300s
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
        local ready_replicas=$(kubectl get deployment $service -n $NAMESPACE -o jsonpath='{.status.readyReplicas}')
        local desired_replicas=$(kubectl get deployment $service -n $NAMESPACE -o jsonpath='{.spec.replicas}')
        
        if [ "$ready_replicas" = "$desired_replicas" ]; then
            echo "‚úÖ $service –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ"
        else
            echo "‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π $service"
            kubectl describe deployment $service -n $NAMESPACE
        fi
    done
    
    echo "‚úÖ Phase 2 –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
}

# Phase 3: Core services (–≤–∞–∂–Ω—ã–µ)
phase3_core_services() {
    echo "üèóÔ∏è Phase 3: Core services"
    
    local core_services=("user-service" "notification-service" "analytics-service")
    
    for service in "${core_services[@]}"; do
        echo "–ú–∏–≥—Ä–∞—Ü–∏—è core —Å–µ—Ä–≤–∏—Å–∞: $service"
        
        if ! kubectl get deployment $service -n $NAMESPACE >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Deployment $service –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
            continue
        fi
        
        # –°–æ–∑–¥–∞–Ω–∏–µ backup
        kubectl get deployment $service -n $NAMESPACE -o yaml > /tmp/${service}-backup-$(date +%s).yaml
        
        # –£–≤–µ–ª–∏—á–µ–Ω–∏–µ replicas –¥–ª—è canary
        local current_replicas=$(kubectl get deployment $service -n $NAMESPACE -o jsonpath='{.spec.replicas}')
        local canary_replicas=$((current_replicas * 2))
        
        kubectl scale deployment $service -n $NAMESPACE --replicas=$canary_replicas
        kubectl rollout status deployment/$service -n $NAMESPACE
        
        # –í–∫–ª—é—á–µ–Ω–∏–µ sidecar –¥–ª—è –Ω–æ–≤—ã—Ö pods
        kubectl patch deployment $service -n $NAMESPACE -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}'
        
        # –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        kubectl patch deployment $service -n $NAMESPACE -p '{"spec":{"strategy":{"rollingUpdate":{"maxSurge":"25%","maxUnavailable":"25%"}}}}'
        kubectl rollout status deployment/$service -n $NAMESPACE --timeout=600s
        
        # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç
        echo "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ –¥–ª—è $service..."
        for i in {1..5}; do
            sleep 60
            echo "–ú–∏–Ω—É—Ç–∞ $i: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫..."
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ error rate —á–µ—Ä–µ–∑ kubectl (–µ—Å–ª–∏ Prometheus –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
            local pod_count=$(kubectl get pods -n $NAMESPACE -l app=$service --field-selector=status.phase=Running | wc -l)
            echo "Running pods: $((pod_count - 1))"  # -1 –¥–ª—è header
        done
        
        # –í–æ–∑–≤—Ä–∞—Ç –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É replicas
        kubectl scale deployment $service -n $NAMESPACE --replicas=$current_replicas
        
        echo "‚úÖ $service –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ"
    done
    
    echo "‚úÖ Phase 3 –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
}

# Phase 4: Critical services (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ)
phase4_critical_services() {
    echo "üî• Phase 4: Critical services"
    
    local critical_services=("payment-service" "auth-service" "order-service")
    
    for service in "${critical_services[@]}"; do
        echo "–ú–∏–≥—Ä–∞—Ü–∏—è –∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞: $service"
        
        if ! kubectl get deployment $service -n $NAMESPACE >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Deployment $service –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º demo deployment"
            
            # –°–æ–∑–¥–∞–Ω–∏–µ demo deployment –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
            kubectl apply -f - << EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: $service
  namespace: $NAMESPACE
  labels:
    app: $service
    version: blue
spec:
  replicas: 3
  selector:
    matchLabels:
      app: $service
      version: blue
  template:
    metadata:
      labels:
        app: $service
        version: blue
    spec:
      containers:
      - name: $service
        image: nginx:1.21
        ports:
        - containerPort: 80
        env:
        - name: SERVICE_NAME
          value: "$service"
        - name: VERSION
          value: "blue"
---
apiVersion: v1
kind: Service
metadata:
  name: $service
  namespace: $NAMESPACE
spec:
  selector:
    app: $service
  ports:
  - port: 80
    targetPort: 80
EOF
            
            kubectl rollout status deployment/$service -n $NAMESPACE
        fi
        
        # –°–æ–∑–¥–∞–Ω–∏–µ backup
        kubectl get deployment $service -n $NAMESPACE -o yaml > /tmp/${service}-backup-$(date +%s).yaml
        
        # Blue-green deployment
        kubectl label deployment $service -n $NAMESPACE version=blue --overwrite
        
        # –°–æ–∑–¥–∞–Ω–∏–µ green version —Å sidecar
        kubectl get deployment $service -n $NAMESPACE -o yaml | \
            sed 's/version: blue/version: green/g' | \
            sed 's/name: '$service'/name: '$service'-green/g' | \
            kubectl apply -f -
        
        kubectl patch deployment ${service}-green -n $NAMESPACE -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"},"labels":{"version":"green"}}}}}'
        
        # –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ green
        kubectl rollout status deployment/${service}-green -n $NAMESPACE --timeout=600s
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ traffic splitting
        kubectl apply -f - << EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: ${service}-traffic-split
  namespace: $NAMESPACE
spec:
  hosts:
  - $service
  http:
  - match:
    - headers:
        canary:
          exact: "true"
    route:
    - destination:
        host: $service
        subset: green
  - route:
    - destination:
        host: $service
        subset: blue
      weight: 90
    - destination:
        host: $service
        subset: green
      weight: 10
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: ${service}-destination
  namespace: $NAMESPACE
spec:
  host: $service
  subsets:
  - name: blue
    labels:
      version: blue
  - name: green
    labels:
      version: green
EOF
        
        # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ç–µ—á–µ–Ω–∏–µ 10 –º–∏–Ω—É—Ç
        echo "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ $service –≤ —Ç–µ—á–µ–Ω–∏–µ 10 –º–∏–Ω—É—Ç..."
        for i in {1..10}; do
            sleep 60
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ pods
            local green_pods=$(kubectl get pods -n $NAMESPACE -l app=$service,version=green --field-selector=status.phase=Running | wc -l)
            local blue_pods=$(kubectl get pods -n $NAMESPACE -l app=$service,version=blue --field-selector=status.phase=Running | wc -l)
            
            echo "–ú–∏–Ω—É—Ç–∞ $i: Green pods: $((green_pods - 1)), Blue pods: $((blue_pods - 1))"
        done
        
        # –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ 100% green
        kubectl patch virtualservice ${service}-traffic-split -n $NAMESPACE --type='merge' -p='{"spec":{"http":[{"route":[{"destination":{"host":"'$service'","subset":"green"},"weight":100}]}]}}'
        
        # –û–∂–∏–¥–∞–Ω–∏–µ 2 –º–∏–Ω—É—Ç—ã –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
        sleep 120
        
        # –£–¥–∞–ª–µ–Ω–∏–µ blue version
        kubectl delete deployment $service -n $NAMESPACE
        
        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ green –≤ –æ—Å–Ω–æ–≤–Ω–æ–π
        kubectl patch deployment ${service}-green -n $NAMESPACE -p='{"metadata":{"name":"'$service'"}}'
        kubectl patch deployment ${service}-green -n $NAMESPACE -p='{"spec":{"template":{"metadata":{"labels":{"version":"v1"}}}}}'
        
        # –û—á–∏—Å—Ç–∫–∞ traffic splitting
        kubectl delete virtualservice ${service}-traffic-split -n $NAMESPACE
        kubectl delete destinationrule ${service}-destination -n $NAMESPACE
        
        echo "‚úÖ $service –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ service mesh"
    done
    
    echo "‚úÖ Phase 4 –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
}

# Phase 5: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
phase5_finalization() {
    echo "üéØ Phase 5: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è"
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ production telemetry
    kubectl apply -f - << EOF
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: production-telemetry
  namespace: $NAMESPACE
spec:
  metrics:
  - providers:
    - name: prometheus
  - overrides:
    - match:
        metric: ALL_METRICS
      tagOverrides:
        request_protocol:
          operation: UPSERT
          value: "%{REQUEST_PROTOCOL}"
        response_flags:
          operation: UPSERT
          value: "%{RESPONSE_FLAGS}"
  tracing:
  - providers:
    - name: jaeger
  - customTags:
      user_id:
        header:
          name: "user-id"
      request_id:
        header:
          name: "x-request-id"
      environment:
        literal:
          value: "production"
  accessLogging:
  - providers:
    - name: otel
  - format:
      text: |
        [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%"
        %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT%
        %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-FORWARDED-FOR)%"
        "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"
        environment="production"
EOF
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
    echo "=== –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ==="
    kubectl get pods -n $NAMESPACE
    kubectl get virtualservices -n $NAMESPACE
    kubectl get destinationrules -n $NAMESPACE
    kubectl get peerauthentications -n $NAMESPACE
    
    echo "‚úÖ Phase 5 –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    echo "üéâ Production –º–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
case "$MIGRATION_PHASE" in
    phase1)
        phase1_infrastructure
        ;;
    phase2)
        phase2_pilot_services
        ;;
    phase3)
        phase3_core_services
        ;;
    phase4)
        phase4_critical_services
        ;;
    phase5)
        phase5_finalization
        ;;
    all)
        phase1_infrastructure
        phase2_pilot_services
        phase3_core_services
        phase4_critical_services
        phase5_finalization
        ;;
    *)
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 {phase1|phase2|phase3|phase4|phase5|all} [namespace]"
        echo ""
        echo "Phases:"
        echo "  phase1 - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã"
        echo "  phase2 - Pilot services (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ)"
        echo "  phase3 - Core services (–≤–∞–∂–Ω—ã–µ)"
        echo "  phase4 - Critical services (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ)"
        echo "  phase5 - –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è"
        echo "  all    - –í—Å–µ —Ñ–∞–∑—ã"
        exit 1
        ;;
esac
```

### **3. Production SLI/SLO –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
```yaml
# production-slos.yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: production-slos
  namespace: istio-system
spec:
  groups:
  - name: sli-slo.rules
    interval: 30s
    rules:
    # Availability SLI
    - record: sli:availability:rate5m
      expr: |
        sum(rate(istio_requests_total{response_code!~"5.*"}[5m])) by (destination_service_name, destination_namespace)
        /
        sum(rate(istio_requests_total[5m])) by (destination_service_name, destination_namespace)
    
    # Latency SLI
    - record: sli:latency:p99:5m
      expr: |
        histogram_quantile(0.99,
          sum(rate(istio_request_duration_milliseconds_bucket[5m])) by (destination_service_name, destination_namespace, le)
        )
    
    # Latency SLI P95
    - record: sli:latency:p95:5m
      expr: |
        histogram_quantile(0.95,
          sum(rate(istio_request_duration_milliseconds_bucket[5m])) by (destination_service_name, destination_namespace, le)
        )
    
    # Throughput SLI
    - record: sli:throughput:rate5m
      expr: |
        sum(rate(istio_requests_total[5m])) by (destination_service_name, destination_namespace)
    
    # Error Budget Alerts
    - alert: SLOAvailabilityBreach
      expr: |
        (
          sli:availability:rate5m < 0.999
        ) and (
          sli:availability:rate5m > 0
        )
      for: 2m
      labels:
        severity: critical
        slo: availability
      annotations:
        summary: "Service availability SLO breach"
        description: "Service {{ $labels.destination_service_name }} availability is {{ $value | humanizePercentage }}, below 99.9% SLO"
    
    - alert: SLOLatencyBreach
      expr: |
        sli:latency:p99:5m > 100
      for: 5m
      labels:
        severity: warning
        slo: latency
      annotations:
        summary: "Service latency SLO breach"
        description: "Service {{ $labels.destination_service_name }} P99 latency is {{ $value }}ms, above 100ms SLO"
    
    # Error Budget Burn Rate
    - alert: ErrorBudgetBurnRateHigh
      expr: |
        (
          1 - sli:availability:rate5m
        ) > (
          (1 - 0.999) * 14.4  # 14.4x burn rate for 2% budget in 1 hour
        )
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "High error budget burn rate"
        description: "Service {{ $labels.destination_service_name }} is burning error budget at {{ $value | humanizePercentage }} rate"
    
    - alert: ErrorBudgetBurnRateMedium
      expr: |
        (
          1 - sli:availability:rate5m
        ) > (
          (1 - 0.999) * 6  # 6x burn rate for 5% budget in 1 hour
        )
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "Medium error budget burn rate"
        description: "Service {{ $labels.destination_service_name }} is burning error budget at {{ $value | humanizePercentage }} rate"
```

### **4. Production security hardening:**
```yaml
# production-security.yaml

# Strict mTLS –¥–ª—è –≤—Å–µ–≥–æ mesh
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: istio-system
spec:
  mtls:
    mode: STRICT
---
# Default deny-all authorization policy
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-all
  namespace: production
spec:
  {}  # Deny all by default
---
# Allow internal service communication
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-internal-services
  namespace: production
spec:
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/production/sa/*"]
  - to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE"]
  - when:
    - key: source.namespace
      values: ["production"]
---
# Allow ingress gateway
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-ingress-gateway
  namespace: production
spec:
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"]
---
# Rate limiting
apiVersion: networking.istio.io/v1beta1
kind: EnvoyFilter
metadata:
  name: rate-limit-filter
  namespace: production
spec:
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.local_ratelimit
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
          value:
            stat_prefix: rate_limiter
            token_bucket:
              max_tokens: 1000
              tokens_per_fill: 1000
              fill_interval: 60s
            filter_enabled:
              runtime_key: rate_limit_enabled
              default_value:
                numerator: 100
                denominator: HUNDRED
            filter_enforced:
              runtime_key: rate_limit_enforced
              default_value:
                numerator: 100
                denominator: HUNDRED
---
# Security scanning policy
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: security-scanning
  namespace: production
spec:
  selector:
    matchLabels:
      security-scan: "enabled"
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/security/sa/scanner"]
  - to:
    - operation:
        methods: ["GET"]
        paths: ["/health", "/metrics", "/ready"]
```

## üö® **Disaster Recovery –ø—Ä–æ—Ü–µ–¥—É—Ä—ã:**

### **1. Backup –∏ restore —Å–∫—Ä–∏–ø—Ç:**
```bash
#!/bin/bash
# disaster-recovery.sh

echo "üö® Service Mesh Disaster Recovery"

# Backup control plane
backup_control_plane() {
    echo "üíæ Backup control plane –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
    
    local backup_dir="/backup/istio-$(date +%Y%m%d-%H%M%S)"
    mkdir -p $backup_dir
    
    # Backup Istio configuration
    kubectl get istiooperator -n istio-system -o yaml > $backup_dir/istio-operator.yaml
    kubectl get configmap istio -n istio-system -o yaml > $backup_dir/istio-config.yaml
    
    # Backup certificates
    kubectl get secret cacerts -n istio-system -o yaml > $backup_dir/cacerts.yaml 2>/dev/null || echo "No custom cacerts found"
    
    # Backup custom resources
    kubectl get virtualservices --all-namespaces -o yaml > $backup_dir/virtualservices.yaml
    kubectl get destinationrules --all-namespaces -o yaml > $backup_dir/destinationrules.yaml
    kubectl get gateways --all-namespaces -o yaml > $backup_dir/gateways.yaml
    kubectl get peerauthentications --all-namespaces -o yaml > $backup_dir/peerauthentications.yaml
    kubectl get authorizationpolicies --all-namespaces -o yaml > $backup_dir/authorizationpolicies.yaml
    kubectl get serviceentries --all-namespaces -o yaml > $backup_dir/serviceentries.yaml
    kubectl get envoyfilters --all-namespaces -o yaml > $backup_dir/envoyfilters.yaml
    
    # Backup telemetry configuration
    kubectl get telemetry --all-namespaces -o yaml > $backup_dir/telemetry.yaml 2>/dev/null || echo "No telemetry resources found"
    
    # Create backup manifest
    cat > $backup_dir/backup-manifest.txt << EOF
Istio Backup Created: $(date)
Cluster: $(kubectl config current-context)
Istio Version: $(istioctl version --short 2>/dev/null || echo "Unknown")

Files included:
- istio-operator.yaml
- istio-config.yaml
- cacerts.yaml
- virtualservices.yaml
- destinationrules.yaml
- gateways.yaml
- peerauthentications.yaml
- authorizationpolicies.yaml
- serviceentries.yaml
- envoyfilters.yaml
- telemetry.yaml
EOF
    
    echo "‚úÖ Backup —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ $backup_dir"
    echo "üìã Manifest: $backup_dir/backup-manifest.txt"
}

# Restore control plane
restore_control_plane() {
    local backup_dir=$1
    
    if [ -z "$backup_dir" ] || [ ! -d "$backup_dir" ]; then
        echo "‚ùå Backup directory –Ω–µ –Ω–∞–π–¥–µ–Ω: $backup_dir"
        exit 1
    fi
    
    echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ control plane –∏–∑ $backup_dir"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ backup manifest
    if [ -f "$backup_dir/backup-manifest.txt" ]; then
        echo "üìã Backup manifest:"
        cat $backup_dir/backup-manifest.txt
        echo ""
    fi
    
    # Restore certificates first (if exists)
    if [ -f "$backup_dir/cacerts.yaml" ]; then
        echo "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ certificates..."
        kubectl apply -f $backup_dir/cacerts.yaml
    fi
    
    # Restore Istio Operator
    if [ -f "$backup_dir/istio-operator.yaml" ]; then
        echo "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ IstioOperator..."
        kubectl apply -f $backup_dir/istio-operator.yaml
        kubectl wait --for=condition=available deployment/istiod -n istio-system --timeout=600s
    fi
    
    # Restore configuration
    if [ -f "$backup_dir/istio-config.yaml" ]; then
        echo "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Istio config..."
        kubectl apply -f $backup_dir/istio-config.yaml
    fi
    
    # Restore custom resources
    echo "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ custom resources..."
    for resource in virtualservices destinationrules gateways peerauthentications authorizationpolicies serviceentries envoyfilters telemetry; do
        if [ -f "$backup_dir/${resource}.yaml" ]; then
            echo "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ $resource..."
            kubectl apply -f $backup_dir/${resource}.yaml
        fi
    done
    
    echo "‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
}

# Emergency rollback
emergency_rollback() {
    echo "üö® Emergency rollback"
    
    # Disable sidecar injection
    kubectl label namespace production istio-injection-
    
    # Remove Istio resources
    kubectl delete virtualservices --all -n production
    kubectl delete destinationrules --all -n production
    kubectl delete peerauthentications --all -n production
    kubectl delete authorizationpolicies --all -n production
    
    # Restart deployments to remove sidecars
    kubectl rollout restart deployment --all -n production
    
    echo "‚úÖ Emergency rollback –∑–∞–≤–µ—Ä—à–µ–Ω"
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
case "$1" in
    backup)
        backup_control_plane
        ;;
    restore)
        restore_control_plane $2
        ;;
    rollback)
        emergency_rollback
        ;;
    *)
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 {backup|restore|rollback} [backup_dir]"
        exit 1
        ;;
esac
```

## üìà **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ production service mesh:**

### **1. Production health checks:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ health –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
kubectl get pods -n istio-system
kubectl get pods -n production

# Proxy status
istioctl proxy-status

# Configuration analysis
istioctl analyze --all-namespaces

# Performance metrics
kubectl top pods -n istio-system --containers
kubectl top pods -n production --containers
```

### **2. SLI/SLO dashboard:**
```bash
# Port forward –∫ Grafana
kubectl port-forward svc/grafana -n monitoring 3000:80

# Key SLI metrics:
# - Availability: istio_requests_total success rate
# - Latency: istio_request_duration_milliseconds P99
# - Throughput: istio_requests_total rate
# - Error rate: istio_requests_total 5xx rate
```

## üè≠ **Production –≤ –≤–∞—à–µ–º HA –∫–ª–∞—Å—Ç–µ—Ä–µ:**

### **1. ArgoCD –≤ production mesh:**
```bash
# ArgoCD —Å production –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
kubectl get pods -n argocd -o wide
kubectl describe pod -n argocd -l app.kubernetes.io/name=argocd-server

# Production VirtualService –¥–ª—è ArgoCD
kubectl get virtualservice -n argocd
kubectl describe virtualservice argocd-server -n argocd

# mTLS –¥–ª—è ArgoCD
istioctl authn tls-check argocd-server.argocd.svc.cluster.local
```

### **2. Monitoring stack –≤ production:**
```bash
# Prometheus —Å sidecars
kubectl get pods -n monitoring -l app=prometheus-server
kubectl exec -n monitoring deployment/prometheus-server -c istio-proxy -- pilot-agent request GET stats | grep istio_requests

# Grafana —Å sidecars
kubectl get pods -n monitoring -l app.kubernetes.io/name=grafana
kubectl exec -n monitoring deployment/grafana -c istio-proxy -- pilot-agent request GET stats | grep istio_requests
```

### **3. Production traffic policies:**
```bash
# Circuit breaker –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
kubectl apply -f - << EOF
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: argocd-circuit-breaker
  namespace: argocd
spec:
  host: argocd-server
  trafficPolicy:
    outlierDetection:
      consecutiveErrors: 3
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 50
        maxRequestsPerConnection: 10
EOF

# Retry policy
kubectl apply -f - << EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: argocd-retry
  namespace: argocd
spec:
  hosts:
  - argocd-server
  http:
  - route:
    - destination:
        host: argocd-server
    retries:
      attempts: 3
      perTryTimeout: 10s
      retryOn: 5xx,gateway-error,connect-failure,refused-stream
EOF
```

## üö® **Production troubleshooting:**

### **1. Common production issues:**
```bash
# High latency
kubectl exec -n production deployment/app -c istio-proxy -- pilot-agent request GET stats | grep duration

# Certificate expiration
kubectl exec -n production deployment/app -c istio-proxy -- openssl x509 -in /var/run/secrets/workload-spiffe-credentials/cert.pem -noout -dates

# Configuration conflicts
istioctl analyze -n production

# Resource exhaustion
kubectl top pods -n istio-system --containers
kubectl describe pod -n istio-system -l app=istiod
```

### **2. Production debugging:**
```bash
# Enable debug logging
kubectl patch deployment istiod -n istio-system -p '{"spec":{"template":{"spec":{"containers":[{"name":"discovery","args":["discovery","--log_output_level=debug"]}]}}}}'

# Collect debug info
istioctl bug-report --include ns1,ns2

# Proxy debug
kubectl exec -n production deployment/app -c istio-proxy -- pilot-agent request GET config_dump > debug-config.json
```

## üéØ **Production architecture diagram:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                Production Service Mesh                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Load Balancer (DigitalOcean)                              ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ External Traffic                                      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ SSL Termination                                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Istio Ingress Gateway (HA)                                ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ 3+ replicas across zones                              ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Auto-scaling (3-10 pods)                              ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ PodDisruptionBudget                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Control Plane (istio-system)                              ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Istiod (HA: 3+ replicas)                              ‚îÇ
‚îÇ  ‚îÇ   ‚îú‚îÄ‚îÄ Service Discovery                                 ‚îÇ
‚îÇ  ‚îÇ   ‚îú‚îÄ‚îÄ Certificate Authority                             ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ‚îÄ Configuration Management                          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Monitoring Integration                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Data Plane (Production Workloads)                         ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ ArgoCD (GitOps)                                       ‚îÇ
‚îÇ  ‚îÇ   ‚îú‚îÄ‚îÄ Server pods + sidecars                            ‚îÇ
‚îÇ  ‚îÇ   ‚îú‚îÄ‚îÄ mTLS enforcement                                  ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ‚îÄ Circuit breakers                                  ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Monitoring Stack                                      ‚îÇ
‚îÇ  ‚îÇ   ‚îú‚îÄ‚îÄ Prometheus + sidecars                             ‚îÇ
‚îÇ  ‚îÇ   ‚îú‚îÄ‚îÄ Grafana + sidecars                                ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ‚îÄ SLI/SLO tracking                                  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Application Services                                  ‚îÇ
‚îÇ      ‚îú‚îÄ‚îÄ Microservices + sidecars                          ‚îÇ
‚îÇ      ‚îú‚îÄ‚îÄ Zero-trust policies                               ‚îÇ
‚îÇ      ‚îî‚îÄ‚îÄ Observability                                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Security & Compliance                                      ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ mTLS everywhere (STRICT mode)                         ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Authorization policies                                ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Rate limiting                                         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Audit logging                                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Disaster Recovery                                          ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Configuration backups                                 ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Certificate backups                                   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Emergency rollback                                    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Multi-zone deployment                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß **Production configuration:**

### **1. Resource optimization:**
```bash
# Istiod production resources
kubectl patch deployment istiod -n istio-system -p '{"spec":{"template":{"spec":{"containers":[{"name":"discovery","resources":{"requests":{"cpu":"500m","memory":"2Gi"},"limits":{"cpu":"2000m","memory":"4Gi"}}}]}}}}'

# Sidecar resource limits
kubectl apply -f - << EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: istio-sidecar-injector
  namespace: istio-system
data:
  values: |
    global:
      proxy:
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 2000m
            memory: 1Gi
EOF
```

### **2. Performance tuning:**
```bash
# Pilot performance settings
kubectl patch deployment istiod -n istio-system -p '{"spec":{"template":{"spec":{"containers":[{"name":"discovery","env":[{"name":"PILOT_PUSH_THROTTLE","value":"100"},{"name":"PILOT_DEBOUNCE_AFTER","value":"100ms"},{"name":"PILOT_DEBOUNCE_MAX","value":"10s"}]}]}}}}'

# Envoy performance
kubectl apply -f - << EOF
apiVersion: networking.istio.io/v1beta1
kind: EnvoyFilter
metadata:
  name: performance-tuning
  namespace: istio-system
spec:
  configPatches:
  - applyTo: BOOTSTRAP
    patch:
      operation: MERGE
      value:
        stats_config:
          stats_tags:
          - tag_name: "custom_tag"
            regex: "^custom_metric_(.+)$"
EOF
```

## üéØ **Best Practices –¥–ª—è production:**

### **1. Deployment:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ—ç—Ç–∞–ø–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é
- –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ canary deployments
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ proper health checks
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ SLI/SLO –º–µ—Ç—Ä–∏–∫–∏

### **2. Security:**
- –í–∫–ª—é—á–∏—Ç–µ STRICT mTLS
- –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ zero-trust policies
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ rate limiting
- –í–µ–¥–∏—Ç–µ audit logs

### **3. Operations:**
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–π—Ç–µ backup –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
- –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ emergency runbooks
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ resource usage
- –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ capacity

### **4. Monitoring:**
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ comprehensive alerting
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ golden signals
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ distributed tracing
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ error budgets

**Production service mesh —Ç—Ä–µ–±—É–µ—Ç —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏!**
