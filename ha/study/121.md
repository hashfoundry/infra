# 121. –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ Container Network Interface (CNI)

## üéØ **–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ Container Network Interface (CNI)**

**CNI (Container Network Interface)** - —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–µ–≤—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ Linux. CNI —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–æ–π —Å–µ—Ç–µ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Kubernetes –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫ pods –ø–æ–ª—É—á–∞—é—Ç IP –∞–¥—Ä–µ—Å–∞ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º.

## üåê **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ CNI:**

### **1. CNI Components:**
- **CNI Specification** - —Å—Ç–∞–Ω–¥–∞—Ä—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- **CNI Plugins** - –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **CNI Configuration** - JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ç–∏
- **Container Runtime** - –≤—ã–∑—ã–≤–∞–µ—Ç CNI plugins

### **2. CNI Operations:**
- **ADD** - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ —Å–µ—Ç—å
- **DEL** - —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–∑ —Å–µ—Ç–∏
- **CHECK** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- **VERSION** - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ plugin

### **3. CNI Plugin Types:**
- **Main Plugins** - –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ plugins
- **IPAM Plugins** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞–º–∏
- **Meta Plugins** - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

## üìä **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –≤–∞—à–µ–≥–æ HA –∫–ª–∞—Å—Ç–µ—Ä–∞:**

```bash
# –°–æ–∑–¥–∞—Ç—å comprehensive CNI analysis toolkit
cat << 'EOF' > cni-analysis-toolkit.sh
#!/bin/bash

echo "=== CNI Analysis Toolkit ==="
echo "Comprehensive guide for understanding CNI in HashFoundry HA cluster"
echo

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ CNI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
analyze_cni_configuration() {
    echo "=== CNI Configuration Analysis ==="
    
    echo "1. Check CNI configuration directory:"
    CNI_CONFIG_DIR="/etc/cni/net.d"
    if [ -d "$CNI_CONFIG_DIR" ]; then
        echo "CNI config directory exists: $CNI_CONFIG_DIR"
        ls -la "$CNI_CONFIG_DIR"
        echo
        
        echo "2. CNI configuration files:"
        for config_file in "$CNI_CONFIG_DIR"/*.conf "$CNI_CONFIG_DIR"/*.conflist; do
            if [ -f "$config_file" ]; then
                echo "--- Configuration: $(basename $config_file) ---"
                cat "$config_file" | jq . 2>/dev/null || cat "$config_file"
                echo
            fi
        done
    else
        echo "‚ùå CNI config directory not found: $CNI_CONFIG_DIR"
    fi
    
    echo "3. CNI binary directory:"
    CNI_BIN_DIR="/opt/cni/bin"
    if [ -d "$CNI_BIN_DIR" ]; then
        echo "CNI binary directory: $CNI_BIN_DIR"
        ls -la "$CNI_BIN_DIR"
        echo
        
        echo "Available CNI plugins:"
        for plugin in "$CNI_BIN_DIR"/*; do
            if [ -x "$plugin" ]; then
                PLUGIN_NAME=$(basename "$plugin")
                echo "- $PLUGIN_NAME"
                "$plugin" version 2>/dev/null | head -3 || echo "  (version info not available)"
            fi
        done
    else
        echo "‚ùå CNI binary directory not found: $CNI_BIN_DIR"
    fi
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—É—â–µ–≥–æ CNI plugin
analyze_current_cni_plugin() {
    echo "=== Current CNI Plugin Analysis ==="
    
    echo "1. Detect CNI plugin from cluster:"
    
    # Check kube-proxy configuration for CNI hints
    echo "Checking kube-proxy configuration:"
    kubectl get configmap -n kube-system kube-proxy -o yaml | grep -A 10 -B 5 "mode\|cluster" || echo "Cannot access kube-proxy config"
    echo
    
    # Check for common CNI plugins
    echo "2. Checking for common CNI plugins:"
    
    # Calico
    kubectl get pods -n kube-system | grep calico && echo "‚úÖ Calico detected" || echo "‚ùå Calico not found"
    
    # Flannel
    kubectl get pods -n kube-system | grep flannel && echo "‚úÖ Flannel detected" || echo "‚ùå Flannel not found"
    
    # Weave
    kubectl get pods -n kube-system | grep weave && echo "‚úÖ Weave detected" || echo "‚ùå Weave not found"
    
    # Cilium
    kubectl get pods -n kube-system | grep cilium && echo "‚úÖ Cilium detected" || echo "‚ùå Cilium not found"
    
    # AWS VPC CNI
    kubectl get pods -n kube-system | grep aws-node && echo "‚úÖ AWS VPC CNI detected" || echo "‚ùå AWS VPC CNI not found"
    echo
    
    echo "3. Check CNI-related DaemonSets:"
    kubectl get daemonsets -n kube-system | grep -E "(calico|flannel|weave|cilium|aws-node|kube-proxy)"
    echo
    
    echo "4. Check network-related ConfigMaps:"
    kubectl get configmaps -n kube-system | grep -E "(calico|flannel|weave|cilium|cni)"
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ pod networking
analyze_pod_networking() {
    echo "=== Pod Networking Analysis ==="
    
    echo "1. Create test pods for network analysis:"
    
    # Create test namespace
    kubectl create namespace cni-test 2>/dev/null || echo "Namespace cni-test already exists"
    
    # Create test pods
    cat << TEST_PODS_EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: network-test-1
  namespace: cni-test
  labels:
    app: network-test
spec:
  containers:
  - name: test
    image: busybox:1.28
    command: ["sleep", "3600"]
    resources:
      requests:
        cpu: "50m"
        memory: "64Mi"
---
apiVersion: v1
kind: Pod
metadata:
  name: network-test-2
  namespace: cni-test
  labels:
    app: network-test
spec:
  containers:
  - name: test
    image: busybox:1.28
    command: ["sleep", "3600"]
    resources:
      requests:
        cpu: "50m"
        memory: "64Mi"
TEST_PODS_EOF
    
    echo "Waiting for test pods to be ready..."
    kubectl wait --for=condition=Ready pod/network-test-1 -n cni-test --timeout=60s
    kubectl wait --for=condition=Ready pod/network-test-2 -n cni-test --timeout=60s
    
    echo "2. Analyze pod IP allocation:"
    kubectl get pods -n cni-test -o wide
    echo
    
    echo "3. Check pod network interfaces:"
    POD1_IP=$(kubectl get pod network-test-1 -n cni-test -o jsonpath='{.status.podIP}')
    POD2_IP=$(kubectl get pod network-test-2 -n cni-test -o jsonpath='{.status.podIP}')
    
    echo "Pod 1 IP: $POD1_IP"
    echo "Pod 2 IP: $POD2_IP"
    echo
    
    echo "Network interfaces in pod 1:"
    kubectl exec -n cni-test network-test-1 -- ip addr show
    echo
    
    echo "4. Test pod-to-pod connectivity:"
    echo "Testing connectivity from pod 1 to pod 2:"
    kubectl exec -n cni-test network-test-1 -- ping -c 3 $POD2_IP
    echo
    
    echo "Testing connectivity from pod 2 to pod 1:"
    kubectl exec -n cni-test network-test-2 -- ping -c 3 $POD1_IP
    echo
    
    echo "5. Check routing table in pods:"
    echo "Routing table in pod 1:"
    kubectl exec -n cni-test network-test-1 -- ip route show
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ CNI IPAM
analyze_cni_ipam() {
    echo "=== CNI IPAM (IP Address Management) Analysis ==="
    
    echo "1. Check cluster CIDR configuration:"
    
    # Check from kube-controller-manager
    kubectl get pods -n kube-system -l component=kube-controller-manager -o yaml | grep -A 5 -B 5 "cluster-cidr\|service-cluster-ip-range" || echo "Cannot access controller manager config"
    echo
    
    # Check from nodes
    echo "2. Node CIDR allocation:"
    kubectl get nodes -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.podCIDR}{"\t"}{.spec.podCIDRs}{"\n"}{end}' | column -t
    echo
    
    echo "3. Service CIDR information:"
    kubectl cluster-info dump | grep -E "service-cluster-ip-range|cluster-cidr" | head -5 || echo "Cannot determine service CIDR"
    echo
    
    echo "4. Check IP allocation across pods:"
    echo "Pod IP distribution by node:"
    kubectl get pods --all-namespaces -o wide | awk 'NR>1 {print $8, $7}' | sort | uniq -c | sort -nr
    echo
    
    echo "5. IPAM plugin configuration:"
    # Look for IPAM configuration in CNI configs
    CNI_CONFIG_DIR="/etc/cni/net.d"
    if [ -d "$CNI_CONFIG_DIR" ]; then
        for config_file in "$CNI_CONFIG_DIR"/*.conf "$CNI_CONFIG_DIR"/*.conflist; do
            if [ -f "$config_file" ]; then
                echo "IPAM config in $(basename $config_file):"
                cat "$config_file" | jq '.ipam // .plugins[].ipam' 2>/dev/null | grep -v null || echo "No IPAM config found"
                echo
            fi
        done
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è CNI troubleshooting guide
create_cni_troubleshooting_guide() {
    echo "=== Creating CNI Troubleshooting Guide ==="
    
    echo "1. CNI troubleshooting procedures:"
    cat << CNI_TROUBLESHOOTING_EOF > cni-troubleshooting-guide.md
# CNI Troubleshooting Guide

## üîç **CNI Diagnostics**

### **1. Check CNI Installation**
\`\`\`bash
# Check CNI binaries
ls -la /opt/cni/bin/

# Check CNI configuration
ls -la /etc/cni/net.d/
cat /etc/cni/net.d/*.conf

# Verify CNI plugin versions
/opt/cni/bin/bridge version
/opt/cni/bin/host-local version
\`\`\`

### **2. Analyze CNI Configuration**
\`\`\`bash
# Check CNI config syntax
cat /etc/cni/net.d/10-calico.conflist | jq .

# Verify IPAM configuration
cat /etc/cni/net.d/*.conf | jq '.ipam'

# Check plugin chain
cat /etc/cni/net.d/*.conflist | jq '.plugins[].type'
\`\`\`

### **3. Test CNI Functionality**
\`\`\`bash
# Manual CNI plugin test
export CNI_COMMAND=ADD
export CNI_CONTAINERID=test123
export CNI_NETNS=/var/run/netns/test
export CNI_IFNAME=eth0
export CNI_PATH=/opt/cni/bin

# Create network namespace
ip netns add test

# Run CNI plugin
echo '{"cniVersion":"0.3.1","name":"test","type":"bridge"}' | /opt/cni/bin/bridge

# Cleanup
ip netns del test
\`\`\`

## üö® **Common CNI Issues**

### **Issue 1: Pod Cannot Get IP Address**
**Symptoms**: Pod stuck in ContainerCreating
**Diagnosis**:
\`\`\`bash
kubectl describe pod <pod-name>
kubectl logs -n kube-system <cni-pod>
\`\`\`
**Solutions**:
- Check CNI plugin logs
- Verify IPAM pool availability
- Restart CNI DaemonSet

### **Issue 2: Pod-to-Pod Communication Fails**
**Symptoms**: Pods cannot reach each other
**Diagnosis**:
\`\`\`bash
kubectl exec <pod1> -- ping <pod2-ip>
kubectl exec <pod1> -- traceroute <pod2-ip>
\`\`\`
**Solutions**:
- Check network policies
- Verify CNI plugin configuration
- Check node-to-node connectivity

### **Issue 3: DNS Resolution Problems**
**Symptoms**: Pods cannot resolve service names
**Diagnosis**:
\`\`\`bash
kubectl exec <pod> -- nslookup kubernetes.default
kubectl get pods -n kube-system -l k8s-app=kube-dns
\`\`\`
**Solutions**:
- Check CoreDNS configuration
- Verify CNI DNS settings
- Check service CIDR configuration

## üîß **CNI Performance Tuning**

### **1. Network Performance Optimization**
\`\`\`bash
# Check network interface statistics
kubectl exec <pod> -- cat /proc/net/dev

# Monitor network performance
kubectl exec <pod> -- iperf3 -c <target-ip>

# Check CNI plugin performance
time kubectl create -f test-pod.yaml
\`\`\`

### **2. IPAM Optimization**
\`\`\`bash
# Check IP allocation efficiency
kubectl get pods --all-namespaces -o wide | awk '{print \$7}' | sort | uniq -c

# Monitor IPAM pool usage
kubectl get ippool -o yaml  # For Calico
\`\`\`

CNI_TROUBLESHOOTING_EOF
    
    echo "‚úÖ CNI troubleshooting guide created: cni-troubleshooting-guide.md"
    echo
    
    echo "2. CNI monitoring script:"
    cat << CNI_MONITOR_EOF > cni-monitor.sh
#!/bin/bash

echo "=== CNI Monitor ==="
echo "Press Ctrl+C to stop"
echo

while true; do
    clear
    echo "=== \$(date) ==="
    echo
    
    echo "CNI Plugin Status:"
    kubectl get pods -n kube-system | grep -E "(calico|flannel|weave|cilium|aws-node)" | head -5
    echo
    
    echo "Pod IP Allocation:"
    TOTAL_PODS=\$(kubectl get pods --all-namespaces --no-headers | wc -l)
    RUNNING_PODS=\$(kubectl get pods --all-namespaces --no-headers | grep Running | wc -l)
    PENDING_PODS=\$(kubectl get pods --all-namespaces --no-headers | grep Pending | wc -l)
    
    echo "Total Pods: \$TOTAL_PODS"
    echo "Running Pods: \$RUNNING_PODS"
    echo "Pending Pods: \$PENDING_PODS"
    echo
    
    echo "Network Connectivity Test:"
    # Test connectivity between random pods
    POD1=\$(kubectl get pods --all-namespaces -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
    POD1_NS=\$(kubectl get pods --all-namespaces -o jsonpath='{.items[0].metadata.namespace}' 2>/dev/null)
    POD2_IP=\$(kubectl get pods --all-namespaces -o jsonpath='{.items[1].status.podIP}' 2>/dev/null)
    
    if [ ! -z "\$POD1" ] && [ ! -z "\$POD2_IP" ]; then
        kubectl exec -n \$POD1_NS \$POD1 -- ping -c 1 -W 2 \$POD2_IP >/dev/null 2>&1 && echo "‚úÖ Pod-to-Pod connectivity OK" || echo "‚ùå Pod-to-Pod connectivity FAILED"
    else
        echo "‚ùå Cannot test connectivity - insufficient pods"
    fi
    echo
    
    sleep 30
done

CNI_MONITOR_EOF
    
    chmod +x cni-monitor.sh
    echo "‚úÖ CNI monitoring script created: cni-monitor.sh"
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ CNI workflow
demonstrate_cni_workflow() {
    echo "=== CNI Workflow Demonstration ==="
    
    echo "1. CNI workflow steps:"
    cat << CNI_WORKFLOW_EOF
# CNI Workflow Process

## üìã **Step-by-Step CNI Process**

### **1. Container Runtime Calls CNI**
When kubelet creates a pod:
1. Container runtime (containerd/docker) creates container
2. Runtime calls CNI plugin with ADD command
3. CNI plugin configures network for container

### **2. CNI Plugin Execution**
\`\`\`bash
# Environment variables set by runtime:
CNI_COMMAND=ADD
CNI_CONTAINERID=<container-id>
CNI_NETNS=<network-namespace-path>
CNI_IFNAME=eth0
CNI_PATH=/opt/cni/bin

# CNI configuration passed via stdin:
{
  "cniVersion": "0.3.1",
  "name": "k8s-pod-network",
  "type": "calico",
  "ipam": {
    "type": "calico-ipam"
  }
}
\`\`\`

### **3. Network Interface Creation**
1. Create veth pair
2. Move one end to container namespace
3. Configure IP address via IPAM
4. Set up routing rules
5. Configure DNS settings

### **4. IPAM (IP Address Management)**
1. Request IP from IPAM plugin
2. Allocate IP from available pool
3. Update IP allocation database
4. Return IP configuration to main plugin

### **5. Plugin Chain Execution**
For complex setups, multiple plugins execute in sequence:
1. Main plugin (bridge/calico/flannel)
2. IPAM plugin (host-local/calico-ipam)
3. Meta plugins (portmap/bandwidth)

CNI_WORKFLOW_EOF
    echo
    
    echo "2. Create CNI workflow visualization:"
    cat << CNI_VISUALIZATION_EOF > cni-workflow-visualization.md
# CNI Workflow Visualization

\`\`\`
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    kubelet      ‚îÇ    ‚îÇ Container       ‚îÇ    ‚îÇ   CNI Plugin    ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ Runtime         ‚îÇ    ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                      ‚îÇ                      ‚îÇ
          ‚îÇ 1. Create Pod        ‚îÇ                      ‚îÇ
          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ                      ‚îÇ
          ‚îÇ                      ‚îÇ                      ‚îÇ
          ‚îÇ                      ‚îÇ 2. Call CNI ADD      ‚îÇ
          ‚îÇ                      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
          ‚îÇ                      ‚îÇ                      ‚îÇ
          ‚îÇ                      ‚îÇ                      ‚îÇ 3. Create netns
          ‚îÇ                      ‚îÇ                      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ                      ‚îÇ                      ‚îÇ              ‚îÇ
          ‚îÇ                      ‚îÇ                      ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                      ‚îÇ                      ‚îÇ
          ‚îÇ                      ‚îÇ                      ‚îÇ 4. Call IPAM
          ‚îÇ                      ‚îÇ                      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ                      ‚îÇ                      ‚îÇ              ‚îÇ
          ‚îÇ                      ‚îÇ                      ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                      ‚îÇ                      ‚îÇ
          ‚îÇ                      ‚îÇ                      ‚îÇ 5. Configure interface
          ‚îÇ                      ‚îÇ                      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ                      ‚îÇ                      ‚îÇ              ‚îÇ
          ‚îÇ                      ‚îÇ                      ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                      ‚îÇ                      ‚îÇ
          ‚îÇ                      ‚îÇ 6. Return result     ‚îÇ
          ‚îÇ                      ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
          ‚îÇ                      ‚îÇ                      ‚îÇ
          ‚îÇ 7. Pod Ready         ‚îÇ                      ‚îÇ
          ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                      ‚îÇ
          ‚îÇ                      ‚îÇ                      ‚îÇ
\`\`\`

## üîÑ **CNI Plugin Types and Responsibilities**

### **Main Plugins**
- **bridge**: Creates bridge network
- **ipvlan**: Creates ipvlan interface
- **macvlan**: Creates macvlan interface
- **ptp**: Creates point-to-point link

### **IPAM Plugins**
- **host-local**: Allocates IPs from local ranges
- **dhcp**: Gets IPs from DHCP server
- **static**: Uses static IP assignment

### **Meta Plugins**
- **portmap**: Port mapping functionality
- **bandwidth**: Traffic shaping
- **firewall**: Firewall rules
- **tuning**: Interface tuning

CNI_VISUALIZATION_EOF
    
    echo "‚úÖ CNI workflow visualization created: cni-workflow-visualization.md"
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è cleanup test resources
cleanup_test_resources() {
    echo "=== Cleaning up test resources ==="
    kubectl delete namespace cni-test --ignore-not-found=true
    echo "‚úÖ Test resources cleaned up"
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    case "$1" in
        "config")
            analyze_cni_configuration
            ;;
        "plugin")
            analyze_current_cni_plugin
            ;;
        "networking")
            analyze_pod_networking
            ;;
        "ipam")
            analyze_cni_ipam
            ;;
        "troubleshoot")
            create_cni_troubleshooting_guide
            ;;
        "workflow")
            demonstrate_cni_workflow
            ;;
        "cleanup")
            cleanup_test_resources
            ;;
        "all"|"")
            analyze_cni_configuration
            analyze_current_cni_plugin
            analyze_pod_networking
            analyze_cni_ipam
            create_cni_troubleshooting_guide
            demonstrate_cni_workflow
            ;;
        *)
            echo "Usage: $0 [config|plugin|networking|ipam|troubleshoot|workflow|cleanup|all]"
            echo ""
            echo "CNI Analysis Options:"
            echo "  config       - Analyze CNI configuration"
            echo "  plugin       - Analyze current CNI plugin"
            echo "  networking   - Analyze pod networking"
            echo "  ipam         - Analyze CNI IPAM"
            echo "  troubleshoot - Create troubleshooting guide"
            echo "  workflow     - Demonstrate CNI workflow"
            echo "  cleanup      - Clean up test resources"
            ;;
    esac
}

main "$@"

EOF

chmod +x cni-analysis-toolkit.sh
./cni-analysis-toolkit.sh all
```

## üéØ **–ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ CNI:**

### **1. CNI Specification:**
```json
{
  "cniVersion": "0.4.0",
  "name": "k8s-pod-network",
  "type": "calico",
  "ipam": {
    "type": "calico-ipam"
  },
  "kubernetes": {
    "kubeconfig": "/etc/cni/net.d/calico-kubeconfig"
  }
}
```

### **2. CNI Plugin Chain:**
```bash
# Main plugin
/opt/cni/bin/calico

# IPAM plugin
/opt/cni/bin/host-local

# Meta plugins
/opt/cni/bin/portmap
/opt/cni/bin/bandwidth
```

### **3. CNI Environment Variables:**
```bash
CNI_COMMAND=ADD|DEL|CHECK|VERSION
CNI_CONTAINERID=<container-id>
CNI_NETNS=<network-namespace-path>
CNI_IFNAME=eth0
CNI_PATH=/opt/cni/bin
```

## üîß **CNI Workflow Process:**

### **–®–∞–≥ 1: Container Creation**
```bash
# kubelet —Å–æ–∑–¥–∞–µ—Ç pod
# Container runtime —Å–æ–∑–¥–∞–µ—Ç container
# Runtime –≤—ã–∑—ã–≤–∞–µ—Ç CNI plugin
```

### **–®–∞–≥ 2: Network Namespace Setup**
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ network namespace
ip netns add <container-id>

# –°–æ–∑–¥–∞–Ω–∏–µ veth pair
ip link add veth0 type veth peer name eth0

# –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤ namespace
ip link set eth0 netns <container-id>
```

### **–®–∞–≥ 3: IP Address Allocation**
```bash
# IPAM plugin –≤—ã–¥–µ–ª—è–µ—Ç IP
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ IP –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
ip addr add <ip>/<mask> dev eth0

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
ip route add default via <gateway>
```

### **–®–∞–≥ 4: DNS Configuration**
```bash
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
echo "nameserver <dns-ip>" > /etc/resolv.conf
```

## üåê **CNI –≤ –≤–∞—à–µ–º HA –∫–ª–∞—Å—Ç–µ—Ä–µ:**

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ CNI:**
```bash
# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ CNI plugin
kubectl get pods -n kube-system | grep -E "(calico|flannel|weave|cilium)"

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è CNI
cat /etc/cni/net.d/*.conf

# CNI binaries
ls -la /opt/cni/bin/
```

### **–ê–Ω–∞–ª–∏–∑ —Å–µ—Ç–µ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
```bash
# Pod CIDR
kubectl get nodes -o jsonpath='{.items[*].spec.podCIDR}'

# Service CIDR
kubectl cluster-info dump | grep service-cluster-ip-range

# IP allocation
kubectl get pods --all-namespaces -o wide
```

**CNI - —ç—Ç–æ –æ—Å–Ω–æ–≤–∞ —Å–µ—Ç–µ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Kubernetes, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∞—è –≥–∏–±–∫—É—é –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º—É—é —Å–µ—Ç–µ–≤—É—é –º–æ–¥–µ–ª—å!**
