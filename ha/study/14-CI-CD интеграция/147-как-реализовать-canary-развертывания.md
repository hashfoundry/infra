# 147. –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å canary —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

## üéØ **–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏:**

| –ê—Å–ø–µ–∫—Ç | –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ | Canary —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ |
|--------|---------------------------|---------------------|
| **–°—Ç—Ä–∞—Ç–µ–≥–∏—è –≤—ã–∫–∞—Ç–∫–∏** | –í—Å–µ —Å—Ä–∞–∑—É (Big Bang) | –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞ |
| **–†–∏—Å–∫** | –í—ã—Å–æ–∫–∏–π (–≤–ª–∏—è–µ—Ç –Ω–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π) | –ù–∏–∑–∫–∏–π (–≤–ª–∏—è–µ—Ç –Ω–∞ –º–∞–ª—É—é —á–∞—Å—Ç—å) |
| **–í—Ä–µ–º—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º** | –ü–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –≤—ã–∫–∞—Ç–∫–∏ | –ù–∞ —Ä–∞–Ω–Ω–µ–π —Å—Ç–∞–¥–∏–∏ |
| **–û—Ç–∫–∞—Ç** | –°–ª–æ–∂–Ω—ã–π –∏ –¥–æ–ª–≥–∏–π | –ë—ã—Å—Ç—Ä—ã–π –∏ –ø—Ä–æ—Å—Ç–æ–π |
| **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** | –ë–∞–∑–æ–≤—ã–π | –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ |
| **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è | –ü–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Å –∞–Ω–∞–ª–∏–∑–æ–º |
| **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ** | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ |
| **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞** | 100% –Ω–∞ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é | –ì—Ä–∞–¥—É–∞–ª—å–Ω–æ–µ: 5% ‚Üí 25% ‚Üí 50% ‚Üí 100% |
| **–í—Ä–µ–º—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è** | –ë—ã—Å—Ç—Ä–æ–µ | –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ |
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** | –ü—Ä–æ—Å—Ç–∞—è | –°—Ä–µ–¥–Ω—è—è/–≤—ã—Å–æ–∫–∞—è |
| **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ** | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã |
| **Observability** | –ë–∞–∑–æ–≤–∞—è | –î–µ—Ç–∞–ª—å–Ω–∞—è —Å A/B —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º |

## üèÜ **Canary —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è - —á—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ?**

**Canary —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è** ‚Äî —ç—Ç–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π —Ç—Ä–∞—Ñ–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –ø–æ—ç—Ç–∞–ø–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5% ‚Üí 25% ‚Üí 50% ‚Üí 100%), —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –Ω–∞ —Ä–∞–Ω–Ω–µ–º —ç—Ç–∞–ø–µ –∏ –±—ã—Å—Ç—Ä–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

### **–≠—Ç–∞–ø—ã Canary —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è:**
1. **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞** - —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ —Ä—è–¥–æ–º —Å–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π
2. **–ù–∞—á–∞–ª—å–Ω–∞—è —Ñ–∞–∑–∞** - –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 5-10% —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –∞–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫ (error rate, latency, throughput)
4. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ** - –ø–æ—à–∞–≥–æ–≤–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–∏ —É—Å–ø–µ—à–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫–∞—Ö
5. **–ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è** - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ 100% —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
6. **–û—á–∏—Å—Ç–∫–∞** - —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏

## üìä **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –≤–∞—à–µ–≥–æ HA –∫–ª–∞—Å—Ç–µ—Ä–∞:**

### **1. –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–∏—Ö —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–π:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö Deployment'–æ–≤
kubectl get deployments -A -o wide

# –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
kubectl get deployments -A -o json | jq -r '
  .items[] | 
  "\(.metadata.namespace)/\(.metadata.name): \(.spec.strategy.type // "RollingUpdate")"
'

# –ü–æ–∏—Å–∫ Argo Rollouts (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
kubectl get rollouts -A 2>/dev/null || echo "Argo Rollouts –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Ingress –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ canary routing
kubectl get ingress -A -o json | jq -r '
  .items[] | 
  select(.metadata.annotations | has("nginx.ingress.kubernetes.io/canary")) | 
  "\(.metadata.namespace)/\(.metadata.name): Canary enabled"
'

# –ê–Ω–∞–ª–∏–∑ Service Mesh (Istio) –¥–ª—è traffic splitting
kubectl get virtualservices -A 2>/dev/null || echo "Istio VirtualServices –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
kubectl get destinationrules -A 2>/dev/null || echo "Istio DestinationRules –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ ArgoCD Applications –¥–ª—è progressive delivery
kubectl get applications -n argocd -o json | jq -r '
  .items[] | 
  select(.spec.source.helm.parameters[]?.name == "canary.enabled") | 
  "\(.metadata.name): Canary configured"
' 2>/dev/null || echo "ArgoCD Applications –±–µ–∑ canary –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
```

### **2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –¥–ª—è Canary —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–π:**
```bash
# –ê–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
kubectl get servicemonitors -A -o custom-columns="NAMESPACE:.metadata.namespace,NAME:.metadata.name,ENDPOINTS:.spec.endpoints[*].port"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Prometheus –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫
kubectl get pods -n monitoring | grep prometheus

# –ê–Ω–∞–ª–∏–∑ health checks –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö
kubectl get pods -A -o json | jq -r '
  .items[] | 
  select(.spec.containers[].readinessProbe and .spec.containers[].livenessProbe) | 
  "\(.metadata.namespace)/\(.metadata.name): Has health checks"
'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ HPA –¥–ª—è –∞–≤—Ç–æ–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
kubectl get hpa -A

# –ê–Ω–∞–ª–∏–∑ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è canary pods
kubectl top nodes
kubectl top pods -A --sort-by=cpu
```

### **3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–µ–≤–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ Load Balancer –∏ Ingress
kubectl get services -A --field-selector spec.type=LoadBalancer

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ DNS —Ä–µ–∑–æ–ª—é—Ü–∏–∏ –¥–ª—è service discovery
kubectl run dns-test --rm -i --restart=Never --image=busybox -- \
  nslookup argocd-server.argocd.svc.cluster.local

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –ø–æ–ª–∏—Ç–∏–∫
kubectl get networkpolicies -A

# –ê–Ω–∞–ª–∏–∑ endpoints –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
kubectl get endpoints -A -o json | jq -r '
  .items[] | 
  select(.subsets[].addresses | length > 1) | 
  "\(.metadata.namespace)/\(.metadata.name): \(.subsets[].addresses | length) endpoints"
'
```

## üõ†Ô∏è **Comprehensive Canary Implementation:**

### **1. Argo Rollouts - Advanced Canary Strategy:**
```yaml
# k8s/canary/argo-rollouts-setup.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: argo-rollouts
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argo-rollouts
  namespace: argo-rollouts
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: argo-rollouts
rules:
- apiGroups: [""]
  resources: ["pods", "services", "endpoints", "persistentvolumeclaims", "events", "configmaps", "secrets"]
  verbs: ["*"]
- apiGroups: ["apps"]
  resources: ["deployments", "daemonsets", "replicasets", "statefulsets"]
  verbs: ["*"]
- apiGroups: ["argoproj.io"]
  resources: ["rollouts", "rollouts/status", "experiments", "analysistemplates", "clusteranalysistemplates", "analysisruns"]
  verbs: ["*"]
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses"]
  verbs: ["get", "list", "watch", "update", "patch"]
- apiGroups: ["networking.istio.io"]
  resources: ["virtualservices", "destinationrules"]
  verbs: ["get", "list", "watch", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: argo-rollouts
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: argo-rollouts
subjects:
- kind: ServiceAccount
  name: argo-rollouts
  namespace: argo-rollouts
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argo-rollouts-controller
  namespace: argo-rollouts
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: argo-rollouts-controller
  template:
    metadata:
      labels:
        app.kubernetes.io/name: argo-rollouts-controller
    spec:
      serviceAccountName: argo-rollouts
      containers:
      - name: argo-rollouts
        image: quay.io/argoproj/argo-rollouts:v1.6.0
        command:
        - /manager
        args:
        - --leader-elect
        - --prometheus-listen-port=8090
        - --klogs-level=0
        - --log-level=info
        - --log-format=text
        ports:
        - name: metrics
          containerPort: 8090
          protocol: TCP
        - name: healthz
          containerPort: 8080
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /healthz
            port: healthz
          initialDelaySeconds: 30
          periodSeconds: 20
          successThreshold: 1
          timeoutSeconds: 10
        readinessProbe:
          httpGet:
            path: /metrics
            port: metrics
          initialDelaySeconds: 10
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 4
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 999
```

### **2. HashFoundry Canary Rollout Configuration:**
```yaml
# k8s/canary/hashfoundry-rollout.yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: hashfoundry-webapp-rollout
  namespace: hashfoundry-production
  labels:
    app.kubernetes.io/name: hashfoundry-webapp
    app.kubernetes.io/component: rollout
spec:
  replicas: 10
  strategy:
    canary:
      maxSurge: "25%"
      maxUnavailable: 0
      analysis:
        templates:
        - templateName: hashfoundry-success-rate
        - templateName: hashfoundry-latency-check
        startingStep: 2
        args:
        - name: service-name
          value: hashfoundry-webapp-canary
        - name: namespace
          value: hashfoundry-production
      steps:
      - setWeight: 5
      - pause: {duration: 2m}
      - setWeight: 10
      - pause: {duration: 2m}
      - setWeight: 20
      - pause: {duration: 5m}
      - setWeight: 40
      - pause: {duration: 10m}
      - setWeight: 60
      - pause: {duration: 10m}
      - setWeight: 80
      - pause: {duration: 10m}
      canaryService: hashfoundry-webapp-canary
      stableService: hashfoundry-webapp-stable
      trafficRouting:
        nginx:
          stableIngress: hashfoundry-webapp-stable
          annotationPrefix: nginx.ingress.kubernetes.io
          additionalIngressAnnotations:
            canary-by-header: X-Canary
            canary-by-cookie: canary-user
      scaleDownDelaySeconds: 30
      abortScaleDownDelaySeconds: 30
  selector:
    matchLabels:
      app.kubernetes.io/name: hashfoundry-webapp
  template:
    metadata:
      labels:
        app.kubernetes.io/name: hashfoundry-webapp
        app.kubernetes.io/version: "{{.Values.image.tag}}"
    spec:
      containers:
      - name: webapp
        image: hashfoundry/webapp:v1.0.0
        ports:
        - name: http
          containerPort: 3000
          protocol: TCP
        env:
        - name: NODE_ENV
          value: "production"
        - name: PORT
          value: "3000"
        - name: VERSION
          value: "{{.Values.image.tag}}"
        livenessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /ready
            port: http
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1001
  revisionHistoryLimit: 5
---
apiVersion: v1
kind: Service
metadata:
  name: hashfoundry-webapp-stable
  namespace: hashfoundry-production
  labels:
    app.kubernetes.io/name: hashfoundry-webapp
    app.kubernetes.io/component: stable-service
spec:
  selector:
    app.kubernetes.io/name: hashfoundry-webapp
  ports:
  - name: http
    port: 80
    targetPort: http
    protocol: TCP
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: hashfoundry-webapp-canary
  namespace: hashfoundry-production
  labels:
    app.kubernetes.io/name: hashfoundry-webapp
    app.kubernetes.io/component: canary-service
spec:
  selector:
    app.kubernetes.io/name: hashfoundry-webapp
  ports:
  - name: http
    port: 80
    targetPort: http
    protocol: TCP
  type: ClusterIP
```

### **3. Analysis Templates –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ü–µ–Ω–∫–∏:**
```yaml
# k8s/canary/analysis-templates.yaml
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: hashfoundry-success-rate
  namespace: hashfoundry-production
spec:
  args:
  - name: service-name
  - name: namespace
  metrics:
  - name: success-rate
    interval: 1m
    count: 5
    successCondition: result[0] >= 0.95
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus-server.monitoring.svc.cluster.local:80
        query: |
          sum(rate(
            http_requests_total{
              job="{{args.service-name}}",
              namespace="{{args.namespace}}",
              status!~"5.."
            }[2m]
          )) / 
          sum(rate(
            http_requests_total{
              job="{{args.service-name}}",
              namespace="{{args.namespace}}"
            }[2m]
          ))
  - name: error-rate
    interval: 1m
    count: 5
    successCondition: result[0] <= 0.05
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus-server.monitoring.svc.cluster.local:80
        query: |
          sum(rate(
            http_requests_total{
              job="{{args.service-name}}",
              namespace="{{args.namespace}}",
              status=~"5.."
            }[2m]
          )) / 
          sum(rate(
            http_requests_total{
              job="{{args.service-name}}",
              namespace="{{args.namespace}}"
            }[2m]
          ))
---
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: hashfoundry-latency-check
  namespace: hashfoundry-production
spec:
  args:
  - name: service-name
  - name: namespace
  metrics:
  - name: avg-response-time
    interval: 1m
    count: 5
    successCondition: result[0] <= 0.5
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus-server.monitoring.svc.cluster.local:80
        query: |
          histogram_quantile(0.95,
            sum(rate(
              http_request_duration_seconds_bucket{
                job="{{args.service-name}}",
                namespace="{{args.namespace}}"
              }[2m]
            )) by (le)
          )
  - name: p99-response-time
    interval: 1m
    count: 5
    successCondition: result[0] <= 1.0
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus-server.monitoring.svc.cluster.local:80
        query: |
          histogram_quantile(0.99,
            sum(rate(
              http_request_duration_seconds_bucket{
                job="{{args.service-name}}",
                namespace="{{args.namespace}}"
              }[2m]
            )) by (le)
          )
  - name: memory-usage
    interval: 1m
    count: 5
    successCondition: result[0] <= 400000000  # 400MB
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus-server.monitoring.svc.cluster.local:80
        query: |
          avg(
            container_memory_usage_bytes{
              pod=~"hashfoundry-webapp-rollout-.*",
              namespace="{{args.namespace}}",
              container="webapp"
            }
          )
  - name: cpu-usage
    interval: 1m
    count: 5
    successCondition: result[0] <= 0.8  # 80% CPU
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus-server.monitoring.svc.cluster.local:80
        query: |
          avg(
            rate(container_cpu_usage_seconds_total{
              pod=~"hashfoundry-webapp-rollout-.*",
              namespace="{{args.namespace}}",
              container="webapp"
            }[2m])
          )
```

### **4. NGINX Ingress Canary Configuration:**
```yaml
# k8s/canary/nginx-ingress-canary.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hashfoundry-webapp-stable
  namespace: hashfoundry-production
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$1
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - app.hashfoundry.com
    secretName: hashfoundry-webapp-tls
  rules:
  - host: app.hashfoundry.com
    http:
      paths:
      - path: /(.*)
        pathType: Prefix
        backend:
          service:
            name: hashfoundry-webapp-stable
            port:
              number: 80
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hashfoundry-webapp-canary
  namespace: hashfoundry-production
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-weight: "0"
    nginx.ingress.kubernetes.io/canary-by-header: "X-Canary"
    nginx.ingress.kubernetes.io/canary-by-header-value: "true"
    nginx.ingress.kubernetes.io/canary-by-cookie: "canary-user"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$1
spec:
  tls:
  - hosts:
    - app.hashfoundry.com
    secretName: hashfoundry-webapp-tls
  rules:
  - host: app.hashfoundry.com
    http:
      paths:
      - path: /(.*)
        pathType: Prefix
        backend:
          service:
            name: hashfoundry-webapp-canary
            port:
              number: 80
```

## üéì **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:**

**Canary —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è** –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π —Å–ø–æ—Å–æ–± –≤—ã–∫–∞—Ç–∫–∏ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —Ä–∏—Å–∫–∞–º–∏.

### **üîë –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
1. **–°–Ω–∏–∂–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–≤** - –ø—Ä–æ–±–ª–µ–º—ã –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç —Ç–æ–ª—å–∫–æ –º–∞–ª—É—é —á–∞—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **–ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ** - –ø—Ä–æ–±–ª–µ–º—ã –≤—ã—è–≤–ª—è—é—Ç—Å—è –Ω–∞ —Ä–∞–Ω–Ω–µ–π —Å—Ç–∞–¥–∏–∏
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç** - —Å–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
4. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è** - –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –±–µ–∑ –ø—Ä–æ—Å—Ç–æ–µ–≤
5. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö
6. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏** - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### **üõ†Ô∏è –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- **Argo Rollouts** - –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
- **NGINX Ingress** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–æ–º –Ω–∞ —É—Ä–æ–≤–Ω–µ Ingress
- **Istio Service Mesh** - —Å–ª–æ–∂–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞
- **Prometheus + Grafana** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥
- **Flagger** - –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è canary —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–π

### **üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –≤ –≤–∞—à–µ–º HA –∫–ª–∞—Å—Ç–µ—Ä–µ:**
```bash
# –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–∏—Ö —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–π
kubectl get deployments -A -o wide
kubectl get rollouts -A

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –¥–ª—è canary
kubectl get servicemonitors -A
kubectl get ingress -A

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ canary —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–π
kubectl argo rollouts get rollout hashfoundry-webapp-rollout -n hashfoundry-production
kubectl argo rollouts status hashfoundry-webapp-rollout -n hashfoundry-production

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ canary
kubectl argo rollouts promote hashfoundry-webapp-rollout -n hashfoundry-production
kubectl argo rollouts abort hashfoundry-webapp-rollout -n hashfoundry-production
```

### **üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Argo Rollouts –≤ –≤–∞—à HA –∫–ª–∞—Å—Ç–µ—Ä
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ —Å Prometheus
3. –°–æ–∑–¥–∞–π—Ç–µ Analysis Templates –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ü–µ–Ω–∫–∏
4. –í–Ω–µ–¥—Ä–∏—Ç–µ canary —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
5. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç–∏–Ω–≥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã

**–ü–æ–º–Ω–∏—Ç–µ:** Canary —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç —Ö–æ—Ä–æ—à–µ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —á–µ—Ç–∫–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ —É—Å–ø–µ—Ö–∞ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã!
