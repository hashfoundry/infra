# 196. –ß—Ç–æ —Ç–∞–∫–æ–µ Aggregated API Server?

## üéØ **–ß—Ç–æ —Ç–∞–∫–æ–µ Aggregated API Server?**

**Aggregated API Server** ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è Kubernetes API, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ API —Å–µ—Ä–≤–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É—é—Ç—Å—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º kube-apiserver. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤—Å–µ—Ö API —Ä–µ—Å—É—Ä—Å–æ–≤ —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã Kubernetes.

## üèóÔ∏è **–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

### **1. API Aggregation Layer**
- –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ extension API —Å–µ—Ä–≤–µ—Ä–∞–º
- –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ kube-apiserver
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ API
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π

### **2. APIService Registration**
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö API –≥—Ä—É–ø–ø
- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º —Å–µ—Ä–≤–µ—Ä–∞–º
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ API –≤–µ—Ä—Å–∏–π
- TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### **3. Extension API Servers**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ API –ª–æ–≥–∏–∫–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –º—É—Ç–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –¥–∞–Ω–Ω—ã—Ö

## üìä **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –≤–∞—à–µ–≥–æ HA –∫–ª–∞—Å—Ç–µ—Ä–∞:**

### **1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö Aggregated API:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö APIServices –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
kubectl get apiservices

# –ü—Ä–æ–≤–µ—Ä–∫–∞ metrics server (–ø—Ä–∏–º–µ—Ä aggregated API)
kubectl get apiservices v1beta1.metrics.k8s.io -o yaml

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö API –≥—Ä—É–ø–ø
kubectl api-resources | grep -v "^NAME"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ API versions
kubectl api-versions | sort

# –ü—Ä–æ–≤–µ—Ä–∫–∞ custom resource definitions
kubectl get crd
```

### **2. –ê–Ω–∞–ª–∏–∑ Metrics Server –∫–∞–∫ –ø—Ä–∏–º–µ—Ä:**
```bash
# Metrics Server - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä Aggregated API
kubectl get deployment metrics-server -n kube-system

# –ü—Ä–æ–≤–µ—Ä–∫–∞ APIService –¥–ª—è metrics
kubectl describe apiservice v1beta1.metrics.k8s.io

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ metrics API
kubectl top nodes
kubectl top pods -n monitoring

# –ü—Ä–æ–≤–µ—Ä–∫–∞ service –¥–ª—è metrics server
kubectl get service metrics-server -n kube-system -o yaml
```

### **3. –ü—Ä–æ–≤–µ—Ä–∫–∞ ArgoCD –∫–∞–∫ extension API:**
```bash
# ArgoCD –∏—Å–ø–æ–ª—å–∑—É–µ—Ç CRDs, –Ω–æ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å aggregated API
kubectl get crd | grep argoproj

# –ü—Ä–æ–≤–µ—Ä–∫–∞ ArgoCD API —Ä–µ—Å—É—Ä—Å–æ–≤
kubectl api-resources | grep argoproj

# –ü—Ä–æ–≤–µ—Ä–∫–∞ applications —á–µ—Ä–µ–∑ API
kubectl get applications -n argocd -o yaml | head -20
```

### **4. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ Extension API Server:**
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ namespace –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
kubectl create namespace api-extension-test

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –¥–ª—è API server
openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 \
  -keyout tls.key -out tls.crt \
  -subj "/CN=example-api-server.api-extension-test.svc"

# –°–æ–∑–¥–∞–Ω–∏–µ secret —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
kubectl create secret tls example-api-server-certs \
  --cert=tls.crt --key=tls.key -n api-extension-test
```

### **5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ API aggregation:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ kube-apiserver –¥–ª—è aggregation
kubectl logs -n kube-system -l component=kube-apiserver | grep -i aggregat

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫ API server
kubectl port-forward -n kube-system svc/kube-apiserver 8080:8080 &
curl http://localhost:8080/metrics | grep apiserver_request

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ Prometheus
kubectl port-forward svc/prometheus-server -n monitoring 9090:80
# Query: apiserver_request_duration_seconds{verb="GET"}
```

## üîÑ **–°–æ–∑–¥–∞–Ω–∏–µ Extension API Server:**

### **1. APIService –∏ Service –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```yaml
# example-api-server.yaml
apiVersion: apiregistration.k8s.io/v1
kind: APIService
metadata:
  name: v1alpha1.widgets.example.com
spec:
  group: widgets.example.com
  version: v1alpha1
  groupPriorityMinimum: 100
  versionPriority: 100
  service:
    name: example-api-server
    namespace: api-extension-test
    port: 443
  caBundle: LS0tLS1CRUdJTi0tLS0t  # Base64 encoded CA cert
  insecureSkipTLSVerify: false

---
# Service –¥–ª—è extension API server
apiVersion: v1
kind: Service
metadata:
  name: example-api-server
  namespace: api-extension-test
  labels:
    app: example-api-server
spec:
  selector:
    app: example-api-server
  ports:
  - name: https
    port: 443
    targetPort: 8443
    protocol: TCP
  type: ClusterIP

---
# Deployment –¥–ª—è extension API server
apiVersion: apps/v1
kind: Deployment
metadata:
  name: example-api-server
  namespace: api-extension-test
spec:
  replicas: 2
  selector:
    matchLabels:
      app: example-api-server
  template:
    metadata:
      labels:
        app: example-api-server
    spec:
      serviceAccountName: example-api-server
      containers:
      - name: api-server
        image: example/widget-api-server:v1.0.0
        ports:
        - containerPort: 8443
          name: https
        args:
        - --secure-port=8443
        - --tls-cert-file=/etc/certs/tls.crt
        - --tls-private-key-file=/etc/certs/tls.key
        - --audit-log-path=-
        - --feature-gates=APIPriorityAndFairness=false
        - --audit-log-maxage=0
        - --audit-log-maxbackup=0
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        volumeMounts:
        - name: certs
          mountPath: /etc/certs
          readOnly: true
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8443
            scheme: HTTPS
          initialDelaySeconds: 30
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8443
            scheme: HTTPS
          initialDelaySeconds: 5
      volumes:
      - name: certs
        secret:
          secretName: example-api-server-certs

---
# ServiceAccount –∏ RBAC
apiVersion: v1
kind: ServiceAccount
metadata:
  name: example-api-server
  namespace: api-extension-test

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: example-api-server
rules:
- apiGroups: [""]
  resources: ["namespaces"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["authentication.k8s.io"]
  resources: ["tokenreviews"]
  verbs: ["create"]
- apiGroups: ["authorization.k8s.io"]
  resources: ["subjectaccessreviews"]
  verbs: ["create"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: example-api-server
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: example-api-server
subjects:
- kind: ServiceAccount
  name: example-api-server
  namespace: api-extension-test

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: example-api-server-auth-reader
  namespace: kube-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: extension-apiserver-authentication-reader
subjects:
- kind: ServiceAccount
  name: example-api-server
  namespace: api-extension-test
```

### **2. Widget Custom Resource Definition:**
```yaml
# widget-crd.yaml (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å aggregated API)
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: widgets.widgets.example.com
spec:
  group: widgets.example.com
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              size:
                type: string
                enum: ["small", "medium", "large"]
                default: "medium"
              color:
                type: string
                default: "blue"
              replicas:
                type: integer
                minimum: 1
                maximum: 10
                default: 1
          status:
            type: object
            properties:
              phase:
                type: string
                enum: ["Pending", "Active", "Failed"]
              conditions:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                    status:
                      type: string
                    lastTransitionTime:
                      type: string
                      format: date-time
  scope: Namespaced
  names:
    plural: widgets
    singular: widget
    kind: Widget
    shortNames:
    - wg
```

### **3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Extension API:**
```bash
# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
kubectl apply -f example-api-server.yaml

# –ü—Ä–æ–≤–µ—Ä–∫–∞ deployment
kubectl get pods -n api-extension-test -l app=example-api-server

# –ü—Ä–æ–≤–µ—Ä–∫–∞ APIService —Å—Ç–∞—Ç—É—Å–∞
kubectl get apiservice v1alpha1.widgets.example.com

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
kubectl api-resources | grep widgets

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ widget
cat <<EOF | kubectl apply -f -
apiVersion: widgets.example.com/v1alpha1
kind: Widget
metadata:
  name: test-widget
  namespace: api-extension-test
spec:
  size: large
  color: red
  replicas: 3
EOF

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞
kubectl get widgets -n api-extension-test
kubectl describe widget test-widget -n api-extension-test
```

## üîß **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Aggregated API:**

### **1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è APIServices:**
```bash
# –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö APIServices
kubectl get apiservices -o wide

# –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± APIService
kubectl describe apiservice v1alpha1.widgets.example.com

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
kubectl get apiservice v1alpha1.widgets.example.com -o jsonpath='{.status.conditions[*]}'

# –õ–æ–≥–∏ extension API server
kubectl logs -n api-extension-test -l app=example-api-server
```

### **2. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤–æ–π —Å–≤—è–∑–Ω–æ—Å—Ç–∏
kubectl get endpoints -n api-extension-test example-api-server

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
kubectl get secret example-api-server-certs -n api-extension-test -o yaml

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä—è–º–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API server
kubectl port-forward -n api-extension-test svc/example-api-server 8443:443 &
curl -k https://localhost:8443/healthz

# –ü—Ä–æ–≤–µ—Ä–∫–∞ RBAC —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
kubectl auth can-i create widgets.widgets.example.com --as=system:serviceaccount:api-extension-test:example-api-server
```

### **3. Prometheus –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è API aggregation:**
```yaml
# api-server-monitoring.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: example-api-server
  namespace: api-extension-test
spec:
  selector:
    matchLabels:
      app: example-api-server
  endpoints:
  - port: https
    scheme: https
    tlsConfig:
      insecureSkipVerify: true
    path: /metrics

---
# PrometheusRule –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: api-server-alerts
  namespace: api-extension-test
spec:
  groups:
  - name: api-server.rules
    rules:
    - alert: APIServerDown
      expr: up{job="example-api-server"} == 0
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "Extension API Server is down"
        description: "Extension API Server has been down for more than 1 minute"
    
    - alert: APIServerHighLatency
      expr: histogram_quantile(0.99, rate(apiserver_request_duration_seconds_bucket[5m])) > 1
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High API Server latency"
        description: "99th percentile latency is above 1s"
```

## üè≠ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º HA –∫–ª–∞—Å—Ç–µ—Ä–æ–º:**

### **1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å ArgoCD:**
```yaml
# argocd-widget-application.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: widget-api-server
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/hashfoundry/widget-api-server
    targetRevision: HEAD
    path: k8s
  destination:
    server: https://kubernetes.default.svc
    namespace: api-extension-test
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
```

### **2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ Grafana:**
```json
{
  "dashboard": {
    "title": "Extension API Server Metrics",
    "panels": [
      {
        "title": "API Server Availability",
        "type": "stat",
        "targets": [
          {
            "expr": "up{job=\"example-api-server\"}",
            "legendFormat": "{{instance}}"
          }
        ]
      },
      {
        "title": "Request Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(apiserver_request_total{job=\"example-api-server\"}[5m])",
            "legendFormat": "{{verb}} {{resource}"
          }
        ]
      },
      {
        "title": "Request Duration",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(apiserver_request_duration_seconds_bucket{job=\"example-api-server\"}[5m]))",
            "legendFormat": "95th percentile"
          }
        ]
      },
      {
        "title": "Error Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(apiserver_request_total{job=\"example-api-server\",code!~\"2..\"}[5m])",
            "legendFormat": "{{code}}"
          }
        ]
      }
    ]
  }
}
```

### **3. Backup –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:**
```bash
# Backup APIService –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
kubectl get apiservice v1alpha1.widgets.example.com -o yaml > apiservice-backup.yaml

# Backup custom resources
kubectl get widgets --all-namespaces -o yaml > widgets-backup.yaml

# Backup extension API server deployment
kubectl get deployment example-api-server -n api-extension-test -o yaml > api-server-deployment-backup.yaml

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
kubectl apply -f apiservice-backup.yaml
kubectl apply -f api-server-deployment-backup.yaml
kubectl apply -f widgets-backup.yaml
```

## üö® **Troubleshooting Aggregated API:**

### **1. –û–±—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è:**
```bash
# APIService –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
kubectl get apiservice v1alpha1.widgets.example.com -o yaml | grep -A 10 conditions

# –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
kubectl describe secret example-api-server-certs -n api-extension-test

# –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é
kubectl get endpoints example-api-server -n api-extension-test
kubectl describe service example-api-server -n api-extension-test

# –ü—Ä–æ–±–ª–µ–º—ã —Å RBAC
kubectl auth can-i "*" "*" --as=system:serviceaccount:api-extension-test:example-api-server
```

### **2. –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç:**
```bash
#!/bin/bash
# diagnose-aggregated-api.sh

echo "üîç Diagnosing Aggregated API Server"

diagnose_apiservice() {
    local apiservice=$1
    
    echo "=== APIService Status ==="
    kubectl get apiservice $apiservice -o yaml
    
    echo ""
    echo "=== Service Endpoints ==="
    service_name=$(kubectl get apiservice $apiservice -o jsonpath='{.spec.service.name}')
    service_namespace=$(kubectl get apiservice $apiservice -o jsonpath='{.spec.service.namespace}')
    
    if [ -n "$service_name" ] && [ -n "$service_namespace" ]; then
        kubectl get endpoints $service_name -n $service_namespace
        kubectl describe service $service_name -n $service_namespace
    fi
    
    echo ""
    echo "=== Pod Status ==="
    kubectl get pods -n $service_namespace -l app=$service_name
    
    echo ""
    echo "=== Recent Events ==="
    kubectl get events -n $service_namespace --sort-by='.lastTimestamp' | tail -10
}

test_api_functionality() {
    local group=$1
    local version=$2
    local resource=$3
    
    echo "=== Testing API Functionality ==="
    
    # Test API discovery
    echo "--- API Discovery ---"
    kubectl api-resources --api-group=$group
    
    # Test resource operations
    echo "--- Resource Operations ---"
    kubectl get $resource --all-namespaces 2>&1 || echo "Failed to list resources"
    
    # Test resource creation
    echo "--- Resource Creation Test ---"
    cat <<EOF | kubectl apply --dry-run=client -f - 2>&1 || echo "Failed validation"
apiVersion: $group/$version
kind: Widget
metadata:
  name: test-widget
  namespace: default
spec:
  size: medium
  color: blue
EOF
}

check_certificates() {
    local secret_name=$1
    local namespace=$2
    
    echo "=== Certificate Check ==="
    
    if kubectl get secret $secret_name -n $namespace >/dev/null 2>&1; then
        echo "Certificate secret exists"
        
        # Extract and check certificate
        kubectl get secret $secret_name -n $namespace -o jsonpath='{.data.tls\.crt}' | base64 -d | openssl x509 -text -noout | head -20
    else
        echo "Certificate secret not found"
    fi
}

main() {
    local apiservice=${1:-"v1alpha1.widgets.example.com"}
    local group=${2:-"widgets.example.com"}
    local version=${3:-"v1alpha1"}
    local resource=${4:-"widgets"}
    
    diagnose_apiservice $apiservice
    echo ""
    test_api_functionality $group $version $resource
    echo ""
    check_certificates "example-api-server-certs" "api-extension-test"
}

main "$@"
```

## üéØ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Aggregated API –≤ HA –∫–ª–∞—Å—Ç–µ—Ä–µ:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              HA Cluster Aggregated API Architecture        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Client Layer                                              ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ kubectl                                               ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ ArgoCD UI                                             ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Grafana Dashboards                                    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Custom Applications                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Load Balancer (DigitalOcean)                             ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ NGINX Ingress Controller                              ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ TLS Termination                                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Kubernetes API Layer                                      ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ kube-apiserver (HA)                                   ‚îÇ
‚îÇ  ‚îÇ   ‚îú‚îÄ‚îÄ Core API (/api/v1)                               ‚îÇ
‚îÇ  ‚îÇ   ‚îú‚îÄ‚îÄ Extensions API (/apis/)                          ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ‚îÄ Aggregation Layer                                ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ APIService Registry                                   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Request Routing                                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Extension API Servers                                     ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Metrics Server (HA)                                   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Custom Widget API (HA)                                ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ ArgoCD API Extensions                                 ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Monitoring API Extensions                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Storage Layer                                             ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ etcd (HA cluster)                                     ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ NFS Shared Storage                                    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Persistent Volumes                                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Monitoring & Observability                               ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Prometheus (metrics collection)                       ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Grafana (visualization)                              ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ AlertManager (alerting)                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üéØ **Best Practices –¥–ª—è Aggregated API:**

### **1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ RBAC —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
- –í–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ admission webhooks –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### **2. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –†–µ–∞–ª–∏–∑—É–π—Ç–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ connection pooling
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ throughput
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### **3. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**
- –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–π—Ç–µ –≤ HA –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–º–∏–Ω–∏–º—É–º 2 —Ä–µ–ø–ª–∏–∫–∏)
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ health checks –∏ readiness probes
- –†–µ–∞–ª–∏–∑—É–π—Ç–µ graceful shutdown
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ circuit breakers –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### **4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
- –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Prometheus
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
- –õ–æ–≥–∏—Ä—É–π—Ç–µ –≤—Å–µ API –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

**Aggregated API Server ‚Äî —ç—Ç–æ –º–æ—â–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è Kubernetes API —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –µ–¥–∏–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤!**
