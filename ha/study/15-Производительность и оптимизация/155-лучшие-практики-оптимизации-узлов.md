# 155. –ö–∞–∫–∏–µ –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —É–∑–ª–æ–≤?

## üéØ **–ß—Ç–æ —Ç–∞–∫–æ–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É–∑–ª–æ–≤ Kubernetes?**

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É–∑–ª–æ–≤ Kubernetes** ‚Äî —ç—Ç–æ –∫–æ–º–ø–ª–µ–∫—Å –º–µ—Ä –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã, kubelet, container runtime –∏ —Å–µ—Ç–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ.

## üèóÔ∏è **–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —É–∑–ª–æ–≤:**

### **1. –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞**
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —è–¥—Ä–∞ Linux (sysctl –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –∏ swap
- –°–µ—Ç–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

### **2. Kubelet –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**
- Resource management –∏ reservations
- Garbage collection –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- Eviction policies
- CPU –∏ topology management

### **3. Container Runtime**
- Docker/containerd –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- Storage driver –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- Image management
- Logging –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### **4. –°–µ—Ç–µ–≤–∞—è –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞**
- CNI –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- iptables/netfilter –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- kube-proxy –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- DNS –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

## üìä **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –≤–∞—à–µ–≥–æ HA –∫–ª–∞—Å—Ç–µ—Ä–∞:**

### **1. –ê–Ω–∞–ª–∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–∑–ª–æ–≤:**
```bash
# –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É–∑–ª–∞—Ö
kubectl get nodes -o wide

# –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —É–∑–ª–µ
kubectl describe node <node-name>

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ —É–∑–ª–æ–≤
kubectl top nodes

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —É–∑–ª–æ–≤
kubectl get nodes -o custom-columns=NAME:.metadata.name,STATUS:.status.conditions[-1].type,READY:.status.conditions[-1].status,AGE:.metadata.creationTimestamp
```

### **2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —É–∑–ª–æ–≤:**
```bash
# –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –Ω–∞ —É–∑–ª–µ
ssh <node-ip> "top -bn1 | head -20"

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
ssh <node-ip> "df -h"

# –°–µ—Ç–µ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
ssh <node-ip> "ss -tuln | grep -E ':6443|:10250|:2379|:2380'"

# –ü—Ä–æ—Ü–µ—Å—Å—ã Kubernetes
ssh <node-ip> "ps aux | grep -E 'kubelet|containerd|kube-proxy'"
```

### **3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ kubelet:**
```bash
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è kubelet
kubectl get --raw /api/v1/nodes/<node-name>/proxy/configz | jq .

# –°—Ç–∞—Ç—É—Å kubelet –Ω–∞ —É–∑–ª–µ
ssh <node-ip> "systemctl status kubelet"

# –õ–æ–≥–∏ kubelet
ssh <node-ip> "journalctl -u kubelet -f --since '10 minutes ago'"
```

### **4. –ê–Ω–∞–ª–∏–∑ container runtime:**
```bash
# –°—Ç–∞—Ç—É—Å containerd
ssh <node-ip> "systemctl status containerd"

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö
ssh <node-ip> "crictl ps"

# –û–±—Ä–∞–∑—ã –Ω–∞ —É–∑–ª–µ
ssh <node-ip> "crictl images"

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ runtime
ssh <node-ip> "crictl stats"
```

### **5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
```bash
# –°–µ—Ç–µ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
ssh <node-ip> "ip addr show"

# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
ssh <node-ip> "ip route show"

# iptables –ø—Ä–∞–≤–∏–ª–∞ (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ - –º–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞)
ssh <node-ip> "iptables -L -n | head -50"

# CNI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
ssh <node-ip> "ls -la /etc/cni/net.d/"
```

## üîÑ **–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —É–∑–ª–æ–≤:**

### **1. –°–∫—Ä–∏–ø—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —É–∑–ª–∞:**
```bash
# –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç node-optimizer.sh
cat << 'EOF' > node-optimizer.sh
#!/bin/bash

echo "üöÄ –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É–∑–ª–∞ Kubernetes"
echo "=========================================="

NODE_NAME=$(hostname)
echo "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É–∑–ª–∞: $NODE_NAME"

# 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —è–¥—Ä–∞ Linux
echo -e "\nüêß 1. –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –Ø–î–†–ê LINUX:"

# –°–µ—Ç–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
cat >> /etc/sysctl.conf << 'SYSCTL_EOF'
# Kubernetes network optimization
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward = 1

# TCP optimization
net.core.somaxconn = 32768
net.core.netdev_max_backlog = 5000
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 134217728
net.ipv4.tcp_wmem = 4096 65536 134217728
net.ipv4.tcp_congestion_control = bbr

# Memory management
vm.swappiness = 1
vm.dirty_ratio = 80
vm.dirty_background_ratio = 5
vm.max_map_count = 262144

# File system
fs.file-max = 2097152
fs.inotify.max_user_instances = 8192
fs.inotify.max_user_watches = 524288

# Connection tracking
net.netfilter.nf_conntrack_max = 1048576
net.netfilter.nf_conntrack_tcp_timeout_established = 600
net.netfilter.nf_conntrack_buckets = 262144
SYSCTL_EOF

sysctl -p
echo "‚úÖ –Ø–¥—Ä–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ"

# 2. –û—Ç–∫–ª—é—á–µ–Ω–∏–µ swap
echo -e "\nüíæ 2. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ê–ú–Ø–¢–¨–Æ:"
if [ $(swapon --show | wc -l) -gt 0 ]; then
    swapoff -a
    sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
    echo "‚úÖ Swap –æ—Ç–∫–ª—é—á–µ–Ω"
else
    echo "‚úÖ Swap —É–∂–µ –æ—Ç–∫–ª—é—á–µ–Ω"
fi

# 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
echo -e "\nüìÅ 3. –§–ê–ô–õ–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê:"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ mount –æ–ø—Ü–∏–π
if ! mount | grep -q "noatime"; then
    echo "‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å noatime –≤ /etc/fstab"
fi

# I/O scheduler –¥–ª—è SSD
for disk in $(lsblk -d -o name | grep -v NAME); do
    if [ -f /sys/block/$disk/queue/scheduler ]; then
        echo noop > /sys/block/$disk/queue/scheduler 2>/dev/null || echo mq-deadline > /sys/block/$disk/queue/scheduler
        echo "‚úÖ I/O scheduler –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è $disk"
    fi
done

# 4. –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–∏–º–∏—Ç—ã
echo -e "\nüîß 4. –°–ò–°–¢–ï–ú–ù–´–ï –õ–ò–ú–ò–¢–´:"
cat >> /etc/security/limits.conf << 'LIMITS_EOF'
# Kubernetes optimizations
* soft nofile 1048576
* hard nofile 1048576
* soft nproc 1048576
* hard nproc 1048576
root soft nofile 1048576
root hard nofile 1048576
root soft nproc 1048576
root hard nproc 1048576
LIMITS_EOF

echo "‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–∏–º–∏—Ç—ã —É–≤–µ–ª–∏—á–µ–Ω—ã"

echo -e "\n‚úÖ –ë–∞–∑–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É–∑–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üîÑ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π"
EOF

chmod +x node-optimizer.sh
```

### **2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è kubelet –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
```bash
# –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç kubelet-optimizer.sh
cat << 'EOF' > kubelet-optimizer.sh
#!/bin/bash

echo "‚öôÔ∏è –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è kubelet –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
echo "==================================="

# –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ kubelet
cat > /var/lib/kubelet/config.yaml << 'KUBELET_EOF'
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration

# –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
maxPods: 250
podsPerCore: 10
registryPullQPS: 10
registryBurst: 20

# Garbage collection
imageGCHighThresholdPercent: 85
imageGCLowThresholdPercent: 80
containerLogMaxSize: "50Mi"
containerLogMaxFiles: 5

# Eviction thresholds
evictionHard:
  memory.available: "200Mi"
  nodefs.available: "10%"
  imagefs.available: "15%"
evictionSoft:
  memory.available: "500Mi"
  nodefs.available: "15%"
evictionSoftGracePeriod:
  memory.available: "1m30s"
  nodefs.available: "1m30s"

# Resource management
systemReserved:
  cpu: "200m"
  memory: "512Mi"
  ephemeral-storage: "2Gi"
kubeReserved:
  cpu: "200m"
  memory: "512Mi"
  ephemeral-storage: "2Gi"

# Performance settings
serializeImagePulls: false
maxParallelImagePulls: 5
cpuManagerPolicy: "static"
topologyManagerPolicy: "best-effort"

# Health checks
nodeStatusUpdateFrequency: "10s"
nodeStatusReportFrequency: "5m"
syncFrequency: "1m"
fileCheckFrequency: "20s"
httpCheckFrequency: "20s"

# Logging
logging:
  format: json
  verbosity: 2
KUBELET_EOF

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ kubelet
systemctl restart kubelet

if systemctl is-active --quiet kubelet; then
    echo "‚úÖ kubelet –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ kubelet"
    systemctl status kubelet
fi
EOF

chmod +x kubelet-optimizer.sh
```

### **3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è containerd:**
```bash
# –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç containerd-optimizer.sh
cat << 'EOF' > containerd-optimizer.sh
#!/bin/bash

echo "üê≥ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è containerd"
echo "========================"

# –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ containerd
mkdir -p /etc/containerd
cat > /etc/containerd/config.toml << 'CONTAINERD_EOF'
version = 2

[plugins]
  [plugins."io.containerd.grpc.v1.cri"]
    # Performance settings
    max_concurrent_downloads = 10
    max_container_log_line_size = 16384
    
    [plugins."io.containerd.grpc.v1.cri".containerd]
      default_runtime_name = "runc"
      
      [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
        runtime_type = "io.containerd.runc.v2"
        
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
          SystemdCgroup = true
          
    [plugins."io.containerd.grpc.v1.cri".registry]
      [plugins."io.containerd.grpc.v1.cri".registry.mirrors]
        [plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]
          endpoint = ["https://registry-1.docker.io"]
          
  [plugins."io.containerd.snapshotter.v1.overlayfs"]
    root_path = "/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs"
    
[metrics]
  address = "127.0.0.1:1338"
  grpc_histogram = false
CONTAINERD_EOF

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ containerd
systemctl restart containerd

if systemctl is-active --quiet containerd; then
    echo "‚úÖ containerd –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ containerd"
    systemctl status containerd
fi
EOF

chmod +x containerd-optimizer.sh
```

## üîß **–°–∫—Ä–∏–ø—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —É–∑–ª–∞:**

### **1. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞:**
```bash
# –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç node-diagnostics.sh
cat << 'EOF' > node-diagnostics.sh
#!/bin/bash

echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —É–∑–ª–∞ Kubernetes"
echo "=============================="

NODE_NAME=$(hostname)
echo "–£–∑–µ–ª: $NODE_NAME"

echo -e "\nüìä 1. –°–ò–°–¢–ï–ú–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:"
echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
echo "Kernel: $(uname -r)"
echo "Uptime: $(uptime -p)"

echo -e "\nüíª 2. –†–ï–°–£–†–°–´:"
echo "CPU: $(nproc) cores"
echo "Memory: $(free -h | grep Mem | awk '{print $2}')"
echo "Disk: $(df -h / | tail -1 | awk '{print $2 " total, " $3 " used, " $4 " available"}')"

echo -e "\nüîÑ 3. SWAP –°–¢–ê–¢–£–°:"
if [ $(swapon --show | wc -l) -eq 0 ]; then
    echo "‚úÖ Swap –æ—Ç–∫–ª—é—á–µ–Ω"
else
    echo "‚ùå Swap –≤–∫–ª—é—á–µ–Ω:"
    swapon --show
fi

echo -e "\n‚öôÔ∏è 4. KUBERNETES –ö–û–ú–ü–û–ù–ï–ù–¢–´:"
echo "kubelet: $(systemctl is-active kubelet)"
echo "containerd: $(systemctl is-active containerd)"

echo -e "\nüåê 5. –°–ï–¢–ï–í–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø:"
echo "–û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: $(ip route | grep default | awk '{print $5}' | head -1)"
echo "IP –∞–¥—Ä–µ—Å: $(ip route get 8.8.8.8 | grep -oP 'src \K\S+')"

echo -e "\nüì¶ 6. –ö–û–ù–¢–ï–ô–ù–ï–†–´ –ò –û–ë–†–ê–ó–´:"
echo "–ó–∞–ø—É—â–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: $(crictl ps -q | wc -l)"
echo "–û–±—Ä–∞–∑—ã: $(crictl images -q | wc -l)"

echo -e "\nüîß 7. –°–ò–°–¢–ï–ú–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´:"
echo "File descriptors limit: $(ulimit -n)"
echo "Max processes: $(ulimit -u)"
echo "VM swappiness: $(cat /proc/sys/vm/swappiness)"

echo -e "\nüìà 8. –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨:"
echo "Load average: $(uptime | awk -F'load average:' '{print $2}')"
echo "Memory usage: $(free | grep Mem | awk '{printf "%.1f%%", $3/$2 * 100.0}')"
echo "Disk usage: $(df / | tail -1 | awk '{print $5}')"

echo -e "\nüîç 9. KUBERNETES –°–¢–ê–¢–£–°:"
if command -v kubectl &> /dev/null; then
    echo "Node status: $(kubectl get node $NODE_NAME -o jsonpath='{.status.conditions[-1].type}:{.status.conditions[-1].status}' 2>/dev/null || echo 'N/A')"
    echo "Pods on node: $(kubectl get pods --all-namespaces --field-selector spec.nodeName=$NODE_NAME 2>/dev/null | wc -l || echo 'N/A')"
fi

echo -e "\n‚ö†Ô∏è 10. –ü–†–û–ë–õ–ï–ú–´:"
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—â–∏—Ö –ø—Ä–æ–±–ª–µ–º
issues=0

if [ $(swapon --show | wc -l) -gt 0 ]; then
    echo "‚ùå Swap –≤–∫–ª—é—á–µ–Ω (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω)"
    ((issues++))
fi

if [ $(cat /proc/sys/vm/swappiness) -gt 10 ]; then
    echo "‚ö†Ô∏è vm.swappiness —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π: $(cat /proc/sys/vm/swappiness)"
    ((issues++))
fi

if [ $(ulimit -n) -lt 65536 ]; then
    echo "‚ö†Ô∏è –õ–∏–º–∏—Ç —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤ –Ω–∏–∑–∫–∏–π: $(ulimit -n)"
    ((issues++))
fi

if ! systemctl is-active --quiet kubelet; then
    echo "‚ùå kubelet –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω"
    ((issues++))
fi

if ! systemctl is-active --quiet containerd; then
    echo "‚ùå containerd –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω"
    ((issues++))
fi

if [ $issues -eq 0 ]; then
    echo "‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
fi

echo -e "\n‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
EOF

chmod +x node-diagnostics.sh
```

### **2. –ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:**
```bash
# –í—ã–ø–æ–ª–Ω–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
./node-diagnostics.sh

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç
./node-diagnostics.sh > node-diagnostics-$(hostname)-$(date +%Y%m%d-%H%M%S).txt
```

## üìä **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —É–∑–ª–æ–≤:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Node Optimization Stack                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Application Layer                                          ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Pods (Resource requests/limits)                       ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ QoS Classes (Guaranteed, Burstable, BestEffort)       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Workload Distribution (Anti-affinity, Taints)         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Kubernetes Layer                                           ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ kubelet (CPU manager, Topology manager)               ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ kube-proxy (iptables/ipvs optimization)               ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Container Runtime (containerd/docker)                 ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ CNI Plugin (Calico, Flannel, etc.)                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Operating System Layer                                     ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Kernel (sysctl parameters, cgroups)                   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Network Stack (iptables, netfilter)                   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Storage (filesystem, I/O scheduler)                   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Memory Management (swap, huge pages)                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Hardware Layer                                             ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ CPU (cores, frequency, cache)                         ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Memory (RAM, bandwidth)                               ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Storage (SSD, IOPS, latency)                          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Network (bandwidth, latency)                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üö® **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É–∑–ª–æ–≤ –≤ HA –∫–ª–∞—Å—Ç–µ—Ä–µ:**

### **1. Prometheus –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —É–∑–ª–æ–≤:**
```bash
# –î–æ—Å—Ç—É–ø –∫ Prometheus –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–µ—Ç—Ä–∏–∫ —É–∑–ª–æ–≤
kubectl port-forward svc/prometheus-server -n monitoring 9090:80 &

# –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —É–∑–ª–æ–≤:
# node_cpu_seconds_total - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU
# node_memory_MemAvailable_bytes - –¥–æ—Å—Ç—É–ø–Ω–∞—è –ø–∞–º—è—Ç—å
# node_filesystem_avail_bytes - –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ
# node_network_receive_bytes_total - —Å–µ—Ç–µ–≤–æ–π —Ç—Ä–∞—Ñ–∏–∫
# node_load1, node_load5, node_load15 - –∑–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã
```

### **2. –ê–ª–µ—Ä—Ç—ã –¥–ª—è —É–∑–ª–æ–≤:**
```yaml
# node-alerts.yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: node-performance-alerts
  namespace: monitoring
spec:
  groups:
  - name: node-performance
    rules:
    - alert: NodeHighCPUUsage
      expr: 100 - (avg(irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Node CPU usage is high"
        description: "Node {{ $labels.instance }} CPU usage is {{ $value }}%"
    
    - alert: NodeHighMemoryUsage
      expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Node memory usage is high"
        description: "Node {{ $labels.instance }} memory usage is {{ $value }}%"
    
    - alert: NodeDiskSpaceLow
      expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 85
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Node disk space is low"
        description: "Node {{ $labels.instance }} disk usage is {{ $value }}%"
    
    - alert: NodeHighLoadAverage
      expr: node_load15 > (count(node_cpu_seconds_total{mode="idle"}) by (instance)) * 1.5
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "Node load average is high"
        description: "Node {{ $labels.instance }} load average is {{ $value }}"
```

## üè≠ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É–∑–ª–æ–≤ –≤ –≤–∞—à–µ–º HA –∫–ª–∞—Å—Ç–µ—Ä–µ:**

### **1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–∑–ª–æ–≤:**
```bash
# –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —É–∑–ª–æ–≤
kubectl get nodes -o wide

# –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–∂–¥–æ–º —É–∑–ª–µ
for node in $(kubectl get nodes -o jsonpath='{.items[*].metadata.name}'); do
    echo "=== Node: $node ==="
    kubectl describe node $node | grep -A 10 "Conditions:\|Capacity:\|Allocatable:"
done

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ —É–∑–ª–∞–º
kubectl top nodes
```

### **2. –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–¥–æ–≤:**
```bash
# –ü–æ–¥—ã –Ω–∞ –∫–∞–∂–¥–æ–º —É–∑–ª–µ
for node in $(kubectl get nodes -o jsonpath='{.items[*].metadata.name}'); do
    echo "=== Node: $node ==="
    kubectl get pods --all-namespaces --field-selector spec.nodeName=$node -o custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name,CPU-REQ:.spec.containers[*].resources.requests.cpu,MEM-REQ:.spec.containers[*].resources.requests.memory
done
```

### **3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ Grafana:**
```bash
# –î–æ—Å—Ç—É–ø –∫ Grafana –¥–ª—è –¥–∞—à–±–æ—Ä–¥–æ–≤ —É–∑–ª–æ–≤
kubectl port-forward svc/grafana -n monitoring 3000:80 &

# –ò–º–ø–æ—Ä—Ç –¥–∞—à–±–æ—Ä–¥–∞ Node Exporter (ID: 1860)
# –ò–º–ø–æ—Ä—Ç –¥–∞—à–±–æ—Ä–¥–∞ Kubernetes Cluster Monitoring (ID: 315)
```

## üéØ **Best Practices –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —É–∑–ª–æ–≤:**

### **1. –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:**
- –û—Ç–∫–ª—é—á–∏—Ç–µ swap –ø–æ–ª–Ω–æ—Å—Ç—å—é (`swapoff -a`)
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ sysctl –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è Kubernetes
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ noatime –¥–ª—è —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º
- –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ I/O scheduler –¥–ª—è SSD –¥–∏—Å–∫–æ–≤
- –£–≤–µ–ª–∏—á—å—Ç–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ª–∏–º–∏—Ç—ã (ulimit)

### **2. Kubelet –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ resource reservations –¥–ª—è —Å–∏—Å—Ç–µ–º—ã
- –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ garbage collection
- –í–∫–ª—é—á–∏—Ç–µ CPU manager –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ eviction thresholds
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π pull –æ–±—Ä–∞–∑–æ–≤

### **3. Container Runtime:**
- –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ containerd/docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ storage driver (overlay2)
- –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ —Ä–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ registry mirrors –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ pull
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ concurrent downloads

### **4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ:**
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ node-exporter –¥–ª—è –º–µ—Ç—Ä–∏–∫
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏
- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É–∑–ª–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É–∑–ª–æ–≤ ‚Äî –æ—Å–Ω–æ–≤–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–∞!**
