# 156. –ö–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç–µ–≤—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å?

## üéØ –í–æ–ø—Ä–æ—Å
–ö–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç–µ–≤—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å?

## üí° –û—Ç–≤–µ—Ç

–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–µ—Ç–µ–≤–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ Kubernetes –≤–∫–ª—é—á–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É CNI, kube-proxy, DNS, –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–æ–≤ –Ω–∞–≥—Ä—É–∑–∫–∏ –∏ —Å–µ—Ç–µ–≤—ã—Ö –ø–æ–ª–∏—Ç–∏–∫ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏.

### üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ç–µ–≤–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### 1. **–°—Ö–µ–º–∞ —Å–µ—Ç–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                Network Performance Stack                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ     CNI     ‚îÇ  ‚îÇ kube-proxy  ‚îÇ  ‚îÇ    DNS      ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  (Calico)   ‚îÇ  ‚îÇ  (iptables) ‚îÇ  ‚îÇ (CoreDNS)   ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ   Ingress   ‚îÇ  ‚îÇ   Service   ‚îÇ  ‚îÇ  Network    ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ    NGINX    ‚îÇ  ‚îÇ LoadBalancer‚îÇ  ‚îÇ  Policies   ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### 2. **–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
```yaml
# –°–µ—Ç–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
network_performance_metrics:
  latency_metrics:
    - "container_network_receive_packets_total"
    - "container_network_transmit_packets_total"
    - "node_network_receive_bytes_total"
    - "node_network_transmit_bytes_total"
  
  throughput_metrics:
    - "rate(container_network_receive_bytes_total[5m])"
    - "rate(container_network_transmit_bytes_total[5m])"
    - "nginx_ingress_controller_request_duration_seconds"
    - "coredns_dns_request_duration_seconds"
  
  error_metrics:
    - "container_network_receive_errors_total"
    - "container_network_transmit_errors_total"
    - "coredns_dns_request_count_total"
    - "nginx_ingress_controller_requests"
```

### üìä –ü—Ä–∏–º–µ—Ä—ã –∏–∑ –Ω–∞—à–µ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
```bash
# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö
kubectl get nodes -o wide

# –ü—Ä–æ–≤–µ—Ä–∫–∞ CNI –ø–æ–¥–æ–≤
kubectl get pods -n kube-system | grep calico

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Ç–µ–≤–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞
kubectl top pods --all-namespaces --sort-by=memory
```

### üåê –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è CNI

#### 1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Calico –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
```yaml
# calico-performance-config.yaml
apiVersion: operator.tigera.io/v1
kind: Installation
metadata:
  name: default
spec:
  calicoNetwork:
    # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    mtu: 1500                             # –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π MTU
    nodeAddressAutodetectionV4:
      interface: "eth0"                   # –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    ipPools:
    - blockSize: 26                       # –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –±–ª–æ–∫–∞
      cidr: 10.244.0.0/16
      encapsulation: VXLAN                # VXLAN –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      natOutgoing: Enabled
      nodeSelector: all()
  
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  nodeMetricsPort: 9091
  typhaMetricsPort: 9093
  
  # –†–µ—Å—É—Ä—Å—ã –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
  calicoNodeDaemonSet:
    spec:
      template:
        spec:
          containers:
          - name: calico-node
            resources:
              requests:
                cpu: 250m
                memory: 512Mi
              limits:
                cpu: 500m
                memory: 1Gi
---
# Felix –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
apiVersion: projectcalico.org/v3
kind: FelixConfiguration
metadata:
  name: default
spec:
  # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  bpfLogLevel: "Off"                      # –û—Ç–∫–ª—é—á–µ–Ω–∏–µ BPF –ª–æ–≥–æ–≤
  chainInsertMode: "Insert"               # –ë—ã—Å—Ç—Ä–∞—è –≤—Å—Ç–∞–≤–∫–∞ –ø—Ä–∞–≤–∏–ª
  dataplaneDriver: "iptables"             # –î—Ä–∞–π–≤–µ—Ä dataplane
  defaultEndpointToHostAction: "ACCEPT"   # –î–µ–π—Å—Ç–≤–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  deviceRouteSourceAddress: "Use"         # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ source address
  iptablesBackend: "Auto"                 # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π backend
  iptablesLockTimeout: "10s"              # –¢–∞–π–º–∞—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
  iptablesPostWriteCheckInterval: "1s"    # –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏
  iptablesRefreshInterval: "60s"          # –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  logSeverityScreen: "Info"               # –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
  prometheusMetricsEnabled: true          # –ú–µ—Ç—Ä–∏–∫–∏ Prometheus
  reportingInterval: "30s"                # –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏
  
  # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
  routeRefreshInterval: "90s"             # –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
  routeTableRange: "1-250"                # –î–∏–∞–ø–∞–∑–æ–Ω —Ç–∞–±–ª–∏—Ü –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
```

#### 2. **–°–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ CNI**
```bash
#!/bin/bash
# cni-optimization.sh

echo "üåê –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è CNI –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ MTU
echo "üìä –¢–µ–∫—É—â–∏–π MTU:"
kubectl get nodes -o jsonpath='{.items[*].status.addresses[?(@.type=="InternalIP")].address}' | \
xargs -I {} sh -c 'echo "Node {}: $(ip link show | grep mtu | head -1)"'

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Calico Felix
echo "üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π Felix..."
kubectl patch felixconfiguration default --patch='
spec:
  bpfLogLevel: "Off"
  chainInsertMode: "Insert"
  iptablesRefreshInterval: "60s"
  reportingInterval: "30s"
  routeRefreshInterval: "90s"
'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Calico
echo "‚úÖ –°—Ç–∞—Ç—É—Å Calico –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:"
kubectl get pods -n calico-system -o wide

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–µ—Ç–∏
echo "üìà –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–µ–≤–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏..."
kubectl run netperf-client --image=networkstatic/netperf --rm -it -- netperf -H calico-node-service

echo "‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è CNI –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
```

### ‚öñÔ∏è –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è kube-proxy

#### 1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ kube-proxy –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
```yaml
# kube-proxy-performance-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: kube-proxy
  namespace: kube-system
data:
  config.conf: |
    apiVersion: kubeproxy.config.k8s.io/v1alpha1
    kind: KubeProxyConfiguration
    # –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
    mode: "iptables"                      # iptables –∏–ª–∏ ipvs
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ iptables
    iptables:
      masqueradeAll: false                # –ù–µ –º–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫
      masqueradeBit: 14                   # –ë–∏—Ç –¥–ª—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏
      minSyncPeriod: 1s                   # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      syncPeriod: 30s                     # –ü–µ—Ä–∏–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ IPVS (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
    ipvs:
      minSyncPeriod: 5s                   # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è IPVS
      syncPeriod: 30s                     # –ü–µ—Ä–∏–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ IPVS
      scheduler: "rr"                     # Round-robin –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
      excludeCIDRs: []                    # –ò—Å–∫–ª—é—á–µ–Ω–Ω—ã–µ CIDR
      strictARP: false                    # –°—Ç—Ä–æ–≥–∏–π ARP
    
    # –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    clusterCIDR: "10.244.0.0/16"          # CIDR –∫–ª–∞—Å—Ç–µ—Ä–∞
    hostnameOverride: ""                  # –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ hostname
    bindAddress: "0.0.0.0"                # –ê–¥—Ä–µ—Å –ø—Ä–∏–≤—è–∑–∫–∏
    healthzBindAddress: "0.0.0.0:10256"   # –ê–¥—Ä–µ—Å healthz
    metricsBindAddress: "127.0.0.1:10249" # –ê–¥—Ä–µ—Å –º–µ—Ç—Ä–∏–∫
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    oomScoreAdj: -999                     # OOM score adjustment
    resourceContainer: "/kube-proxy"      # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤
    udpIdleTimeout: 250ms                 # –¢–∞–π–º–∞—É—Ç UDP
    conntrack:
      maxPerCore: 32768                   # –ú–∞–∫—Å–∏–º—É–º conntrack –Ω–∞ —è–¥—Ä–æ
      min: 131072                         # –ú–∏–Ω–∏–º—É–º conntrack
      tcpEstablishedTimeout: 86400s       # –¢–∞–π–º–∞—É—Ç TCP established
      tcpCloseWaitTimeout: 3600s          # –¢–∞–π–º–∞—É—Ç TCP close wait
```

#### 2. **–°–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ kube-proxy**
```bash
#!/bin/bash
# kube-proxy-optimization.sh

echo "‚öñÔ∏è –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è kube-proxy"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞ kube-proxy
echo "üìä –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º kube-proxy:"
kubectl get configmap kube-proxy -n kube-system -o yaml | grep mode

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
echo "üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π..."
kubectl patch configmap kube-proxy -n kube-system --patch='
data:
  config.conf: |
    apiVersion: kubeproxy.config.k8s.io/v1alpha1
    kind: KubeProxyConfiguration
    mode: "iptables"
    iptables:
      masqueradeAll: false
      masqueradeBit: 14
      minSyncPeriod: 1s
      syncPeriod: 30s
    clusterCIDR: "10.244.0.0/16"
    oomScoreAdj: -999
    udpIdleTimeout: 250ms
    conntrack:
      maxPerCore: 32768
      min: 131072
'

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ kube-proxy –ø–æ–¥–æ–≤
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ kube-proxy..."
kubectl rollout restart daemonset kube-proxy -n kube-system

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "‚úÖ –°—Ç–∞—Ç—É—Å kube-proxy:"
kubectl get pods -n kube-system -l k8s-app=kube-proxy

echo "‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è kube-proxy –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
```

### üîç –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è DNS

#### 1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ CoreDNS –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
```yaml
# coredns-performance-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
data:
  Corefile: |
    .:53 {
        errors
        health {
            lameduck 5s
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
            pods insecure
            fallthrough in-addr.arpa ip6.arpa
            ttl 30                        # TTL –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
        }
        prometheus :9153
        forward . /etc/resolv.conf {
            max_concurrent 1000           # –ú–∞–∫—Å–∏–º—É–º concurrent –∑–∞–ø—Ä–æ—Å–æ–≤
        }
        cache 30 {                        # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 30 —Å–µ–∫—É–Ω–¥
            success 9984 30               # –ö—ç—à —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            denial 9984 5                 # –ö—ç—à –æ—Ç–∫–∞–∑–æ–≤
        }
        loop
        reload
        loadbalance                       # –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏
    }
---
# Deployment CoreDNS —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coredns
  namespace: kube-system
spec:
  replicas: 3                             # –£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–ø–ª–∏–∫
  selector:
    matchLabels:
      k8s-app: kube-dns
  template:
    metadata:
      labels:
        k8s-app: kube-dns
    spec:
      containers:
      - name: coredns
        image: coredns/coredns:1.10.1
        resources:
          requests:
            cpu: 100m
            memory: 70Mi
          limits:
            cpu: 200m                     # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã CPU
            memory: 170Mi                 # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã –ø–∞–º—è—Ç–∏
        args: [ "-conf", "/etc/coredns/Corefile" ]
        ports:
        - containerPort: 53
          name: dns
          protocol: UDP
        - containerPort: 53
          name: dns-tcp
          protocol: TCP
        - containerPort: 9153
          name: metrics
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 60
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 5
        readinessProbe:
          httpGet:
            path: /ready
            port: 8181
            scheme: HTTP
          initialDelaySeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 3
```

#### 2. **–°–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ DNS**
```bash
#!/bin/bash
# dns-optimization.sh

echo "üîç –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è DNS –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ CoreDNS
echo "üìä –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è CoreDNS:"
kubectl get configmap coredns -n kube-system -o yaml | grep -A 20 Corefile

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
echo "üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ DNS –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π..."
kubectl patch configmap coredns -n kube-system --patch='
data:
  Corefile: |
    .:53 {
        errors
        health {
            lameduck 5s
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
            pods insecure
            fallthrough in-addr.arpa ip6.arpa
            ttl 30
        }
        prometheus :9153
        forward . /etc/resolv.conf {
            max_concurrent 1000
        }
        cache 30 {
            success 9984 30
            denial 9984 5
        }
        loop
        reload
        loadbalance
    }
'

# –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ CoreDNS
echo "üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ CoreDNS..."
kubectl scale deployment coredns -n kube-system --replicas=3

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ DNS –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ DNS..."
kubectl run dns-test --image=busybox --rm -it -- nslookup kubernetes.default.svc.cluster.local

echo "‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è DNS –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
```

### üö™ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Ingress

#### 1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ NGINX Ingress –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
```yaml
# nginx-ingress-performance.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-configuration
  namespace: ingress-nginx
data:
  # –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  worker-processes: "auto"                # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
  worker-connections: "16384"             # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  worker-rlimit-nofile: "65536"           # –õ–∏–º–∏—Ç —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
  
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏
  proxy-buffer-size: "16k"                # –†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ proxy
  proxy-buffers-number: "8"               # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—É—Ñ–µ—Ä–æ–≤
  proxy-busy-buffers-size: "64k"          # –†–∞–∑–º–µ—Ä busy –±—É—Ñ–µ—Ä–æ–≤
  
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–π–º–∞—É—Ç–æ–≤
  proxy-connect-timeout: "5"              # –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  proxy-send-timeout: "60"                # –¢–∞–π–º–∞—É—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏
  proxy-read-timeout: "60"                # –¢–∞–π–º–∞—É—Ç —á—Ç–µ–Ω–∏—è
  
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ keep-alive
  upstream-keepalive-connections: "100"   # Keep-alive —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  upstream-keepalive-requests: "1000"     # Keep-alive –∑–∞–ø—Ä–æ—Å—ã
  upstream-keepalive-timeout: "60"        # Keep-alive —Ç–∞–π–º–∞—É—Ç
  
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∂–∞—Ç–∏—è
  enable-gzip: "true"                     # –í–∫–ª—é—á–µ–Ω–∏–µ gzip
  gzip-level: "6"                         # –£—Ä–æ–≤–µ–Ω—å —Å–∂–∞—Ç–∏—è
  gzip-types: "text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript"
  
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ SSL
  ssl-protocols: "TLSv1.2 TLSv1.3"       # –ü—Ä–æ—Ç–æ–∫–æ–ª—ã SSL
  ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
  ssl-session-cache: "shared:SSL:10m"     # –ö—ç—à SSL —Å–µ—Å—Å–∏–π
  ssl-session-timeout: "10m"              # –¢–∞–π–º–∞—É—Ç SSL —Å–µ—Å—Å–∏–π
  
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
  access-log-path: "/var/log/nginx/access.log"
  error-log-path: "/var/log/nginx/error.log"
  log-format-upstream: '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" $request_length $request_time [$proxy_upstream_name] [$proxy_alternative_upstream_name] $upstream_addr $upstream_response_length $upstream_response_time $upstream_status $req_id'
---
# Deployment NGINX Ingress —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-ingress-controller
  namespace: ingress-nginx
spec:
  replicas: 3                             # –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–µ–ø–ª–∏–∫–∏
  selector:
    matchLabels:
      app.kubernetes.io/name: ingress-nginx
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ingress-nginx
    spec:
      containers:
      - name: controller
        image: k8s.gcr.io/ingress-nginx/controller:v1.8.1
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 500m                     # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã
            memory: 512Mi
        args:
        - /nginx-ingress-controller
        - --configmap=$(POD_NAMESPACE)/nginx-configuration
        - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services
        - --udp-services-configmap=$(POD_NAMESPACE)/udp-services
        - --publish-service=$(POD_NAMESPACE)/ingress-nginx
        - --annotations-prefix=nginx.ingress.kubernetes.io
        - --enable-ssl-passthrough
        - --default-backend-service=$(POD_NAMESPACE)/default-http-backend
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        ports:
        - name: http
          containerPort: 80
        - name: https
          containerPort: 443
        - name: metrics
          containerPort: 10254
```

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ç–µ–≤–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### 1. **Prometheus –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —Å–µ—Ç–∏**
```yaml
# network-monitoring.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: network-performance
spec:
  selector:
    matchLabels:
      app: network-monitoring
  endpoints:
  - port: metrics
    interval: 15s
    path: /metrics
---
# –ö–ª—é—á–µ–≤—ã–µ —Å–µ—Ç–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
network_key_metrics:
  bandwidth:
    - "rate(container_network_receive_bytes_total[5m])"
    - "rate(container_network_transmit_bytes_total[5m])"
    - "rate(node_network_receive_bytes_total[5m])"
    - "rate(node_network_transmit_bytes_total[5m])"
  
  latency:
    - "histogram_quantile(0.95, nginx_ingress_controller_request_duration_seconds_bucket)"
    - "histogram_quantile(0.95, coredns_dns_request_duration_seconds_bucket)"
    - "histogram_quantile(0.95, prometheus_rule_evaluation_duration_seconds_bucket)"
  
  errors:
    - "rate(container_network_receive_errors_total[5m])"
    - "rate(container_network_transmit_errors_total[5m])"
    - "rate(coredns_dns_request_count_total{rcode!=\"NOERROR\"}[5m])"
    - "rate(nginx_ingress_controller_requests{status=~\"5..\"}[5m])"
```

#### 2. **–°–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–µ—Ç–∏**
```bash
#!/bin/bash
# network-performance-monitoring.sh

echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ç–µ–≤–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
echo "üåê –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–µ—Ç–∏:"
kubectl top nodes --sort-by=memory

# –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
echo -e "\nüîç –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å DNS:"
kubectl get pods -n kube-system -l k8s-app=kube-dns -o wide

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Ingress –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
echo -e "\nüö™ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å Ingress:"
kubectl get pods -n ingress-nginx -o wide

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–µ–≤–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
echo -e "\n‚è±Ô∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏:"
kubectl run nettest --image=busybox --rm -it -- ping -c 3 8.8.8.8

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –ø–æ–ª–∏—Ç–∏–∫
echo -e "\nüõ°Ô∏è –°–µ—Ç–µ–≤—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏:"
kubectl get networkpolicies --all-namespaces

echo "‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω"
```

### üéØ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

#### 1. **–ß–µ–∫-–ª–∏—Å—Ç —Å–µ—Ç–µ–≤–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**
```yaml
network_optimization_checklist:
  cni:
    - "‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω MTU –¥–ª—è —Å–µ—Ç–∏"
    - "‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π encapsulation"
    - "‚úÖ Felix –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞"
    - "‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ CNI –º–µ—Ç—Ä–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
  
  kube_proxy:
    - "‚úÖ –í—ã–±—Ä–∞–Ω –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (iptables/ipvs)"
    - "‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –∏ –ø–µ—Ä–∏–æ–¥—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"
    - "‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã conntrack –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
    - "‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ kube-proxy –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
  
  dns:
    - "‚úÖ CoreDNS –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
    - "‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ DNS"
    - "‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã TTL –∑–Ω–∞—á–µ–Ω–∏—è"
    - "‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ DNS –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
  
  ingress:
    - "‚úÖ NGINX Ingress –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω"
    - "‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –∏ keep-alive"
    - "‚úÖ –í–∫–ª—é—á–µ–Ω–æ —Å–∂–∞—Ç–∏–µ gzip"
    - "‚úÖ SSL –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω"
  
  monitoring:
    - "‚úÖ –°–µ—Ç–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è"
    - "‚úÖ –ê–ª–µ—Ä—Ç—ã –Ω–∞ —Å–µ—Ç–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
    - "‚úÖ –î–∞—à–±–æ—Ä–¥—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω—ã"
    - "‚úÖ –†–µ–≥—É–ª—è—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
```

–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–µ—Ç–µ–≤–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±—ã—Å—Ç—Ä–æ–π –∏ –Ω–∞–¥–µ–∂–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –≤ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–µ.
