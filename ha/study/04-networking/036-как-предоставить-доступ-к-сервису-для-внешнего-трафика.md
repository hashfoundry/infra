# 36. –ö–∞–∫ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å—É –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞?

## üéØ **–°–ø–æ—Å–æ–±—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞**

–í Kubernetes —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞, –∫–∞–∂–¥—ã–π —Å —Å–≤–æ–∏–º–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏ –∏ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

## üèóÔ∏è **–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**

### **1. NodePort Service**
- –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ—Ä—Ç –Ω–∞ –≤—Å–µ—Ö Node'–∞—Ö
- –î–∏–∞–ø–∞–∑–æ–Ω –ø–æ—Ä—Ç–æ–≤: 30000-32767
- –ü—Ä–æ—Å—Ç–æ–π, –Ω–æ –Ω–µ production-ready

### **2. LoadBalancer Service**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç cloud provider LoadBalancer
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ External IP
- Production-ready —Ä–µ—à–µ–Ω–∏–µ

### **3. Ingress Controller**
- HTTP/HTTPS –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
- SSL/TLS termination
- –ù–∞–∏–±–æ–ª–µ–µ –≥–∏–±–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### **4. Port Forwarding**
- –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏
- –í—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø

## üìä **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –≤–∞—à–µ–≥–æ HA –∫–ª–∞—Å—Ç–µ—Ä–∞:**

### **1. NodePort –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞:**
```bash
# –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
cat << EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: external-web-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: external-web-app
  template:
    metadata:
      labels:
        app: external-web-app
    spec:
      containers:
      - name: web
        image: nginx
        ports:
        - containerPort: 80
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
      volumes:
      - name: html
        configMap:
          name: external-web-content
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: external-web-content
data:
  index.html: |
    <!DOCTYPE html>
    <html>
    <head><title>External Access Demo</title></head>
    <body>
      <h1>–í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ NodePort</h1>
      <p>–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –∏–∑–≤–Ω–µ –∫–ª–∞—Å—Ç–µ—Ä–∞</p>
      <p>Pod: <span id="hostname"></span></p>
      <script>
        fetch('/hostname').then(r => r.text()).then(h => 
          document.getElementById('hostname').textContent = h
        ).catch(() => 
          document.getElementById('hostname').textContent = window.location.hostname
        );
      </script>
    </body>
    </html>
---
apiVersion: v1
kind: Service
metadata:
  name: external-web-nodeport
spec:
  type: NodePort
  selector:
    app: external-web-app
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30080
EOF

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å NodePort Service
kubectl get service external-web-nodeport
kubectl describe service external-web-nodeport

# –ü–æ–ª—É—á–∏—Ç—å –≤–Ω–µ—à–Ω–∏–µ IP Node'–æ–≤
kubectl get nodes -o wide

# –î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ –ª—é–±–æ–π Node IP:30080
NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="ExternalIP")].address}')
echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: http://$NODE_IP:30080"

kubectl delete deployment external-web-app
kubectl delete service external-web-nodeport
kubectl delete configmap external-web-content
```

### **2. LoadBalancer Service –≤ Digital Ocean:**
```bash
# LoadBalancer Service —Å Digital Ocean –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è–º–∏
cat << EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loadbalancer-app
spec:
  replicas: 4
  selector:
    matchLabels:
      app: loadbalancer-app
  template:
    metadata:
      labels:
        app: loadbalancer-app
    spec:
      containers:
      - name: web
        image: nginx
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "64Mi"
            cpu: "250m"
          limits:
            memory: "128Mi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: loadbalancer-service
  annotations:
    # Digital Ocean LoadBalancer –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    service.beta.kubernetes.io/do-loadbalancer-name: "hashfoundry-external-lb"
    service.beta.kubernetes.io/do-loadbalancer-protocol: "http"
    service.beta.kubernetes.io/do-loadbalancer-algorithm: "round_robin"
    service.beta.kubernetes.io/do-loadbalancer-size-slug: "lb-small"
    service.beta.kubernetes.io/do-loadbalancer-healthcheck-path: "/"
    service.beta.kubernetes.io/do-loadbalancer-healthcheck-protocol: "http"
    service.beta.kubernetes.io/do-loadbalancer-healthcheck-port: "80"
spec:
  type: LoadBalancer
  selector:
    app: loadbalancer-app
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
EOF

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å LoadBalancer Service
kubectl get service loadbalancer-service
kubectl describe service loadbalancer-service

# –ñ–¥–µ–º –ø–æ–ª—É—á–µ–Ω–∏—è External IP (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç)
echo "–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è External IP..."
kubectl get service loadbalancer-service -w

# –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è External IP
EXTERNAL_IP=$(kubectl get service loadbalancer-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
echo "LoadBalancer –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://$EXTERNAL_IP"

kubectl delete deployment loadbalancer-app
kubectl delete service loadbalancer-service
```

### **3. Ingress –¥–ª—è HTTP/HTTPS –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Ingress Controller
kubectl get pods -n ingress-nginx
kubectl get service -n ingress-nginx

# –ï—Å–ª–∏ –Ω–µ—Ç Ingress Controller, —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
cat << EOF | kubectl apply -f -
# Frontend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend-app
  template:
    metadata:
      labels:
        app: frontend-app
    spec:
      containers:
      - name: web
        image: nginx
        ports:
        - containerPort: 80
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
      volumes:
      - name: html
        configMap:
          name: frontend-content
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-content
data:
  index.html: |
    <!DOCTYPE html>
    <html>
    <head><title>Frontend App</title></head>
    <body>
      <h1>Frontend Application</h1>
      <p>–î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ Ingress</p>
    </body>
    </html>
---
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
spec:
  selector:
    app: frontend-app
  ports:
  - port: 80
    targetPort: 80
---
# Backend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend-app
  template:
    metadata:
      labels:
        app: backend-app
    spec:
      containers:
      - name: web
        image: nginx
        ports:
        - containerPort: 80
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
      volumes:
      - name: html
        configMap:
          name: backend-content
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backend-content
data:
  index.html: |
    <!DOCTYPE html>
    <html>
    <head><title>Backend API</title></head>
    <body>
      <h1>Backend API</h1>
      <p>API endpoint —á–µ—Ä–µ–∑ Ingress</p>
    </body>
    </html>
---
apiVersion: v1
kind: Service
metadata:
  name: backend-service
spec:
  selector:
    app: backend-app
  ports:
  - port: 80
    targetPort: 80
---
# Ingress –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - host: myapp.local  # –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 80
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 80
EOF

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Ingress
kubectl get ingress app-ingress
kubectl describe ingress app-ingress

# –ü–æ–ª—É—á–∏—Ç—å IP Ingress Controller'–∞
INGRESS_IP=$(kubectl get service -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
echo "Ingress –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ IP: $INGRESS_IP"

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ curl (–µ—Å–ª–∏ –µ—Å—Ç—å Ingress Controller)
# curl -H "Host: myapp.local" http://$INGRESS_IP/
# curl -H "Host: myapp.local" http://$INGRESS_IP/api

kubectl delete deployment frontend-app backend-app
kubectl delete service frontend-service backend-service
kubectl delete configmap frontend-content backend-content
kubectl delete ingress app-ingress
```

## üîß **Port Forwarding –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:**

### **1. –õ–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ Pod'–∞–º:**
```bash
# –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
cat << EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dev-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dev-app
  template:
    metadata:
      labels:
        app: dev-app
    spec:
      containers:
      - name: web
        image: nginx
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: dev-service
spec:
  selector:
    app: dev-app
  ports:
  - port: 80
    targetPort: 80
EOF

# Port forwarding –∫ Service
kubectl port-forward service/dev-service 8080:80 &
PF_PID=$!

echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ: http://localhost:8080"
sleep 5

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
curl http://localhost:8080

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å port forwarding
kill $PF_PID

# Port forwarding –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É Pod'—É
POD_NAME=$(kubectl get pods -l app=dev-app -o jsonpath='{.items[0].metadata.name}')
kubectl port-forward pod/$POD_NAME 8081:80 &
PF_PID=$!

echo "Pod –¥–æ—Å—Ç—É–ø–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ: http://localhost:8081"
sleep 5
kill $PF_PID

kubectl delete deployment dev-app
kubectl delete service dev-service
```

### **2. Port forwarding –¥–ª—è debugging:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ Services –≤ ArgoCD
kubectl get services -n argocd

# Port forwarding –∫ ArgoCD UI
kubectl port-forward svc/argocd-server -n argocd 8080:80 &
ARGOCD_PF_PID=$!

echo "ArgoCD UI –¥–æ—Å—Ç—É–ø–µ–Ω: http://localhost:8080"

# Port forwarding –∫ Prometheus
kubectl port-forward svc/prometheus-server -n monitoring 9090:80 &
PROM_PF_PID=$!

echo "Prometheus –¥–æ—Å—Ç—É–ø–µ–Ω: http://localhost:9090"

# Port forwarding –∫ Grafana
kubectl port-forward svc/grafana -n monitoring 3000:80 &
GRAFANA_PF_PID=$!

echo "Grafana –¥–æ—Å—Ç—É–ø–µ–Ω: http://localhost:3000"

sleep 10

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ port forwarding
kill $ARGOCD_PF_PID $PROM_PF_PID $GRAFANA_PF_PID
```

## üè≠ **Production —Å—Ü–µ–Ω–∞—Ä–∏–∏:**

### **1. Multi-environment setup:**
```bash
# Production LoadBalancer
cat << EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prod-web-app
  labels:
    environment: production
spec:
  replicas: 5
  selector:
    matchLabels:
      app: prod-web-app
      environment: production
  template:
    metadata:
      labels:
        app: prod-web-app
        environment: production
    spec:
      containers:
      - name: web
        image: nginx:stable
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "128Mi"
            cpu: "500m"
          limits:
            memory: "256Mi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: prod-web-service
  annotations:
    service.beta.kubernetes.io/do-loadbalancer-name: "hashfoundry-prod-lb"
    service.beta.kubernetes.io/do-loadbalancer-protocol: "http"
    service.beta.kubernetes.io/do-loadbalancer-algorithm: "least_connections"
    service.beta.kubernetes.io/do-loadbalancer-size-slug: "lb-medium"
    service.beta.kubernetes.io/do-loadbalancer-healthcheck-path: "/health"
    service.beta.kubernetes.io/do-loadbalancer-healthcheck-protocol: "http"
    service.beta.kubernetes.io/do-loadbalancer-healthcheck-interval-seconds: "10"
    service.beta.kubernetes.io/do-loadbalancer-healthcheck-timeout-seconds: "5"
    service.beta.kubernetes.io/do-loadbalancer-healthcheck-unhealthy-threshold: "3"
    service.beta.kubernetes.io/do-loadbalancer-healthcheck-healthy-threshold: "2"
spec:
  type: LoadBalancer
  selector:
    app: prod-web-app
    environment: production
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
  sessionAffinity: None
  externalTrafficPolicy: Local  # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å source IP
EOF

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å production LoadBalancer
kubectl get service prod-web-service
kubectl describe service prod-web-service

kubectl delete deployment prod-web-app
kubectl delete service prod-web-service
```

### **2. Blue-Green deployment —Å –≤–Ω–µ—à–Ω–∏–º –¥–æ—Å—Ç—É–ø–æ–º:**
```bash
# Blue version
cat << EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-blue
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
      version: blue
  template:
    metadata:
      labels:
        app: myapp
        version: blue
    spec:
      containers:
      - name: web
        image: nginx
        ports:
        - containerPort: 80
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
      volumes:
      - name: html
        configMap:
          name: blue-content
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: blue-content
data:
  index.html: |
    <!DOCTYPE html>
    <html>
    <head><title>Blue Version</title></head>
    <body style="background-color: lightblue;">
      <h1>Blue Version</h1>
      <p>–¢–µ–∫—É—â–∞—è production –≤–µ—Ä—Å–∏—è</p>
    </body>
    </html>
---
# Green version
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-green
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
      version: green
  template:
    metadata:
      labels:
        app: myapp
        version: green
    spec:
      containers:
      - name: web
        image: nginx
        ports:
        - containerPort: 80
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
      volumes:
      - name: html
        configMap:
          name: green-content
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: green-content
data:
  index.html: |
    <!DOCTYPE html>
    <html>
    <head><title>Green Version</title></head>
    <body style="background-color: lightgreen;">
      <h1>Green Version</h1>
      <p>–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
    </body>
    </html>
---
# Service —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ Blue (production)
apiVersion: v1
kind: Service
metadata:
  name: myapp-service
spec:
  type: LoadBalancer
  selector:
    app: myapp
    version: blue  # Production traffic
  ports:
  - port: 80
    targetPort: 80
---
# Service –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Green
apiVersion: v1
kind: Service
metadata:
  name: myapp-green-test
spec:
  type: NodePort
  selector:
    app: myapp
    version: green  # Test traffic
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30090
EOF

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Blue-Green setup
kubectl get services
kubectl get deployments

# –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ Green (Blue-Green deployment)
kubectl patch service myapp-service -p '{"spec":{"selector":{"version":"green"}}}'

echo "–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ Green version"
kubectl get service myapp-service -o yaml | grep -A 5 selector

# –û—Ç–∫–∞—Ç –Ω–∞ Blue
kubectl patch service myapp-service -p '{"spec":{"selector":{"version":"blue"}}}'

kubectl delete deployment app-blue app-green
kubectl delete service myapp-service myapp-green-test
kubectl delete configmap blue-content green-content
```

## üö® **Troubleshooting –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞:**

### **1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ NodePort –ø—Ä–æ–±–ª–µ–º:**
```bash
# –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
cat << EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: troubleshoot-nodeport
spec:
  replicas: 2
  selector:
    matchLabels:
      app: troubleshoot-nodeport
  template:
    metadata:
      labels:
        app: troubleshoot-nodeport
    spec:
      containers:
      - name: web
        image: nginx
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: troubleshoot-nodeport-service
spec:
  type: NodePort
  selector:
    app: troubleshoot-nodeport
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30091
EOF

# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
echo "=== NodePort Troubleshooting ==="
kubectl get service troubleshoot-nodeport-service
kubectl get endpoints troubleshoot-nodeport-service
kubectl describe service troubleshoot-nodeport-service

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Node'—ã –∏ –∏—Ö IP
kubectl get nodes -o wide

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Pod'—ã
kubectl get pods -l app=troubleshoot-nodeport -o wide

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="ExternalIP")].address}')
echo "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ $NODE_IP:30091"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å firewall –ø—Ä–∞–≤–∏–ª–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ Node'–∞–º)
# sudo iptables -L | grep 30091

kubectl delete deployment troubleshoot-nodeport
kubectl delete service troubleshoot-nodeport-service
```

### **2. LoadBalancer –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å LoadBalancer Services
kubectl get services --field-selector spec.type=LoadBalancer -A

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–±—ã—Ç–∏—è
kubectl get events --field-selector type=Warning

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ Digital Ocean
kubectl get service -o yaml | grep -A 10 annotations

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å LoadBalancer
kubectl describe service <loadbalancer-service-name>
```

### **3. Connectivity —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
# –°–æ–∑–¥–∞—Ç—å debug Pod –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
kubectl run network-debug --image=nicolaka/netshoot -it --rm -- bash

# –í–Ω—É—Ç—Ä–∏ debug Pod'–∞:
# curl <service-name>.<namespace>.svc.cluster.local
# nslookup <service-name>.<namespace>.svc.cluster.local
# telnet <external-ip> <port>
```

## üéØ **Best Practices –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞:**

### **1. –í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –¥–æ—Å—Ç—É–ø–∞:**
- **Development**: Port forwarding
- **Testing**: NodePort
- **Staging**: LoadBalancer
- **Production**: Ingress + LoadBalancer

### **2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
```yaml
# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ source IP –¥–ª—è LoadBalancer
apiVersion: v1
kind: Service
metadata:
  name: secure-service
  annotations:
    service.beta.kubernetes.io/load-balancer-source-ranges: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
spec:
  type: LoadBalancer
  # ...
```

### **3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞:**
```bash
# –ú–µ—Ç—Ä–∏–∫–∏ –≤ Prometheus:
# nginx_ingress_controller_requests - Ingress requests
# kube_service_info - Service information
# node_network_receive_bytes_total - Network traffic

# Health checks –¥–ª—è LoadBalancer
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ Digital Ocean
```

### **4. Cost optimization:**
```bash
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω LoadBalancer –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö Services —á–µ—Ä–µ–∑ Ingress
# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä LoadBalancer
# –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
```

**–í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –±—é–¥–∂–µ—Ç—É –ø—Ä–æ–µ–∫—Ç–∞!**
