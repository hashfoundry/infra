# 111. –ö–∞–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Pod, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

## üéØ **–ö–∞–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Pod, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è**

**Pod troubleshooting** - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –Ω–∞–≤—ã–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Kubernetes. –ü–æ–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω –∏ –º–µ—Ç–æ–¥–æ–≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø–æ–º–æ–≥–∞–µ—Ç –±—ã—Å—Ç—Ä–æ —Ä–µ—à–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –≤ production —Å—Ä–µ–¥–µ.

## üîç **–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º —Å Pod:**

### **1. Image Issues:**
- **ImagePullBackOff** - –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –æ–±—Ä–∞–∑–∞
- **ErrImagePull** - –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ registry
- **Invalid image name** - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –æ–±—Ä–∞–∑–∞

### **2. Resource Issues:**
- **Insufficient resources** - –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ CPU/Memory
- **Resource limits** - –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤
- **Node capacity** - –Ω–µ—Ö–≤–∞—Ç–∫–∞ –º–µ—Å—Ç–∞ –Ω–∞ —É–∑–ª–∞—Ö

### **3. Configuration Issues:**
- **Invalid YAML** - —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
- **Missing secrets/configmaps** - –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã
- **Wrong environment variables** - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

## üìä **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –≤–∞—à–µ–≥–æ HA –∫–ª–∞—Å—Ç–µ—Ä–∞:**

```bash
# –°–æ–∑–¥–∞—Ç—å comprehensive pod troubleshooting toolkit
cat << 'EOF' > pod-troubleshooting-toolkit.sh
#!/bin/bash

echo "=== Pod Troubleshooting Toolkit ==="
echo "Comprehensive guide for diagnosing pod issues in HashFoundry HA cluster"
echo

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ pod
quick_pod_diagnosis() {
    local POD_NAME=$1
    local NAMESPACE=${2:-default}
    
    if [ -z "$POD_NAME" ]; then
        echo "Usage: quick_pod_diagnosis <pod-name> [namespace]"
        return 1
    fi
    
    echo "=== Quick Pod Diagnosis: $NAMESPACE/$POD_NAME ==="
    echo
    
    echo "1. Pod Status:"
    kubectl get pod $POD_NAME -n $NAMESPACE -o wide
    echo
    
    echo "2. Pod Phase and Conditions:"
    kubectl get pod $POD_NAME -n $NAMESPACE -o jsonpath='{.status.phase}' && echo
    kubectl get pod $POD_NAME -n $NAMESPACE -o jsonpath='{.status.conditions[*].type}' && echo
    echo
    
    echo "3. Container States:"
    kubectl get pod $POD_NAME -n $NAMESPACE -o jsonpath='{.status.containerStatuses[*].state}' | jq '.' 2>/dev/null || echo "jq not available"
    echo
    
    echo "4. Recent Events:"
    kubectl get events -n $NAMESPACE --field-selector involvedObject.name=$POD_NAME --sort-by='.lastTimestamp' | tail -10
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
detailed_pod_diagnosis() {
    local POD_NAME=$1
    local NAMESPACE=${2:-default}
    
    if [ -z "$POD_NAME" ]; then
        echo "Usage: detailed_pod_diagnosis <pod-name> [namespace]"
        return 1
    fi
    
    echo "=== Detailed Pod Diagnosis: $NAMESPACE/$POD_NAME ==="
    echo
    
    echo "1. Full Pod Description:"
    kubectl describe pod $POD_NAME -n $NAMESPACE
    echo
    
    echo "2. Pod YAML Configuration:"
    kubectl get pod $POD_NAME -n $NAMESPACE -o yaml
    echo
    
    echo "3. Node Information:"
    NODE_NAME=$(kubectl get pod $POD_NAME -n $NAMESPACE -o jsonpath='{.spec.nodeName}')
    if [ ! -z "$NODE_NAME" ]; then
        echo "Pod is scheduled on node: $NODE_NAME"
        kubectl describe node $NODE_NAME | head -20
    else
        echo "Pod is not scheduled on any node"
    fi
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å –æ–±—Ä–∞–∑–∞–º–∏
diagnose_image_issues() {
    echo "=== Image Issues Diagnosis ==="
    
    echo "1. Pods with ImagePullBackOff:"
    kubectl get pods --all-namespaces --field-selector=status.phase=Pending | grep -i imagepull || echo "No ImagePullBackOff pods found"
    echo
    
    echo "2. Check Image Pull Secrets:"
    kubectl get secrets --all-namespaces --field-selector=type=kubernetes.io/dockerconfigjson
    echo
    
    echo "3. Common Image Issues Troubleshooting:"
    cat << IMAGE_TROUBLESHOOT_EOF
# Check if image exists
docker pull <image-name>

# Verify image registry access
kubectl run test-pod --image=<image-name> --dry-run=client -o yaml

# Check image pull secrets
kubectl get secret <secret-name> -o jsonpath='{.data.\.dockerconfigjson}' | base64 -d

# Test image pull manually
kubectl run debug-image --image=<image-name> --rm -it --restart=Never -- /bin/sh

IMAGE_TROUBLESHOOT_EOF
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
diagnose_resource_issues() {
    echo "=== Resource Issues Diagnosis ==="
    
    echo "1. Node Resource Usage:"
    kubectl top nodes 2>/dev/null || echo "Metrics server not available"
    echo
    
    echo "2. Pod Resource Usage:"
    kubectl top pods --all-namespaces --sort-by=cpu 2>/dev/null | head -10 || echo "Metrics server not available"
    echo
    
    echo "3. Pods with Resource Issues:"
    kubectl get pods --all-namespaces --field-selector=status.phase=Pending | grep -E "(OutOfcpu|OutOfmemory|Insufficient)" || echo "No resource-related pending pods"
    echo
    
    echo "4. Node Capacity Check:"
    kubectl describe nodes | grep -A 5 "Allocated resources"
    echo
    
    echo "5. Resource Troubleshooting Commands:"
    cat << RESOURCE_TROUBLESHOOT_EOF
# Check node capacity
kubectl describe node <node-name>

# Check pod resource requests/limits
kubectl describe pod <pod-name>

# Check resource quotas
kubectl get resourcequota --all-namespaces

# Check limit ranges
kubectl get limitrange --all-namespaces

RESOURCE_TROUBLESHOOT_EOF
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
diagnose_config_issues() {
    echo "=== Configuration Issues Diagnosis ==="
    
    echo "1. Pods with Config Issues:"
    kubectl get pods --all-namespaces | grep -E "(CreateContainerConfigError|InvalidImageName)" || echo "No config-related issues found"
    echo
    
    echo "2. Missing ConfigMaps:"
    echo "Checking for missing ConfigMaps referenced by pods..."
    kubectl get pods --all-namespaces -o jsonpath='{range .items[*]}{.metadata.namespace}{" "}{.metadata.name}{" "}{.spec.volumes[*].configMap.name}{"\n"}{end}' | grep -v "^$"
    echo
    
    echo "3. Missing Secrets:"
    echo "Checking for missing Secrets referenced by pods..."
    kubectl get pods --all-namespaces -o jsonpath='{range .items[*]}{.metadata.namespace}{" "}{.metadata.name}{" "}{.spec.volumes[*].secret.secretName}{"\n"}{end}' | grep -v "^$"
    echo
    
    echo "4. Configuration Troubleshooting:"
    cat << CONFIG_TROUBLESHOOT_EOF
# Validate YAML syntax
kubectl apply --dry-run=client -f <pod-yaml>

# Check ConfigMap exists
kubectl get configmap <configmap-name> -n <namespace>

# Check Secret exists
kubectl get secret <secret-name> -n <namespace>

# Verify environment variables
kubectl exec <pod-name> -- env

CONFIG_TROUBLESHOOT_EOF
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
create_test_scenarios() {
    echo "=== Creating Test Scenarios ==="
    
    echo "1. Pod with Image Issue:"
    cat << IMAGE_ISSUE_POD_EOF > test-image-issue-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-image-issue
  namespace: default
  labels:
    test: troubleshooting
spec:
  containers:
  - name: app
    image: nonexistent-registry.com/fake-image:latest
    ports:
    - containerPort: 8080
  restartPolicy: Never
IMAGE_ISSUE_POD_EOF
    
    echo "‚úÖ Test pod with image issue created: test-image-issue-pod.yaml"
    echo
    
    echo "2. Pod with Resource Issue:"
    cat << RESOURCE_ISSUE_POD_EOF > test-resource-issue-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-resource-issue
  namespace: default
  labels:
    test: troubleshooting
spec:
  containers:
  - name: app
    image: nginx:1.21
    resources:
      requests:
        cpu: "10"
        memory: "100Gi"
      limits:
        cpu: "20"
        memory: "200Gi"
  restartPolicy: Never
RESOURCE_ISSUE_POD_EOF
    
    echo "‚úÖ Test pod with resource issue created: test-resource-issue-pod.yaml"
    echo
    
    echo "3. Pod with Config Issue:"
    cat << CONFIG_ISSUE_POD_EOF > test-config-issue-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-config-issue
  namespace: default
  labels:
    test: troubleshooting
spec:
  containers:
  - name: app
    image: nginx:1.21
    env:
    - name: CONFIG_VALUE
      valueFrom:
        configMapKeyRef:
          name: nonexistent-configmap
          key: config-key
    volumeMounts:
    - name: secret-volume
      mountPath: /etc/secrets
  volumes:
  - name: secret-volume
    secret:
      secretName: nonexistent-secret
  restartPolicy: Never
CONFIG_ISSUE_POD_EOF
    
    echo "‚úÖ Test pod with config issue created: test-config-issue-pod.yaml"
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö pods
auto_diagnose_all_pods() {
    echo "=== Auto Diagnosis of All Problematic Pods ==="
    
    echo "1. Scanning for problematic pods..."
    PROBLEMATIC_PODS=$(kubectl get pods --all-namespaces --field-selector=status.phase!=Running,status.phase!=Succeeded -o jsonpath='{range .items[*]}{.metadata.namespace}{" "}{.metadata.name}{"\n"}{end}')
    
    if [ -z "$PROBLEMATIC_PODS" ]; then
        echo "‚úÖ No problematic pods found!"
        return 0
    fi
    
    echo "Found problematic pods:"
    echo "$PROBLEMATIC_PODS"
    echo
    
    echo "2. Diagnosing each problematic pod:"
    while IFS= read -r line; do
        if [ ! -z "$line" ]; then
            NAMESPACE=$(echo $line | awk '{print $1}')
            POD_NAME=$(echo $line | awk '{print $2}')
            echo "--- Diagnosing $NAMESPACE/$POD_NAME ---"
            quick_pod_diagnosis $POD_NAME $NAMESPACE
            echo
        fi
    done <<< "$PROBLEMATIC_PODS"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è troubleshooting checklist
create_troubleshooting_checklist() {
    echo "=== Creating Troubleshooting Checklist ==="
    
    cat << CHECKLIST_EOF > pod-troubleshooting-checklist.md
# Pod Troubleshooting Checklist

## üîç **Step 1: Basic Information**
- [ ] Check pod status: \`kubectl get pod <pod-name> -n <namespace>\`
- [ ] Check pod events: \`kubectl get events -n <namespace> --field-selector involvedObject.name=<pod-name>\`
- [ ] Check pod description: \`kubectl describe pod <pod-name> -n <namespace>\`

## üñºÔ∏è **Step 2: Image Issues**
- [ ] Verify image name and tag
- [ ] Check image registry accessibility
- [ ] Verify image pull secrets
- [ ] Test image pull manually

## üíæ **Step 3: Resource Issues**
- [ ] Check node capacity: \`kubectl describe nodes\`
- [ ] Check resource requests/limits
- [ ] Verify resource quotas
- [ ] Check limit ranges

## ‚öôÔ∏è **Step 4: Configuration Issues**
- [ ] Validate YAML syntax
- [ ] Check ConfigMap existence
- [ ] Check Secret existence
- [ ] Verify environment variables

## üåê **Step 5: Networking Issues**
- [ ] Check service account
- [ ] Verify network policies
- [ ] Check DNS resolution
- [ ] Test connectivity

## üìù **Step 6: Logs and Debugging**
- [ ] Check container logs: \`kubectl logs <pod-name> -c <container-name>\`
- [ ] Check previous logs: \`kubectl logs <pod-name> --previous\`
- [ ] Execute into container: \`kubectl exec -it <pod-name> -- /bin/sh\`

## üîß **Common Solutions**
1. **ImagePullBackOff**: Fix image name, add pull secrets
2. **Pending**: Check resources, node selectors, taints
3. **CrashLoopBackOff**: Check logs, fix application issues
4. **CreateContainerConfigError**: Fix ConfigMap/Secret references
5. **InvalidImageName**: Correct image name format

CHECKLIST_EOF
    
    echo "‚úÖ Troubleshooting checklist created: pod-troubleshooting-checklist.md"
    echo
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    case "$1" in
        "quick")
            quick_pod_diagnosis $2 $3
            ;;
        "detailed")
            detailed_pod_diagnosis $2 $3
            ;;
        "image")
            diagnose_image_issues
            ;;
        "resources")
            diagnose_resource_issues
            ;;
        "config")
            diagnose_config_issues
            ;;
        "test")
            create_test_scenarios
            ;;
        "auto")
            auto_diagnose_all_pods
            ;;
        "checklist")
            create_troubleshooting_checklist
            ;;
        "all"|"")
            auto_diagnose_all_pods
            diagnose_image_issues
            diagnose_resource_issues
            diagnose_config_issues
            create_test_scenarios
            create_troubleshooting_checklist
            ;;
        *)
            echo "Usage: $0 [quick|detailed|image|resources|config|test|auto|checklist|all] [pod-name] [namespace]"
            echo ""
            echo "Pod Troubleshooting Options:"
            echo "  quick <pod> [ns]  - Quick diagnosis of specific pod"
            echo "  detailed <pod> [ns] - Detailed diagnosis of specific pod"
            echo "  image             - Diagnose image-related issues"
            echo "  resources         - Diagnose resource-related issues"
            echo "  config            - Diagnose configuration issues"
            echo "  test              - Create test scenarios"
            echo "  auto              - Auto-diagnose all problematic pods"
            echo "  checklist         - Create troubleshooting checklist"
            ;;
    esac
}

main "$@"

EOF

chmod +x pod-troubleshooting-toolkit.sh
./pod-troubleshooting-toolkit.sh all
```

## üéØ **–ü–æ—à–∞–≥–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Pod:**

### **–®–∞–≥ 1: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è**
```bash
# –°—Ç–∞—Ç—É—Å pod
kubectl get pod <pod-name> -n <namespace> -o wide

# –°–æ–±—ã—Ç–∏—è pod
kubectl get events -n <namespace> --field-selector involvedObject.name=<pod-name>

# –û–ø–∏—Å–∞–Ω–∏–µ pod
kubectl describe pod <pod-name> -n <namespace>
```

### **–®–∞–≥ 2: –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤**
```bash
# –¢–µ–∫—É—â–∏–µ –ª–æ–≥–∏
kubectl logs <pod-name> -n <namespace>

# –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –ª–æ–≥–∏ (–µ—Å–ª–∏ pod –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–ª—Å—è)
kubectl logs <pod-name> -n <namespace> --previous

# –õ–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
kubectl logs <pod-name> -c <container-name> -n <namespace>
```

### **–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤**
```bash
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ —É–∑–ª–æ–≤
kubectl top nodes

# –û–ø–∏—Å–∞–Ω–∏–µ —É–∑–ª–∞
kubectl describe node <node-name>

# –ü—Ä–æ–≤–µ—Ä–∫–∞ resource quotas
kubectl get resourcequota -n <namespace>
```

### **–®–∞–≥ 4: –û—Ç–ª–∞–¥–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ YAML
kubectl apply --dry-run=client -f pod.yaml

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
kubectl exec -it <pod-name> -- /bin/bash

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
kubectl exec <pod-name> -- env
```

## üîß **–ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è:**

### **ImagePullBackOff:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º—è –æ–±—Ä–∞–∑–∞ –∏ —Ç–µ–≥
- –î–æ–±–∞–≤–∏—Ç—å image pull secrets
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å registry

### **Pending:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã —É–∑–ª–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å node selectors
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å taints –∏ tolerations

### **CrashLoopBackOff:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health checks
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

**–°–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥ –∫ troubleshooting –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∫–æ—Ä—è–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º!**
