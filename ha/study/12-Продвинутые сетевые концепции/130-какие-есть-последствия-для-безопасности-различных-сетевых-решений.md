# 130. –ö–∞–∫–∏–µ –µ—Å—Ç—å –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–µ—Ç–µ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π

## üéØ **–ö–∞–∫–∏–µ –µ—Å—Ç—å –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–µ—Ç–µ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π**

**Network security** –≤ Kubernetes –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞, –ø–æ—Å–∫–æ–ª—å–∫—É –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Å–µ—Ä—å–µ–∑–Ω—ã–º —É—è–∑–≤–∏–º–æ—Å—Ç—è–º. –ö–∞–∂–¥—ã–π —Ç–∏–ø —Å–µ—Ç–µ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–º–µ–µ—Ç —Å–≤–æ–∏ security implications, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–Ω–∏–º–∞—Ç—å –∏ —É—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

## üåê **Security Implications –ø–æ —Ç–∏–ø–∞–º —Å–µ—Ç–µ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π:**

### **1. Service Types Security:**
- **ClusterIP**: –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ
- **NodePort**: –≠–∫—Å–ø–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö
- **LoadBalancer**: –í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- **Ingress**: L7 security features

### **2. Network Policies Security:**
- **Default Allow**: –í—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω—ã
- **Default Deny**: –í—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω—ã
- **Microsegmentation**: –¢–æ—á–µ—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å
- **Zero Trust**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

### **3. CNI Security Considerations:**
- **Calico**: Advanced network policies
- **Cilium**: eBPF-based security
- **Weave**: Encryption capabilities
- **Flannel**: Basic networking

## üìä **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –≤–∞—à–µ–≥–æ HA –∫–ª–∞—Å—Ç–µ—Ä–∞:**

```bash
# –°–æ–∑–¥–∞—Ç—å comprehensive network security analysis toolkit
cat << 'EOF' > network-security-analysis-toolkit.sh
#!/bin/bash

echo "=== Network Security Analysis Toolkit ==="
echo "Comprehensive security analysis for different networking choices in HashFoundry HA cluster"
echo

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ security implications —Ä–∞–∑–ª–∏—á–Ω—ã—Ö Service types
analyze_service_security() {
    echo "=== Service Types Security Analysis ==="
    
    echo "1. ClusterIP Security Analysis:"
    cat << CLUSTERIP_SECURITY_EOF > clusterip-security-analysis.md
# ClusterIP Security Implications

## ‚úÖ **Security Advantages:**
- **Internal Only**: Service –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
- **No External Exposure**: –ù–µ—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏–∑–≤–Ω–µ
- **Network Isolation**: –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —É–≥—Ä–æ–∑
- **Service Discovery**: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ DNS

## ‚ùå **Security Risks:**
- **Lateral Movement**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –º–µ–∂–¥—É –ø–æ–¥–∞–º–∏
- **No Authentication**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **Internal Threats**: –£—è–∑–≤–∏–º–æ—Å—Ç—å –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —É–≥—Ä–æ–∑–∞–º
- **Service Enumeration**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤

## üõ°Ô∏è **Security Best Practices:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Network Policies –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å service-to-service authentication (mTLS)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ç—Ä–∞—Ñ–∏–∫
- –ü—Ä–∏–º–µ–Ω—è—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø least privilege

## üìã **Security Checklist:**
- [ ] Network Policies –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] Service mesh —Å mTLS
- [ ] Monitoring –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞
- [ ] RBAC –¥–ª—è service accounts
- [ ] Pod Security Standards

CLUSTERIP_SECURITY_EOF
    
    echo "2. NodePort Security Analysis:"
    cat << NODEPORT_SECURITY_EOF > nodeport-security-analysis.md
# NodePort Security Implications

## ‚úÖ **Security Advantages:**
- **Controlled Ports**: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ—Ä—Ç–æ–≤ (30000-32767)
- **Node-level Control**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å firewall –Ω–∞ —É—Ä–æ–≤–Ω–µ —É–∑–ª–æ–≤
- **No Cloud Dependencies**: –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç cloud provider

## ‚ùå **Security Risks:**
- **All Nodes Exposed**: –°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö
- **Port Scanning**: –£—è–∑–≤–∏–º–æ—Å—Ç—å –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –ø–æ—Ä—Ç–æ–≤
- **No SSL Termination**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ SSL
- **Source IP Loss**: –ü–æ—Ç–µ—Ä—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏—Å—Ç–æ—á–Ω–∏–∫–µ
- **DDoS Vulnerability**: –£—è–∑–≤–∏–º–æ—Å—Ç—å –∫ DDoS –∞—Ç–∞–∫–∞–º

## üõ°Ô∏è **Security Best Practices:**
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å firewall –Ω–∞ —É—Ä–æ–≤–Ω–µ —É–∑–ª–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LoadBalancer –∏–ª–∏ Ingress –¥–ª—è production
- –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ IP –∞–¥—Ä–µ—Å–∞–º
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø–æ—Ä—Ç–∞—Ö
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å rate limiting

## üìã **Security Checklist:**
- [ ] Firewall rules –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] Monitoring –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø–æ—Ä—Ç–æ–≤
- [ ] Rate limiting —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [ ] Source IP whitelisting
- [ ] Regular security scans

NODEPORT_SECURITY_EOF
    
    echo "3. LoadBalancer Security Analysis:"
    cat << LOADBALANCER_SECURITY_EOF > loadbalancer-security-analysis.md
# LoadBalancer Security Implications

## ‚úÖ **Security Advantages:**
- **Cloud Provider Security**: –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ security features
- **DDoS Protection**: –ó–∞—â–∏—Ç–∞ –æ—Ç DDoS –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- **SSL Termination**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å SSL termination
- **Health Checks**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ health checks
- **Source IP Preservation**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ source IP

## ‚ùå **Security Risks:**
- **External Exposure**: –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
- **Cost of Multiple LBs**: –í—ã—Å–æ–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö LB
- **Cloud Vendor Lock-in**: –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- **Limited L7 Features**: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ L7 –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

## üõ°Ô∏è **Security Best Practices:**
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å security groups/firewall rules
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SSL/TLS –¥–ª—è –≤—Å–µ—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å WAF (Web Application Firewall)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å access logs
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å alerting –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

## üìã **Security Checklist:**
- [ ] SSL/TLS certificates –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] Security groups –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç –¥–æ—Å—Ç—É–ø
- [ ] WAF –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Access logs –º–æ–Ω–∏—Ç–æ—Ä—è—Ç—Å—è
- [ ] DDoS protection –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω

LOADBALANCER_SECURITY_EOF
    
    echo "4. Ingress Security Analysis:"
    cat << INGRESS_SECURITY_EOF > ingress-security-analysis.md
# Ingress Security Implications

## ‚úÖ **Security Advantages:**
- **L7 Security**: Application-level security features
- **SSL/TLS Termination**: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
- **WAF Integration**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å WAF
- **Rate Limiting**: –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ rate limiting
- **Authentication**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## ‚ùå **Security Risks:**
- **Single Point of Failure**: –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
- **Complex Configuration**: –°–ª–æ–∂–Ω–æ—Å—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- **Controller Vulnerabilities**: –£—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ Ingress Controller
- **Certificate Management**: –°–ª–æ–∂–Ω–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏

## üõ°Ô∏è **Security Best Practices:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å cert-manager –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å OWASP security headers
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å OAuth/OIDC authentication
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ModSecurity –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π WAF
- –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å Ingress Controller

## üìã **Security Checklist:**
- [ ] Cert-manager –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Security headers –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] Authentication —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [ ] WAF –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] Regular updates Ingress Controller

INGRESS_SECURITY_EOF
    
    echo "‚úÖ Service security analyses created:"
    echo "  - clusterip-security-analysis.md"
    echo "  - nodeport-security-analysis.md"
    echo "  - loadbalancer-security-analysis.md"
    echo "  - ingress-security-analysis.md"
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ Network Policies security
analyze_network_policies_security() {
    echo "=== Network Policies Security Analysis ==="
    
    echo "1. Default Allow vs Default Deny:"
    cat << NETWORK_POLICIES_SECURITY_EOF > network-policies-security.md
# Network Policies Security Implications

## üö® **Default Allow (No Network Policies)**

### Security Risks:
- **Unrestricted Communication**: –õ—é–±–æ–π –ø–æ–¥ –º–æ–∂–µ—Ç –æ–±—â–∞—Ç—å—Å—è —Å –ª—é–±—ã–º
- **Lateral Movement**: –õ–µ–≥–∫–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞
- **Data Exfiltration**: –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- **Service Enumeration**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### Attack Scenarios:
- Compromised pod ‚Üí Full cluster access
- Database access from any pod
- Cross-namespace communication without restrictions

## üõ°Ô∏è **Default Deny (Strict Network Policies)**

### Security Benefits:
- **Zero Trust Model**: –ö–∞–∂–¥–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —è–≤–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
- **Microsegmentation**: –¢–æ—á–µ—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å —Ç—Ä–∞—Ñ–∏–∫–∞
- **Reduced Attack Surface**: –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –∞—Ç–∞–∫–∏
- **Compliance**: –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ security standards

### Implementation Challenges:
- Complex policy management
- Potential service disruptions
- Debugging difficulties
- Performance overhead

## üìä **Security Comparison Matrix**

| Aspect | Default Allow | Default Deny |
|--------|---------------|--------------|
| **Security Level** | Low | High |
| **Complexity** | Low | High |
| **Maintenance** | Low | High |
| **Compliance** | Poor | Excellent |
| **Performance** | Good | Moderate |
| **Debugging** | Easy | Difficult |

NETWORK_POLICIES_SECURITY_EOF
    
    echo "2. Creating security-focused network policies:"
    cat << SECURITY_POLICIES_EOF > security-focused-policies.yaml
# Security-Focused Network Policies

# Zero Trust Default Deny
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: zero-trust-default-deny
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

---
# Database Security Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: database-security-policy
  namespace: production
spec:
  podSelector:
    matchLabels:
      tier: database
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Only allow from application tier
  - from:
    - podSelector:
        matchLabels:
          tier: application
    ports:
    - protocol: TCP
      port: 5432
  # Allow monitoring
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9187
  egress:
  # Allow DNS only
  - to: []
    ports:
    - protocol: UDP
      port: 53

---
# Web Tier Security Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: web-tier-security-policy
  namespace: production
spec:
  podSelector:
    matchLabels:
      tier: web
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from ingress controller only
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
  egress:
  # Allow to application tier
  - to:
    - podSelector:
        matchLabels:
          tier: application
    ports:
    - protocol: TCP
      port: 8080
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53

---
# PCI DSS Compliance Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: pci-dss-compliance
  namespace: payment
spec:
  podSelector:
    matchLabels:
      compliance: pci-dss
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Strict access control for PCI DSS
  - from:
    - podSelector:
        matchLabels:
          authorized: "true"
          compliance: pci-dss
    ports:
    - protocol: TCP
      port: 443  # HTTPS only
  egress:
  # Only allow to authorized external payment gateways
  - to: []
    ports:
    - protocol: TCP
      port: 443
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53

SECURITY_POLICIES_EOF
    
    echo "‚úÖ Network policies security analysis created:"
    echo "  - network-policies-security.md"
    echo "  - security-focused-policies.yaml"
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ CNI security implications
analyze_cni_security() {
    echo "=== CNI Security Analysis ==="
    
    cat << CNI_SECURITY_EOF > cni-security-comparison.md
# CNI Security Implications Comparison

## üîß **Calico Security Features**

### Advantages:
- **Advanced Network Policies**: Rich policy language
- **Global Network Policies**: Cluster-wide policies
- **Encryption**: WireGuard encryption support
- **Threat Detection**: Anomaly detection capabilities
- **Compliance**: Built-in compliance reporting

### Security Features:
- eBPF dataplane for performance
- Application layer policies
- Service mesh integration
- FIPS 140-2 compliance
- Zero Trust networking

### Use Cases:
- High-security environments
- Compliance requirements (PCI DSS, HIPAA)
- Multi-tenant clusters
- Service mesh deployments

## üêõ **Cilium Security Features**

### Advantages:
- **eBPF-based**: Kernel-level security
- **Identity-based Policies**: L3-L7 policies
- **Transparent Encryption**: Automatic encryption
- **Runtime Security**: Real-time threat detection
- **Observability**: Deep network visibility

### Security Features:
- BPF-based firewalling
- HTTP/gRPC/Kafka policies
- Mutual TLS automation
- Network segmentation
- Intrusion detection

### Use Cases:
- Cloud-native applications
- Microservices architectures
- API security
- Runtime protection

## üï∏Ô∏è **Weave Net Security Features**

### Advantages:
- **Simple Encryption**: Easy to enable encryption
- **Network Partitioning**: Automatic network segmentation
- **Fast Datapath**: Optimized for performance
- **Multi-cloud**: Works across cloud providers

### Security Features:
- Sleeve encryption
- Password-based authentication
- Network policies support
- Automatic IP allocation

### Use Cases:
- Simple deployments
- Multi-cloud environments
- Development clusters
- Basic security requirements

## üèÉ **Flannel Security Considerations**

### Limitations:
- **Basic Networking**: Limited security features
- **No Network Policies**: Requires additional components
- **No Encryption**: No built-in encryption
- **Simple Architecture**: Minimal security controls

### Security Implications:
- Requires additional security layers
- Not suitable for high-security environments
- Good for development/testing
- Needs external policy enforcement

## üìä **CNI Security Comparison Matrix**

| Feature | Calico | Cilium | Weave | Flannel |
|---------|--------|--------|-------|---------|
| **Network Policies** | ‚úÖ Advanced | ‚úÖ L3-L7 | ‚úÖ Basic | ‚ùå None |
| **Encryption** | ‚úÖ WireGuard | ‚úÖ Transparent | ‚úÖ Sleeve | ‚ùå None |
| **Observability** | ‚úÖ Rich | ‚úÖ eBPF | ‚úÖ Basic | ‚ùå Limited |
| **Performance** | ‚úÖ High | ‚úÖ eBPF | ‚úÖ Good | ‚úÖ Simple |
| **Complexity** | üü° Medium | üü° Medium | üü¢ Low | üü¢ Very Low |
| **Security Level** | üü¢ High | üü¢ High | üü° Medium | üî¥ Low |

CNI_SECURITY_EOF
    
    echo "‚úÖ CNI security comparison created: cni-security-comparison.md"
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è security assessment tools
create_security_assessment_tools() {
    echo "=== Creating Security Assessment Tools ==="
    
    echo "1. Network security scanner:"
    cat << SECURITY_SCANNER_EOF > network-security-scanner.sh
#!/bin/bash

echo "=== Network Security Scanner ==="

# Function to check for insecure service configurations
check_insecure_services() {
    echo "=== Checking for Insecure Service Configurations ==="
    
    echo "1. NodePort services (potential security risk):"
    kubectl get services --all-namespaces -o json | jq -r '.items[] | select(.spec.type=="NodePort") | "\(.metadata.namespace)/\(.metadata.name) - Port: \(.spec.ports[0].nodePort)"'
    echo
    
    echo "2. LoadBalancer services without source restrictions:"
    kubectl get services --all-namespaces -o json | jq -r '.items[] | select(.spec.type=="LoadBalancer" and (.spec.loadBalancerSourceRanges | length) == 0) | "\(.metadata.namespace)/\(.metadata.name) - No source restrictions"'
    echo
    
    echo "3. Services without proper labels:"
    kubectl get services --all-namespaces -o json | jq -r '.items[] | select((.metadata.labels | length) < 2) | "\(.metadata.namespace)/\(.metadata.name) - Insufficient labels"'
    echo
}

# Function to check network policies
check_network_policies() {
    echo "=== Checking Network Policies ==="
    
    echo "1. Namespaces without network policies:"
    for ns in \$(kubectl get namespaces -o jsonpath='{.items[*].metadata.name}'); do
        POLICY_COUNT=\$(kubectl get networkpolicies -n \$ns --no-headers 2>/dev/null | wc -l)
        if [ \$POLICY_COUNT -eq 0 ]; then
            echo "‚ùå \$ns - No network policies"
        else
            echo "‚úÖ \$ns - \$POLICY_COUNT policies"
        fi
    done
    echo
    
    echo "2. Default deny policies:"
    for ns in \$(kubectl get namespaces -o jsonpath='{.items[*].metadata.name}'); do
        if kubectl get networkpolicy -n \$ns default-deny-all >/dev/null 2>&1; then
            echo "‚úÖ \$ns - Default deny policy exists"
        else
            echo "‚ùå \$ns - No default deny policy"
        fi
    done
    echo
}

# Function to check for security misconfigurations
check_security_misconfigurations() {
    echo "=== Checking Security Misconfigurations ==="
    
    echo "1. Pods running as root:"
    kubectl get pods --all-namespaces -o json | jq -r '.items[] | select(.spec.securityContext.runAsUser == 0 or .spec.containers[].securityContext.runAsUser == 0) | "\(.metadata.namespace)/\(.metadata.name) - Running as root"'
    echo
    
    echo "2. Pods with privileged containers:"
    kubectl get pods --all-namespaces -o json | jq -r '.items[] | select(.spec.containers[].securityContext.privileged == true) | "\(.metadata.namespace)/\(.metadata.name) - Privileged container"'
    echo
    
    echo "3. Pods without resource limits:"
    kubectl get pods --all-namespaces -o json | jq -r '.items[] | select(.spec.containers[].resources.limits == null) | "\(.metadata.namespace)/\(.metadata.name) - No resource limits"'
    echo
}

# Function to check ingress security
check_ingress_security() {
    echo "=== Checking Ingress Security ==="
    
    echo "1. Ingress without TLS:"
    kubectl get ingress --all-namespaces -o json | jq -r '.items[] | select(.spec.tls == null) | "\(.metadata.namespace)/\(.metadata.name) - No TLS configuration"'
    echo
    
    echo "2. Ingress with weak TLS configuration:"
    kubectl get ingress --all-namespaces -o json | jq -r '.items[] | select(.metadata.annotations."nginx.ingress.kubernetes.io/ssl-protocols" == null) | "\(.metadata.namespace)/\(.metadata.name) - No SSL protocol specification"'
    echo
}

# Main security scan
main() {
    check_insecure_services
    check_network_policies
    check_security_misconfigurations
    check_ingress_security
    
    echo "=== Security Scan Summary ==="
    echo "Review the findings above and address any security issues."
    echo "Consider implementing:"
    echo "- Network policies for all namespaces"
    echo "- TLS for all external communications"
    echo "- Resource limits for all pods"
    echo "- Non-root containers"
    echo "- Regular security audits"
}

main

SECURITY_SCANNER_EOF
    
    chmod +x network-security-scanner.sh
    echo "‚úÖ Network security scanner created: network-security-scanner.sh"
    echo
    
    echo "2. Security compliance checker:"
    cat << COMPLIANCE_CHECKER_EOF > security-compliance-checker.sh
#!/bin/bash

echo "=== Security Compliance Checker ==="

# Function to check CIS Kubernetes Benchmark compliance
check_cis_compliance() {
    echo "=== CIS Kubernetes Benchmark Checks ==="
    
    echo "1. Network Policy Requirements:"
    TOTAL_NS=\$(kubectl get namespaces --no-headers | wc -l)
    NS_WITH_POLICIES=\$(kubectl get networkpolicies --all-namespaces --no-headers | awk '{print \$1}' | sort -u | wc -l)
    
    if [ \$NS_WITH_POLICIES -eq \$TOTAL_NS ]; then
        echo "‚úÖ All namespaces have network policies"
    else
        echo "‚ùå \$((TOTAL_NS - NS_WITH_POLICIES)) namespaces missing network policies"
    fi
    
    echo "2. Default Service Account Usage:"
    DEFAULT_SA_PODS=\$(kubectl get pods --all-namespaces -o json | jq -r '.items[] | select(.spec.serviceAccountName == "default" or .spec.serviceAccountName == null) | "\(.metadata.namespace)/\(.metadata.name)"' | wc -l)
    
    if [ \$DEFAULT_SA_PODS -eq 0 ]; then
        echo "‚úÖ No pods using default service account"
    else
        echo "‚ùå \$DEFAULT_SA_PODS pods using default service account"
    fi
    
    echo "3. Pod Security Standards:"
    PRIVILEGED_PODS=\$(kubectl get pods --all-namespaces -o json | jq -r '.items[] | select(.spec.containers[].securityContext.privileged == true) | "\(.metadata.namespace)/\(.metadata.name)"' | wc -l)
    
    if [ \$PRIVILEGED_PODS -eq 0 ]; then
        echo "‚úÖ No privileged pods found"
    else
        echo "‚ùå \$PRIVILEGED_PODS privileged pods found"
    fi
}

# Function to check NIST compliance
check_nist_compliance() {
    echo "=== NIST Cybersecurity Framework Checks ==="
    
    echo "1. Identify - Asset Management:"
    LABELED_SERVICES=\$(kubectl get services --all-namespaces -o json | jq -r '.items[] | select((.metadata.labels | length) >= 3) | "\(.metadata.namespace)/\(.metadata.name)"' | wc -l)
    TOTAL_SERVICES=\$(kubectl get services --all-namespaces --no-headers | wc -l)
    
    echo "Services with proper labeling: \$LABELED_SERVICES/\$TOTAL_SERVICES"
    
    echo "2. Protect - Access Control:"
    RBAC_ROLES=\$(kubectl get roles,clusterroles --all-namespaces --no-headers | wc -l)
    echo "RBAC roles configured: \$RBAC_ROLES"
    
    echo "3. Detect - Monitoring:"
    MONITORING_NS=\$(kubectl get namespaces -o json | jq -r '.items[] | select(.metadata.labels."security-zone" == "monitoring") | .metadata.name' | wc -l)
    
    if [ \$MONITORING_NS -gt 0 ]; then
        echo "‚úÖ Monitoring namespace configured"
    else
        echo "‚ùå No monitoring namespace found"
    fi
}

# Function to generate compliance report
generate_compliance_report() {
    echo "=== Compliance Report ==="
    
    cat << REPORT_EOF > compliance-report.md
# Network Security Compliance Report

Generated: \$(date)

## Executive Summary
This report provides an assessment of network security compliance
for the HashFoundry HA Kubernetes cluster.

## CIS Kubernetes Benchmark
- Network Policies: \$(kubectl get networkpolicies --all-namespaces --no-headers | wc -l) policies across \$(kubectl get namespaces --no-headers | wc -l) namespaces
- Service Accounts: Custom service accounts usage assessment
- Pod Security: Privileged containers and security contexts review

## NIST Cybersecurity Framework
- Identify: Asset labeling and inventory
- Protect: Access controls and network segmentation
- Detect: Monitoring and logging capabilities

## Recommendations
1. Implement default deny network policies in all namespaces
2. Use custom service accounts for all workloads
3. Enable Pod Security Standards
4. Implement comprehensive monitoring
5. Regular security assessments

## Next Steps
- Address identified security gaps
- Implement automated compliance checking
- Regular security training for team
- Continuous monitoring and improvement

REPORT_EOF
    
    echo "‚úÖ Compliance report generated: compliance-report.md"
}

# Main compliance check
main() {
    check_cis_compliance
    echo
    check_nist_compliance
    echo
    generate_compliance_report
}

main

COMPLIANCE_CHECKER_EOF
    
    chmod +x security-compliance-checker.sh
    echo "‚úÖ Security compliance checker created: security-compliance-checker.sh"
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è cleanup
cleanup_security_analysis() {
    echo "=== Cleaning up security analysis resources ==="
    
    # Remove any test resources created during analysis
    kubectl delete pods --all-namespaces -l security-test=true --ignore-not-found=true
    
    echo "‚úÖ Security analysis resources cleaned up"
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    case "$1" in
        "services")
            analyze_service_security
            ;;
        "policies")
            analyze_network_policies_security
            ;;
        "cni")
            analyze_cni_security
            ;;
        "tools")
            create_security_assessment_tools
            ;;
        "cleanup")
            cleanup_security_analysis
            ;;
        "all"|"")
            analyze_service_security
            analyze_network_policies_security
            analyze_cni_security
            create_security_assessment_tools
            ;;
        *)
            echo "Usage: $0 [services|policies|cni|tools|cleanup|all]"
            echo ""
            echo "Network Security Analysis Options:"
            echo "  services  - Analyze service types security implications"
            echo "  policies  - Analyze network policies security"
            echo "  cni       - Analyze CNI security implications"
            echo "  tools     - Create security assessment tools"
            echo "  cleanup   - Clean up analysis resources"
            ;;
    esac
}

main "$@"

EOF

chmod +x network-security-analysis-toolkit.sh
./network-security-analysis-toolkit.sh all
```

## üéØ **–û—Å–Ω–æ–≤–Ω—ã–µ security implications:**

### **1. Service Types Security:**

**ClusterIP:**
- ‚úÖ –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∏–∑–æ–ª—è—Ü–∏—è
- ‚ùå Lateral movement —Ä–∏—Å–∫–∏

**NodePort:**
- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ –ø–æ—Ä—Ç—ã
- ‚ùå –≠–∫—Å–ø–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö

**LoadBalancer:**
- ‚úÖ Cloud provider security
- ‚ùå –í–Ω–µ—à–Ω–µ–µ —ç–∫—Å–ø–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

**Ingress:**
- ‚úÖ L7 security features
- ‚ùå –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –æ—Ç–∫–∞–∑–∞

### **2. Network Policies Security:**

```yaml
# Zero Trust –ø–æ–¥—Ö–æ–¥
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: zero-trust-default
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
```

### **3. CNI Security Comparison:**

| CNI | Security Level | Features |
|-----|----------------|----------|
| **Calico** | –í—ã—Å–æ–∫–∏–π | Advanced policies, encryption |
| **Cilium** | –í—ã—Å–æ–∫–∏–π | eBPF, L7 policies |
| **Weave** | –°—Ä–µ–¥–Ω–∏–π | Basic encryption |
| **Flannel** | –ù–∏–∑–∫–∏–π | Minimal security |

## üõ°Ô∏è **Security Best Practices:**

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:**
```bash
# –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ insecure —Å–µ—Ä–≤–∏—Å–æ–≤
kubectl get services --all-namespaces -o json | \
jq '.items[] | select(.spec.type=="NodePort")'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Network Policies
kubectl get networkpolicies --all-namespaces

# –ê–Ω–∞–ª–∏–∑ privileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
kubectl get pods --all-namespaces -o json | \
jq '.items[] | select(.spec.containers[].securityContext.privileged==true)'
```

### **Compliance –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```bash
# CIS Kubernetes Benchmark
# NIST Cybersecurity Framework
# PCI DSS requirements
# HIPAA compliance
```

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä —Å–µ—Ç–µ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–∞!**
