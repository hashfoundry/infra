# 138. –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –ª–æ–≥–∏–∫—É –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

## üéØ **–ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –ª–æ–≥–∏–∫—É –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è?**

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è** –≤ Kubernetes –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –ø–æ–¥–æ–≤ –Ω–∞ —É–∑–ª–∞—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤.

## üåê **–ü–æ–¥—Ö–æ–¥—ã –∫ –∫–∞—Å—Ç–æ–º–Ω–æ–º—É –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é:**

### **1. Custom Scheduler:**
- **–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫** - –∑–∞–º–µ–Ω–∞ kube-scheduler
- **Scheduler Extender** - —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
- **Scheduler Framework** - –ø–ª–∞–≥–∏–Ω—ã –¥–ª—è kube-scheduler

### **2. Scheduling Policies:**
- **Node Affinity** - –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —É–∑–ª–∞–º
- **Pod Affinity/Anti-Affinity** - –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –º–µ–∂–¥—É –ø–æ–¥–∞–º–∏
- **Taints and Tolerations** - –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏ –¥–æ–ø—É—Å–∫–∏
- **Priority Classes** - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø–æ–¥–æ–≤

### **3. Advanced Techniques:**
- **Multi-Scheduler** - –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–≤
- **Scheduler Profiles** - –ø—Ä–æ—Ñ–∏–ª–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- **Custom Resources** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

## üìä **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –≤–∞—à–µ–≥–æ HA –∫–ª–∞—Å—Ç–µ—Ä–∞:**

### **–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:**

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
kubectl get pods -n kube-system -l component=kube-scheduler

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–±—ã—Ç–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
kubectl get events --all-namespaces --field-selector reason=Scheduled | head -10

# –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–¥–æ–≤ –ø–æ —É–∑–ª–∞–º
kubectl get pods --all-namespaces -o wide --no-headers | \
awk '{print $8}' | sort | uniq -c | sort -nr

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—É–¥–∞—á–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
kubectl get events --all-namespaces --field-selector reason=FailedScheduling
```

### **–°–æ–∑–¥–∞–Ω–∏–µ custom scheduler:**

```yaml
# custom-scheduler-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hashfoundry-scheduler
  namespace: kube-system
  labels:
    app: hashfoundry-scheduler
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hashfoundry-scheduler
  template:
    metadata:
      labels:
        app: hashfoundry-scheduler
    spec:
      serviceAccountName: hashfoundry-scheduler
      containers:
      - name: scheduler
        image: hashfoundry/custom-scheduler:v1.0.0
        command:
        - /usr/local/bin/hashfoundry-scheduler
        - --config=/etc/kubernetes/scheduler-config.yaml
        - --v=2
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
        volumeMounts:
        - name: config
          mountPath: /etc/kubernetes
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: scheduler-config
```

### **Scheduler Framework –ø–ª–∞–≥–∏–Ω—ã:**

```yaml
# scheduler-config.yaml
apiVersion: kubescheduler.config.k8s.io/v1beta3
kind: KubeSchedulerConfiguration
profiles:
- schedulerName: hashfoundry-scheduler
  plugins:
    filter:
      enabled:
      - name: NodeResourcesFit
      - name: NodeAffinity
      - name: HashFoundryNodeFilter
    score:
      enabled:
      - name: NodeResourcesFit
      - name: NodeAffinity
      - name: HashFoundryNodeScore
  pluginConfig:
  - name: HashFoundryNodeFilter
    args:
      allowedNodeTypes: ["compute", "storage", "network"]
      requiredLabels: ["hashfoundry.io/node-type"]
  - name: HashFoundryNodeScore
    args:
      weights:
        nodeType: 50
        zoneAffinity: 40
        resourceUtilization: 30
        networkLocality: 25
```

### **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Node Affinity:**

```yaml
# pod-with-node-affinity.yaml
apiVersion: v1
kind: Pod
metadata:
  name: webapp-pod
  labels:
    app: webapp
    environment: hashfoundry-ha
spec:
  schedulerName: hashfoundry-scheduler
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: hashfoundry.io/node-type
            operator: In
            values: ["compute", "general"]
          - key: topology.kubernetes.io/zone
            operator: In
            values: ["fra1-a", "fra1-b"]
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 80
        preference:
          matchExpressions:
          - key: hashfoundry.io/node-type
            operator: In
            values: ["compute"]
      - weight: 60
        preference:
          matchExpressions:
          - key: hashfoundry.io/ssd
            operator: In
            values: ["true"]
  containers:
  - name: webapp
    image: nginx:1.21
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi
```

### **Pod Anti-Affinity –¥–ª—è HA:**

```yaml
# ha-deployment-with-anti-affinity.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ha-webapp
  namespace: production
spec:
  replicas: 3
  selector:
    matchLabels:
      app: ha-webapp
  template:
    metadata:
      labels:
        app: ha-webapp
        tier: frontend
    spec:
      schedulerName: hashfoundry-scheduler
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values: ["ha-webapp"]
            topologyKey: kubernetes.io/hostname
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values: ["ha-webapp"]
              topologyKey: topology.kubernetes.io/zone
      containers:
      - name: webapp
        image: hashfoundry/webapp:v2.1.0
        ports:
        - containerPort: 8080
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
```

### **Priority Classes:**

```yaml
# priority-classes.yaml
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: hashfoundry-critical
value: 1000000
globalDefault: false
description: "Critical HashFoundry system components"

---
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: hashfoundry-high
value: 100000
globalDefault: false
description: "High priority HashFoundry applications"

---
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: hashfoundry-normal
value: 1000
globalDefault: true
description: "Normal priority HashFoundry workloads"

---
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: hashfoundry-low
value: 100
globalDefault: false
description: "Low priority batch jobs"
```

### **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Priority Classes:**

```yaml
# critical-pod-with-priority.yaml
apiVersion: v1
kind: Pod
metadata:
  name: critical-service
  labels:
    app: critical-service
    priority: critical
spec:
  priorityClassName: hashfoundry-critical
  schedulerName: hashfoundry-scheduler
  containers:
  - name: service
    image: hashfoundry/critical-service:v1.0.0
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 4Gi
```

### **Taints –∏ Tolerations:**

```bash
# –î–æ–±–∞–≤–∏—Ç—å taint –∫ —É–∑–ª—É –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö workloads
kubectl taint nodes hashfoundry-node-1 \
  hashfoundry.io/dedicated=gpu:NoSchedule

# –î–æ–±–∞–≤–∏—Ç—å taint –¥–ª—è maintenance
kubectl taint nodes hashfoundry-node-2 \
  maintenance=true:NoSchedule

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å taints –Ω–∞ —É–∑–ª–∞—Ö
kubectl describe nodes | grep -A 3 "Taints:"
```

```yaml
# pod-with-tolerations.yaml
apiVersion: v1
kind: Pod
metadata:
  name: gpu-workload
spec:
  schedulerName: hashfoundry-scheduler
  tolerations:
  - key: "hashfoundry.io/dedicated"
    operator: "Equal"
    value: "gpu"
    effect: "NoSchedule"
  - key: "nvidia.com/gpu"
    operator: "Exists"
    effect: "NoSchedule"
  containers:
  - name: gpu-app
    image: hashfoundry/gpu-app:v1.0.0
    resources:
      limits:
        nvidia.com/gpu: 1
```

### **Scheduler Extender:**

```yaml
# scheduler-extender-config.yaml
apiVersion: kubescheduler.config.k8s.io/v1beta3
kind: KubeSchedulerConfiguration
profiles:
- schedulerName: hashfoundry-extender-scheduler
  extenders:
  - urlPrefix: "http://hashfoundry-scheduler-extender:80"
    filterVerb: "filter"
    prioritizeVerb: "prioritize"
    weight: 100
    nodeCacheCapable: false
    ignoredResources:
    - "hashfoundry.io/special-resource"
    managedResources:
    - name: "cpu"
      ignoredByScheduler: false
    - name: "memory"
      ignoredByScheduler: false
```

### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:**

```bash
# –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
cat << 'EOF' > monitor-scheduling.sh
#!/bin/bash

echo "=== HashFoundry Scheduling Monitor ==="
echo "Timestamp: $(date)"
echo

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
echo "1. Scheduling Statistics:"
echo "   Total pods: $(kubectl get pods --all-namespaces --no-headers | wc -l)"
echo "   Running pods: $(kubectl get pods --all-namespaces --field-selector status.phase=Running --no-headers | wc -l)"
echo "   Pending pods: $(kubectl get pods --all-namespaces --field-selector status.phase=Pending --no-headers | wc -l)"
echo

# –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É–∑–ª–∞–º
echo "2. Pod Distribution by Node:"
kubectl get pods --all-namespaces -o wide --no-headers | \
awk '{print $8}' | sort | uniq -c | sort -nr | head -10
echo

# –ù–µ—É–¥–∞—á–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
echo "3. Recent Scheduling Failures:"
kubectl get events --all-namespaces --field-selector reason=FailedScheduling \
  --sort-by='.lastTimestamp' | tail -5
echo

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–≤
echo "4. Scheduler Usage:"
kubectl get pods --all-namespaces -o jsonpath='{range .items[*]}{.spec.schedulerName}{"\n"}{end}' | \
sort | uniq -c | sort -nr
echo

# Priority Classes –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
echo "5. Priority Classes Usage:"
kubectl get pods --all-namespaces -o jsonpath='{range .items[*]}{.spec.priorityClassName}{"\n"}{end}' | \
grep -v "^$" | sort | uniq -c | sort -nr
echo

echo "‚úÖ Scheduling monitoring completed"
EOF

chmod +x monitor-scheduling.sh
```

### **–ö–æ–º–∞–Ω–¥—ã kubectl –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:**

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–∞
kubectl describe pod <pod-name> -n <namespace>

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å affinity rules
kubectl get pods --all-namespaces -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.affinity}{"\n"}{end}' | grep -v "null"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å tolerations
kubectl get pods --all-namespaces -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.tolerations}{"\n"}{end}' | grep -v "null"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å node selectors
kubectl get pods --all-namespaces -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.nodeSelector}{"\n"}{end}' | grep -v "null"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã —É–∑–ª–æ–≤
kubectl describe nodes | grep -A 5 "Allocated resources:"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å capacity —É–∑–ª–æ–≤
kubectl get nodes -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.capacity}{"\n"}{end}'
```

## üéØ **–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**

1. **–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π** - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
2. **–í—ã–±–æ—Ä –ø–æ–¥—Ö–æ–¥–∞** - scheduler framework vs custom scheduler vs extender
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ dev —Å—Ä–µ–¥–µ
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
5. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** - –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ workloads –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ HashFoundry HA –∫–ª–∞—Å—Ç–µ—Ä–∞.
