# Cleanup Stuck Resources Fix

## üéØ **–ü—Ä–æ–±–ª–µ–º–∞**
–°–∫—Ä–∏–ø—Ç `cleanup.sh` –∑–∞–≤–∏—Å –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ PersistentVolumeClaims –∏–∑-–∑–∞ finalizers, –∫–æ—Ç–æ—Ä—ã–µ –±–ª–æ–∫–∏—Ä—É—é—Ç —É–¥–∞–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤.

## ‚ùå **–°–∏–º–ø—Ç–æ–º—ã –ø—Ä–æ–±–ª–µ–º—ã:**
```bash
persistentvolumeclaim "argocd-repo-server-tls-certs" deleted
error: timed out waiting for the condition on persistentvolumeclaims/argocd-repo-server-tls-certs
```

## üîß **–†–µ—à–µ–Ω–∏–µ**

### **1. –£–ª—É—á—à–µ–Ω–Ω—ã–π cleanup.sh**
–û–±–Ω–æ–≤–ª–µ–Ω –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç cleanup.sh —Å:
- **–ö–æ—Ä–æ—Ç–∫–∏–º–∏ timeout'–∞–º–∏** (30 —Å–µ–∫—É–Ω–¥ –≤–º–µ—Å—Ç–æ 60)
- **Force deletion** —Å `--force --grace-period=0`
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —É–¥–∞–ª–µ–Ω–∏–µ–º finalizers** —á–µ—Ä–µ–∑ `kubectl patch`
- **–ë–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π** –∑–∞—Å—Ç—Ä—è–≤—à–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤

### **2. –ù–æ–≤—ã–π force-cleanup.sh**
–°–æ–∑–¥–∞–Ω –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤:
- **–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ** –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
- **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ finalizers**
- **–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞** DigitalOcean —Ä–µ—Å—É—Ä—Å–æ–≤

## üöÄ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**

### **–û–±—ã—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è):**
```bash
./cleanup.sh
```

### **–≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–µ—Å–ª–∏ cleanup.sh –∑–∞–≤–∏—Å):**
```bash
# –ü—Ä–µ—Ä–≤–∏—Ç–µ cleanup.sh (Ctrl+C) –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:
./force-cleanup.sh
```

## üîç **–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ cleanup.sh**

### **–î–æ (–ø—Ä–æ–±–ª–µ–º–Ω–∞—è –≤–µ—Ä—Å–∏—è):**
```bash
kubectl delete pvc --all --all-namespaces --timeout=60s
# –î–æ–ª–≥–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ, –Ω–µ—Ç force deletion
```

### **–ü–æ—Å–ª–µ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è):**
```bash
# –ö–æ—Ä–æ—Ç–∫–∏–π timeout —Å force deletion
kubectl delete pvc --all --all-namespaces --timeout=30s --force --grace-period=0

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ finalizers –¥–ª—è –∑–∞—Å—Ç—Ä—è–≤—à–∏—Ö PVC
remaining_pvcs=$(kubectl get pvc --all-namespaces --no-headers | awk '{print $2 " -n " $1}')
echo "$remaining_pvcs" | while read pvc_name namespace_flag namespace_name; do
    kubectl patch pvc "$pvc_name" -n "$namespace_name" -p '{"metadata":{"finalizers":null}}'
    kubectl delete pvc "$pvc_name" -n "$namespace_name" --force --grace-period=0
done
```

## üö® **force-cleanup.sh - –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞**

### **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ö–æ–≥–¥–∞ `cleanup.sh` –∑–∞–≤–∏—Å –∏ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
- –ö–æ–≥–¥–∞ —Ä–µ—Å—É—Ä—Å—ã –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è –æ–±—ã—á–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
- –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤

### **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. **Force delete –≤—Å–µ—Ö PVC** (—É–¥–∞–ª—è–µ—Ç finalizers)
2. **Force delete –≤—Å–µ—Ö PV** (—É–¥–∞–ª—è–µ—Ç finalizers)
3. **Force delete –≤—Å–µ—Ö DigitalOcean volumes**
4. **Force delete Kubernetes cluster**
5. **Force delete –≤—Å–µ—Ö Load Balancers**
6. **–û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤**

### **–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```bash
# –ï—Å–ª–∏ cleanup.sh –∑–∞–≤–∏—Å, –ø—Ä–µ—Ä–≤–∏—Ç–µ –µ–≥–æ (Ctrl+C)
^C

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—É—é –æ—á–∏—Å—Ç–∫—É
./force-cleanup.sh

# –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—É—é –æ—á–∏—Å—Ç–∫—É
Are you sure you want to continue with force cleanup? (yes/no): yes
```

## üõ†Ô∏è **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è**

### **–ü—Ä–æ–±–ª–µ–º–∞ —Å finalizers:**
```yaml
# PVC —Å finalizers –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω
metadata:
  finalizers:
    - kubernetes.io/pvc-protection
    - external-provisioner.volume.kubernetes.io/finalizer
```

### **–†–µ—à–µ–Ω–∏–µ - —É–¥–∞–ª–µ–Ω–∏–µ finalizers:**
```bash
# –£–¥–∞–ª—è–µ–º finalizers –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
kubectl patch pvc <pvc-name> -n <namespace> -p '{"metadata":{"finalizers":null}}'

# –ó–∞—Ç–µ–º force delete
kubectl delete pvc <pvc-name> -n <namespace> --force --grace-period=0
```

### **–ü–æ—á–µ–º—É –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º–∞:**
1. **Volume Controller** –ø—ã—Ç–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –¥–∏—Å–∫
2. **CSI Driver** –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
3. **DigitalOcean API** –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º
4. **Network issues** –º–µ–∂–¥—É –∫–ª–∞—Å—Ç–µ—Ä–æ–º –∏ DO

## üìã **–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏**

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—Å—Ç—Ä—è–≤—à–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ PVC —Å finalizers
kubectl get pvc --all-namespaces -o yaml | grep -A5 -B5 finalizers

# –ü—Ä–æ–≤–µ—Ä–∫–∞ PV —Å—Ç–∞—Ç—É—Å–∞
kubectl get pv

# –ü—Ä–æ–≤–µ—Ä–∫–∞ DigitalOcean volumes
doctl compute volume list

# –ü—Ä–æ–≤–µ—Ä–∫–∞ events
kubectl get events --all-namespaces | grep -i volume
```

### **–†—É—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ finalizers:**
```bash
# –î–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ PVC
kubectl patch pvc <pvc-name> -n <namespace> -p '{"metadata":{"finalizers":null}}'

# –î–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ PV
kubectl patch pv <pv-name> -p '{"metadata":{"finalizers":null}}'
```

## ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π**

### **–£–ª—É—á—à–µ–Ω–∏—è cleanup.sh:**
- ‚úÖ –ö–æ—Ä–æ—Ç–∫–∏–µ timeout'—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–µ
- ‚úÖ Force deletion —É—Å–∫–æ—Ä—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ finalizers
- ‚úÖ –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

### **–ù–æ–≤—ã–π force-cleanup.sh:**
- ‚úÖ –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞—Å—Ç—Ä—è–≤—à–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚úÖ –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
- ‚úÖ –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–µ –ø—Ä–∞–≤–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

## üéâ **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**

**–ü—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–≤–∏—Å–∞–Ω–∏–µ–º cleanup.sh —Ä–µ—à–µ–Ω–∞:**

‚úÖ **cleanup.sh —É–ª—É—á—à–µ–Ω** - –∫–æ—Ä–æ—Ç–∫–∏–µ timeout'—ã, force deletion, —É–¥–∞–ª–µ–Ω–∏–µ finalizers  
‚úÖ **force-cleanup.sh —Å–æ–∑–¥–∞–Ω** - —ç–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞–µ–≤  
‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏–π  
‚úÖ **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** - –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º  

**–¢–µ–ø–µ—Ä—å –æ—á–∏—Å—Ç–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ!**

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 16.07.2025  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ Fixed  
**–§–∞–π–ª—ã**: cleanup.sh (—É–ª—É—á—à–µ–Ω), force-cleanup.sh (—Å–æ–∑–¥–∞–Ω)
